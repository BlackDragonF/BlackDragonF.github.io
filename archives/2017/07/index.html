
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="码龙的窝">
    <title>归档: 2017/7 - 码龙的窝</title>
    <meta name="author" content="码龙黑曜">
    
        <meta name="keywords" content="博客,iOS,Computer Science,码龙,">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
<meta name="keywords" content="博客,iOS,Computer Science,码龙">
<meta property="og:type" content="blog">
<meta property="og:title" content="码龙的窝">
<meta property="og:url" content="http://blog.codedragon.tech/archives/2017/07/index.html">
<meta property="og:site_name" content="码龙的窝">
<meta property="og:description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="码龙的窝">
<meta name="twitter:description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
    
    
        
    
    
        <meta property="og:image" content="http://blog.codedragon.tech/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-j4w0tbtf1olriqsnfyv4egntpbdblucqpyraoqqnvawa2vd6l4m8ljtn2yes.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-108458894-1', 'auto');
        ga('send', 'pageview');
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">码龙的窝</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">码龙黑曜</h4>
                
                    <h5 class="sidebar-profile-bio"><p>iOS开发者/计算机科学/兽人控</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="首页"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="分类"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="标签"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="归档"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/projects"
                            
                            title="项目"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-code" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">项目</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about"
                            
                            title="关于"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/BlackDragonF" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://t.me/Cosidian" target="_blank" rel="noopener" title="Telegram">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-telegram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Telegram</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://steamcommunity.com/id/BlackDragonF/" target="_blank" rel="noopener" title="Steam">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-steam" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Steam</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:obsidiandragon2016@gmail.com" target="_blank" rel="noopener" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/links"
                            
                            title="友情链接"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-link" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">友情链接</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/resources"
                            
                            title="学习资源"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-share-alt" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">学习资源</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/07/20/深入理解计算机系统PerformanceLab实验报告/">
                            深入理解计算机系统PerformanceLab实验报告
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-07-20T01:23:51+08:00">
	
		    7月 20, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/计算机系统/">计算机系统</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>实验答案托管在我的<a href="https://github.com/BlackDragonF/CSAPPLabs/tree/master/PerformanceLab" target="_blank" rel="noopener">GitHub</a>上</p>
<blockquote>
<p>由于Cache Lab的Part B的64 × 64的矩阵一直拿不到满分，索性放在了一边，先从老的Performance Lab开始做起。</p>
</blockquote>
<h2 id="实验简介"><a href="#实验简介" class="headerlink" title="实验简介"></a>实验简介</h2><p>Performance Lab - Code Optimization是有关性能优化的实验，对应于书本的第5章：优化程序性能和第6章：存储器层次结构。主要提供了利用书本所学的知识优化代码的机会。</p>
<p>本实验主要分为两个部分，每个部分分别对于一个简单的图像处理函数进行优化。第一个部分所优化的函数旋转(rotate)对于缓存更加敏感，而第二个部分所优化的函数平滑(smooth)则属于计算密集型函数。对它们优化的侧重是有所不同的。</p>
<p>本实验的具体介绍见<a href="http://csapp.cs.cmu.edu/3e/perflab.pdf" target="_blank" rel="noopener">实验讲义</a>。</p>
<h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本实验中，我们将实现两个图像处理函数——旋转和平滑。</p>
<p>我们将一张图片抽象地表示为一个二维矩阵M，M(i, j)代表了M中第i行第j列的像素的值，该像素值被定义为红色、绿色、蓝色（RGB）的值的三元组。在本实验中，我们只考虑正方形的图片。下标遵循C语言风格，从0到N-1。</p>
<p>旋转操作被定义为将图片逆时针旋转90°，旋转可以分为两步实现——</p>
<ol>
<li>将矩阵转置，即将M(i, j)变为M(j, i)</li>
<li>将矩阵的第i行和第N - i - 1交换</li>
</ol>
<p>平滑操作被定义为将每一个像素点的值换位周围像素点（以该像素点为中心的最多3*3的正方形）的平均值。</p>
<h2 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h2><p>在本实验中像素（pixel）是一个定义如下的结构体：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The core data structure deals with image representation. A pixel is a <span class="class"><span class="keyword">struct</span> <span class="title">as</span> <span class="title">shown</span> <span class="title">below</span>:</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> red;    <span class="comment">/* R value */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> green;  <span class="comment">/* G value */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> blue;   <span class="comment">/* B value */</span></span><br><span class="line">&#125; pixel;</span><br></pre></td></tr></table></figure></p>
<p>此外，为了简化起见，还定义了如下的宏：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RIDX(i,j,n) ((i)*(n)+(j))</span></span><br></pre></td></tr></table></figure></p>
<p>旋转操作的朴素版本如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">naive_rotate</span><span class="params">(<span class="keyword">int</span> dim, pixel *src, pixel *dst)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j &lt; dim; j++)</span><br><span class="line">            dst[RIDX(dim<span class="number">-1</span>-j,i,dim)] = src[RIDX(i,j,dim)];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>平滑操作的朴素版本如下（辅助函数未列出）：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">naive_smooth</span><span class="params">(<span class="keyword">int</span> dim, pixel *src, pixel *dst)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j &lt; dim; j++)</span><br><span class="line">            dst[RIDX(i,j,dim)] = avg(dim, i, j, src); <span class="comment">/* Smooth the (i,j)th pixel */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了简化起见，你可以假设所有的矩阵的边长都是32的倍数，并且在进行正确性测试的时候，只会测试5个值。</p>
<p>具体的注册函数和自动跑分机制请参阅实验讲义。</p>
<h2 id="实验思路"><a href="#实验思路" class="headerlink" title="实验思路"></a>实验思路</h2><p>旋转操作：旋转操作不涉及复杂的计算，经过测试将代码移动所带来的性能提升微乎其微。主要应当采用分块的手段提高代码的空间局部性的利用率。</p>
<p>平滑操作（平滑操作参考了别人的思路）：平滑操作是计算密集型函数，经过测试，通过减少过程调用以及代码移动带来的有限的性能提升。<br>观察原始代码可以发现分支预测的惩罚是巨大的（因为循环只会执行3次，会带来大量的预测不命中）。我们可以考虑将红、绿、蓝三色的值的计算分开地并行处理，并且依次处理四个角、四条边、和剩余的像素点。以提升局部性的利用率并且降低分支预测不命中所带来的惩罚。</p>
<h2 id="实验答案"><a href="#实验答案" class="headerlink" title="实验答案"></a>实验答案</h2><p>旋转操作：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">block_rotate</span><span class="params">(<span class="keyword">int</span> dim, pixel * src, pixel * dst)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, k, l;</span><br><span class="line">    <span class="keyword">int</span> cst0 = dim - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; dim ; i += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span> ; j &lt; dim ; j += <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (k = i ; k &lt; i + <span class="number">8</span> ; k++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (l = j ; l &lt; j + <span class="number">8</span> ; l++) &#123;</span><br><span class="line">                    dst[RIDX(cst0 - l, k, dim)] = src[RIDX(k, l, dim)];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>平滑操作：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">optimized_smooth</span><span class="params">(<span class="keyword">int</span> dim, pixel * src, pixel * dst)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">int</span> tmp;</span><br><span class="line"></span><br><span class="line">    dst[<span class="number">0</span>].red = (src[<span class="number">0</span>].red + src[<span class="number">1</span>].red + src[dim].red + src[dim + <span class="number">1</span>].red) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[<span class="number">0</span>].green = (src[<span class="number">0</span>].green + src[<span class="number">1</span>].green + src[dim].green + src[dim + <span class="number">1</span>].green) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[<span class="number">0</span>].blue = (src[<span class="number">0</span>].blue + src[<span class="number">1</span>].blue + src[dim].blue + src[dim + <span class="number">1</span>].blue) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    i = dim - <span class="number">1</span>;</span><br><span class="line">    dst[i].red = (src[i].red + src[i - <span class="number">1</span>].red + src[i + dim].red + src[i + dim <span class="number">-1</span>].red) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].green = (src[i].green + src[i - <span class="number">1</span>].green + src[i + dim].green + src[i + dim <span class="number">-1</span>].green) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].blue = (src[i].blue + src[i - <span class="number">1</span>].blue + src[i + dim].blue + src[i + dim <span class="number">-1</span>].blue) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    i = i * dim;</span><br><span class="line">    dst[i].red = (src[i].red + src[i + <span class="number">1</span>].red + src[i - dim].red + src[i - dim + <span class="number">1</span>].red) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].green = (src[i].green + src[i + <span class="number">1</span>].green + src[i - dim].green + src[i - dim + <span class="number">1</span>].green) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].blue = (src[i].blue + src[i + <span class="number">1</span>].blue + src[i - dim].blue + src[i - dim + <span class="number">1</span>].blue) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    i = i + dim - <span class="number">1</span>;</span><br><span class="line">    dst[i].red = (src[i].red + src[i - <span class="number">1</span>].red + src[i - dim].red + src[i - dim - <span class="number">1</span>].red) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].green = (src[i].green + src[i - <span class="number">1</span>].green + src[i - dim].green + src[i - dim - <span class="number">1</span>].green) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    dst[i].blue = (src[i].blue + src[i - <span class="number">1</span>].blue + src[i - dim].blue + src[i - dim - <span class="number">1</span>].blue) &gt;&gt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span> ; i &lt; dim - <span class="number">1</span> ; i++) &#123;</span><br><span class="line">        dst[i].red = (src[i].red + src[i - <span class="number">1</span>].red + src[i + <span class="number">1</span>].red + src[i + dim].red + src[i + dim - <span class="number">1</span>].red + src[i + dim + <span class="number">1</span>].red) / <span class="number">6</span>;</span><br><span class="line">        dst[i].green = (src[i].green + src[i - <span class="number">1</span>].green + src[i + <span class="number">1</span>].green + src[i + dim].green + src[i + dim - <span class="number">1</span>].green + src[i + dim + <span class="number">1</span>].green) / <span class="number">6</span>;</span><br><span class="line">        dst[i].blue = (src[i].blue + src[i - <span class="number">1</span>].blue + src[i + <span class="number">1</span>].blue + src[i + dim].blue + src[i + dim - <span class="number">1</span>].blue + src[i + dim + <span class="number">1</span>].blue) / <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = dim * (dim - <span class="number">1</span>) + <span class="number">1</span> ; i &lt; dim * dim - <span class="number">1</span> ; i++) &#123;</span><br><span class="line">        dst[i].red = (src[i].red + src[i - <span class="number">1</span>].red + src[i + <span class="number">1</span>].red + src[i - dim].red + src[i - dim - <span class="number">1</span>].red + src[i - dim + <span class="number">1</span>].red) / <span class="number">6</span>;</span><br><span class="line">        dst[i].green = (src[i].green + src[i - <span class="number">1</span>].green + src[i + <span class="number">1</span>].green + src[i - dim].green + src[i - dim - <span class="number">1</span>].green + src[i - dim + <span class="number">1</span>].green) / <span class="number">6</span>;</span><br><span class="line">        dst[i].blue = (src[i].blue + src[i - <span class="number">1</span>].blue + src[i + <span class="number">1</span>].blue+ src[i - dim].blue + src[i - dim - <span class="number">1</span>].blue+ src[i - dim + <span class="number">1</span>].blue) / <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (j = dim ; j &lt; dim * (dim - <span class="number">1</span>) ; j+= dim) &#123;</span><br><span class="line">        dst[j].red = (src[j].red + src[j + <span class="number">1</span>].red + src[j - dim].red + src[j - dim + <span class="number">1</span>].red + src[j + dim].red + src[j + dim + <span class="number">1</span>].red) / <span class="number">6</span>;</span><br><span class="line">        dst[j].green = (src[j].green + src[j + <span class="number">1</span>].green + src[j - dim].green+ src[j - dim + <span class="number">1</span>].green + src[j + dim].green + src[j + dim + <span class="number">1</span>].green) / <span class="number">6</span>;</span><br><span class="line">        dst[j].blue = (src[j].blue + src[j + <span class="number">1</span>].blue + src[j - dim].blue + src[j - dim + <span class="number">1</span>].blue + src[j + dim].blue + src[j + dim + <span class="number">1</span>].blue) / <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">2</span> * dim - <span class="number">1</span> ; j &lt; dim * dim - <span class="number">1</span> ; j += dim) &#123;</span><br><span class="line">        dst[j].red = (src[j].red + src[j - <span class="number">1</span>].red + src[j - dim].red + src[j - dim - <span class="number">1</span>].red + src[j + dim].red + src[j + dim - <span class="number">1</span>].red) / <span class="number">6</span>;</span><br><span class="line">        dst[j].green = (src[j].green + src[j - <span class="number">1</span>].green + src[j - dim].green + src[j - dim - <span class="number">1</span>].green + src[j + dim].green + src[j + dim - <span class="number">1</span>].green) / <span class="number">6</span>;</span><br><span class="line">        dst[j].blue = (src[j].blue + src[j - <span class="number">1</span>].blue + src[j - dim].blue + src[j - dim - <span class="number">1</span>].blue + src[j + dim].blue + src[j + dim - <span class="number">1</span>].blue) / <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span> ; i &lt; dim - <span class="number">1</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span> ; j &lt; dim - <span class="number">1</span> ; j++) &#123;</span><br><span class="line">            tmp = i * dim + j;</span><br><span class="line">            dst[tmp].red = (src[tmp].red + src[tmp - <span class="number">1</span>].red + src[tmp + <span class="number">1</span>].red + src[tmp - dim].red + src[tmp - dim - <span class="number">1</span>].red + src[tmp - dim + <span class="number">1</span>].red + src[tmp + dim].red + src[tmp + dim - <span class="number">1</span>].red + src[tmp + dim + <span class="number">1</span>].red) / <span class="number">9</span>;</span><br><span class="line">            dst[tmp].green = (src[tmp].green + src[tmp - <span class="number">1</span>].green + src[tmp + <span class="number">1</span>].green + src[tmp - dim].green + src[tmp - dim - <span class="number">1</span>].green + src[tmp - dim + <span class="number">1</span>].green + src[tmp + dim].green + src[tmp + dim - <span class="number">1</span>].green + src[tmp + dim + <span class="number">1</span>].green) / <span class="number">9</span>;</span><br><span class="line">            dst[tmp].blue = (src[tmp].blue + src[tmp - <span class="number">1</span>].blue + src[tmp + <span class="number">1</span>].blue + src[tmp - dim].blue + src[tmp - dim - <span class="number">1</span>].blue + src[tmp - dim + <span class="number">1</span>].blue + src[tmp + dim].blue + src[tmp + dim - <span class="number">1</span>].blue + src[tmp + dim + <span class="number">1</span>].blue) / <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h2><p>实验的第一部分对于缓存的要求不是很高，简单的分块可以带来很大的性能提升。</p>
<p>实验的第二部分实际上我是卡了比较久的，在发现减少过程调用和代码移动性能提升有限后我就卡住了，因为我发现似乎无法进行循环展开。实际上还是太生疏了，没有想到要分析性能瓶颈，最后参考了别人的答案，实际上看到了别人答案的一瞬间就豁然开朗了，但是在这之前完全没有想到会是分支预测的问题。还需要多加练习。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/07/20/深入理解计算机系统PerformanceLab实验报告/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/07/08/深入理解计算机系统CacheLab-PartA实验报告/">
                            深入理解计算机系统CacheLab-PartA实验报告
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-07-08T17:55:51+08:00">
	
		    7月 08, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/计算机系统/">计算机系统</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>实验答案托管在我的<a href="https://github.com/BlackDragonF/CSAPPLabs/tree/master/CacheLab" target="_blank" rel="noopener">GitHub</a>上</p>
<blockquote>
<p>考完试之后一直比较颓废，本来想看完《深入理解计算机系统》的第5章——优化程序性能之后就赶快来做实验的，后来发现无论是Cache Lab还是Performance Lab都需要第6章——存储器层次结构的知识。看了几天的书，又磨蹭了几天，终于把Cache Lab的Part A写完了，总结如下。</p>
</blockquote>
<h2 id="实验简介"><a href="#实验简介" class="headerlink" title="实验简介"></a>实验简介</h2><p>Cache Lab - Understanding Cache Memories主要是有关缓存的实验，对应于书本的第6章：存储器层次结构。主要阐明了缓存对于C语言程序的性能影响。</p>
<p>本实验主要分为两个部分。第一个部分要求完成一个C语言程序用来模拟缓存的行为；而第二个部分要求优化一个小的矩阵变换函数，使其具有尽可能小的缓存不命中率。</p>
<p>关于本实验的具体介绍详见<a href="http://csapp.cs.cmu.edu/3e/archlab32-handout.tar" target="_blank" rel="noopener">实验讲义</a>。</p>
<h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>实验讲义中的traces子文件夹下包含了一组reference trace files，用来作为评估Part A中缓存模拟器正确性的样例数据。这些文件是由valgrind生成的。</p>
<p>Valgrind是一个用于内存调试，内存泄露以及性能分析的软件。例如，我们输入如下的命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux&gt; valgrind --<span class="built_in">log</span>-fd=1 --tool=lackey -v --trace-mem=yes ls -l</span><br></pre></td></tr></table></figure><br>valgrind会在命令行中执行ls -l命令并且按照顺序记录该命令的每一次内存访问，并且将其输出到标准输出流中。</p>
<p>下面是一个valgrind的输出样例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I 0400d7d4,8</span><br><span class="line"> M 0421c7f0,4</span><br><span class="line"> L 04f6b868,8</span><br><span class="line"> S 7ff0005c8,8</span><br></pre></td></tr></table></figure></p>
<p>每一行的基本格式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[空格]操作 地址,大小</span><br></pre></td></tr></table></figure><br>操作代表了内存访问的种类，<code>&#39;I&#39;</code>代表的是指令加载，<code>&#39;L&#39;</code>代表的是数据加载，<code>&#39;S&#39;</code>代表的是数据存储，<code>&#39;M&#39;</code>代表的是数据修改（如一条数据加载之后紧跟着数据存储）。在<code>&#39;I&#39;</code>之前永远没有空格，而其他的操作前必定有前置空格。<br>地址代表的是一个64位的16进制内存地址。<br>大小指明了该次内存访问涉及的字节数。</p>
<h2 id="实验要求-Part-A"><a href="#实验要求-Part-A" class="headerlink" title="实验要求 - Part A"></a>实验要求 - Part A</h2><p>在Part A中你需要在csim.c中实现一个LRU驱逐机制的缓存模拟器，该模拟器接收valgrind的trace作为输入，模拟一个缓存在该情况下的命中/不命中情况，并且输出所有的命中，不命中以及驱逐的次数。</p>
<p>本实验已经提供了一个用来参考的缓存模拟器csim-ref，其使用方式以及输出如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;</span><br><span class="line">• -h: Optional <span class="built_in">help</span> flag that prints usage info</span><br><span class="line">• -v: Optional verbose flag that displays trace info</span><br><span class="line">• -s &lt;s&gt;: Number of <span class="built_in">set</span> index bits (S = 2 s is the number of sets)</span><br><span class="line">• -E &lt;E&gt;: Associativity (number of lines per <span class="built_in">set</span>)</span><br><span class="line">• -b &lt;b&gt;: Number of block bits (B = 2 b is the block size)</span><br><span class="line">• -t &lt;tracefile&gt;: Name of the valgrind trace to replay</span><br><span class="line"></span><br><span class="line">linux&gt; ./csim-ref -s 4 -E 1 -b 4 -t traces/yi.trace</span><br><span class="line">hits:4 misses:5 evictions:3</span><br><span class="line"></span><br><span class="line">linux&gt; ./csim-ref -v -s 4 -E 1 -b 4 -t traces/yi.trace</span><br><span class="line">L 10,1 miss</span><br><span class="line">M 20,1 miss hit</span><br><span class="line">L 22,1 hit</span><br><span class="line">S 18,1 hit</span><br><span class="line">L 110,1 miss eviction</span><br><span class="line">L 210,1 miss eviction</span><br><span class="line">M 12,1 miss eviction hit</span><br><span class="line">hits:4 misses:5 evictions:3</span><br></pre></td></tr></table></figure></p>
<p>对于Part A有以下的要求和限制：</p>
<ol>
<li>所写的程序编译时不能有任何的警告</li>
<li>能应对不同s，E和b的缓存生成对应的结果，这要求使用malloc来为你的数据结构分配空间</li>
<li>不需要考虑指令加载的缓存情况</li>
<li>调用printSummary打印最终的结果</li>
<li>假定数据已经适当对齐，不会出现一次数据加载跨区块的情况。这样，你可以忽略trace中的大小</li>
</ol>
<p>除此以外，实验的自学者讲义中还包含了一些提示，这里就不再赘述。</p>
<p>完成了Part A之后，可以用<code>make clean &amp;&amp; make</code>进行编译，并且用<code>./test-csim</code>进行自动评分，总共有8组样例，共27分满分。</p>
<h2 id="实验过程-Part-A"><a href="#实验过程-Part-A" class="headerlink" title="实验过程 - Part A"></a>实验过程 - Part A</h2><h3 id="实验思路"><a href="#实验思路" class="headerlink" title="实验思路"></a>实验思路</h3><p>整个模拟器在思路上可以进行如下的拆分：</p>
<h4 id="1-命令行参数解析"><a href="#1-命令行参数解析" class="headerlink" title="1.命令行参数解析"></a>1.命令行参数解析</h4><p>由于该模拟器是命令行程序并且接受命令行参数，因此需要能对命令行参数进行解析和处理，这里推荐使用getopt进行参数的解析。并且根据不同的参数执行不同的控制流，并且处理一些基本的错误如参数缺失以及参数类型错误。</p>
<h4 id="2-数据结构"><a href="#2-数据结构" class="headerlink" title="2.数据结构"></a>2.数据结构</h4><p>这是整个模拟器最基本的部分。我们需要创建合适的数据结构来模拟缓存，该数据结构不仅要能模拟缓存的数据的实际组织方式（有效位，标志位以及行和块等等），还需要考虑到LRU的驱逐机制。</p>
<h4 id="3-文件中内存访问记录的处理和解析"><a href="#3-文件中内存访问记录的处理和解析" class="headerlink" title="3.文件中内存访问记录的处理和解析"></a>3.文件中内存访问记录的处理和解析</h4><p>这个是模拟器中核心的部分。模拟器的功能就是从文件中接收内存访问记录，并且根据这些记录来模拟缓存的行为，操作我们所设计的缓存的数据结构。</p>
<h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><p>该代码仅供参考，很可能并不是一个非常好的解法。如果你也在面对同样的实验，<strong>请不要抄袭</strong>，毕竟抄袭是不会使你变得更强的:)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include necessary headers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"cachelab.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"getopt.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* cache struct definition */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CSim_Cache_Entry</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> valid_bit;</span><br><span class="line">    <span class="keyword">uint64_t</span> tag_bit;</span><br><span class="line">&#125;CSim_Cache_Entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CSim_Cache_Set</span>&#123;</span></span><br><span class="line">    CSim_Cache_Entry * entries;</span><br><span class="line">&#125;CSim_Cache_Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CSim_Cache</span> &#123;</span></span><br><span class="line">    <span class="comment">/* basic arguments */</span></span><br><span class="line">    <span class="keyword">int</span> block_offset;</span><br><span class="line">    <span class="keyword">int</span> set_number;</span><br><span class="line">    <span class="keyword">int</span> line_number;</span><br><span class="line">    <span class="comment">/* masks and offsets */</span></span><br><span class="line">    <span class="keyword">int</span> tag_offset;</span><br><span class="line">    <span class="keyword">int</span> set_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> tag_mask;</span><br><span class="line">    <span class="keyword">uint64_t</span> set_mask;</span><br><span class="line">    <span class="comment">/* cache */</span></span><br><span class="line">    CSim_Cache_Set * sets;</span><br><span class="line">&#125;CSim_Cache;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* simulation result definition */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CSim_Cache_Result</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> hit;</span><br><span class="line">    <span class="keyword">int</span> miss;</span><br><span class="line">    <span class="keyword">int</span> evict;</span><br><span class="line">&#125;CSim_Cache_Result;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operation type definition */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> CSIM_OPERATION_TYPE &#123;</span><br><span class="line">    CSIM_OPERATION_TYPE_NONE,</span><br><span class="line">    CSIM_OPERATION_TYPE_MODIFY,</span><br><span class="line">    CSIM_OPERATION_TYPE_LOAD,</span><br><span class="line">    CSIM_OPERATION_TYPE_STORE,</span><br><span class="line">&#125;CSIM_OPERATION_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operation result definition */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> CSIM_OPERATION_RESULT &#123;</span><br><span class="line">    CSIM_OPERATION_RESULT_MISS,</span><br><span class="line">    CSIM_OPERATION_RESULT_HIT,</span><br><span class="line">    CSIM_OPERATION_RESULT_MISS_EVICTION,</span><br><span class="line">&#125;CSIM_OPERATION_RESULT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* error definition */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> CSIM_ERROR &#123;</span><br><span class="line">    CSIM_OK = <span class="number">0</span>,</span><br><span class="line">    CSIM_ERROR_INVALID_OPTION,</span><br><span class="line">    CSIM_ERROR_MISSING_ARGUMENT,</span><br><span class="line">    CSIM_ERROR_FILE_CANNOT_OPEN,</span><br><span class="line">    CSIM_ERROR_OUT_OF_MEMORY,</span><br><span class="line">&#125;CSIM_ERROR;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* macro definition for get a value given mask and offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> csim_get_value(number, mask, offset) (((number) &amp; (mask)) &gt;&gt; (offset))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* function list */</span></span><br><span class="line"><span class="comment">/* message print functions */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_print_help_info</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_missing_argument</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_file_cannot_open</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_out_of_memory</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/* cache structure related functions */</span></span><br><span class="line"><span class="function">CSim_Cache * <span class="title">csim_construct_cache</span><span class="params">(<span class="keyword">int</span> set_number, <span class="keyword">int</span> line_number, <span class="keyword">int</span> block_offset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_deconstruct_cache</span><span class="params">(CSim_Cache ** pcache)</span></span>;</span><br><span class="line"><span class="comment">/* cache simulation function */</span></span><br><span class="line"><span class="function">CSim_Cache_Result <span class="title">csim_parse_trace_file</span><span class="params">(CSim_Cache * cache, FILE * file_pointer, <span class="keyword">char</span> verbose_flag)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* global variable */</span></span><br><span class="line"><span class="keyword">char</span> * program_name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_print_help_info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./csim [-hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Options:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -h         Print this help message.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -v         Optional verbose flag.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -s &lt;num&gt;   Number of set index bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -E &lt;num&gt;   Number of lines per set.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -b &lt;num&gt;   Number of block offset bits.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  -t &lt;file&gt;  Trace file.\n\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Examples:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"  linux&gt;  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_missing_argument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: Missing required command line argument\n"</span>, program_name);</span><br><span class="line">    csim_print_help_info();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_file_cannot_open</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: No such file or directory\n"</span>, program_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_error_out_of_memory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: Out of memory\n"</span>, program_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">CSim_Cache * <span class="title">csim_construct_cache</span><span class="params">(<span class="keyword">int</span> set_number, <span class="keyword">int</span> line_number, <span class="keyword">int</span> block_offset)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* memory allocation */</span></span><br><span class="line">    CSim_Cache * cache = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(CSim_Cache));</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        csim_error_out_of_memory();</span><br><span class="line">        <span class="built_in">exit</span>(CSIM_ERROR_OUT_OF_MEMORY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* configure basic arguments */</span></span><br><span class="line">    cache-&gt;set_number = set_number;</span><br><span class="line">    cache-&gt;line_number = line_number;</span><br><span class="line">    cache-&gt;block_offset = block_offset;</span><br><span class="line">    <span class="comment">/* caculate masks and offsets */</span></span><br><span class="line">    cache-&gt;tag_mask = ((<span class="keyword">uint64_t</span>)<span class="number">0xFFFFFFFFFFFFFFFF</span>) &lt;&lt; (block_offset + set_number);</span><br><span class="line">    cache-&gt;tag_offset = block_offset + set_number;</span><br><span class="line">    cache-&gt;set_mask = ((((((<span class="keyword">uint64_t</span>)<span class="number">0xFFFFFFFFFFFFFFFF</span>) &lt;&lt; (<span class="number">64</span> - cache-&gt;tag_offset)) &gt;&gt; (<span class="number">64</span> - cache-&gt;tag_offset)) &gt;&gt; block_offset) &lt;&lt; block_offset);</span><br><span class="line">    cache-&gt;set_offset = block_offset;</span><br><span class="line">    <span class="comment">/* memory allocation for cache */</span></span><br><span class="line">    cache-&gt;sets = <span class="built_in">calloc</span>((<span class="number">1</span> &lt;&lt; set_number), <span class="keyword">sizeof</span>(CSim_Cache_Set));</span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;sets == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        csim_error_out_of_memory();</span><br><span class="line">        <span class="built_in">exit</span>(CSIM_ERROR_OUT_OF_MEMORY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span> ; index &lt; (<span class="number">1</span> &lt;&lt; set_number) ; ++index) &#123;</span><br><span class="line">        (cache-&gt;sets)[index].entries = <span class="built_in">calloc</span>(line_number, <span class="keyword">sizeof</span>(CSim_Cache_Entry));</span><br><span class="line">        <span class="keyword">if</span> ((cache-&gt;sets)[index].entries == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            csim_error_out_of_memory();</span><br><span class="line">            <span class="built_in">exit</span>(CSIM_ERROR_OUT_OF_MEMORY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">csim_deconstruct_cache</span><span class="params">(CSim_Cache ** pcache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* release cache according to construct function */</span></span><br><span class="line">    CSim_Cache * temp = *pcache;</span><br><span class="line">    <span class="keyword">int</span> set_number = temp-&gt;set_number;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span> ; index &lt; set_number ; ++index) &#123;</span><br><span class="line">        <span class="built_in">free</span>((temp-&gt;sets)[index].entries);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(temp-&gt;sets);</span><br><span class="line">    <span class="built_in">free</span>(temp);</span><br><span class="line">    *pcache = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">CSim_Cache_Result <span class="title">csim_parse_trace_file</span><span class="params">(CSim_Cache * cache, FILE * file_pointer, <span class="keyword">char</span> verbose_flag)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* file I/O related */</span></span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">80</span>];</span><br><span class="line">    <span class="keyword">char</span> * line_pointer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* cache type and cache result */</span></span><br><span class="line">    CSIM_OPERATION_TYPE type;</span><br><span class="line">    CSIM_OPERATION_RESULT result;</span><br><span class="line">    <span class="comment">/* address and set index &amp; tag bis from it */</span></span><br><span class="line">    <span class="keyword">int</span> address = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">set</span> = <span class="number">0</span>, tag = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* line number */</span></span><br><span class="line">    <span class="keyword">int</span> line_number = cache-&gt;line_number;</span><br><span class="line">    <span class="comment">/* simulation result */</span></span><br><span class="line">    CSim_Cache_Result summary = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">/* parsing process */</span></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="number">80</span>, file_pointer), feof(file_pointer) == <span class="number">0</span>) &#123;</span><br><span class="line">        line_pointer = line;</span><br><span class="line">        type = CSIM_OPERATION_TYPE_NONE;</span><br><span class="line">        <span class="comment">/* exclude instrction load */</span></span><br><span class="line">        <span class="keyword">if</span> (*line_pointer++ == <span class="string">' '</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span>(*line_pointer++) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'L'</span>:</span><br><span class="line">                    type = CSIM_OPERATION_TYPE_LOAD;</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">putchar</span>(<span class="string">'L'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">                    type = CSIM_OPERATION_TYPE_STORE;</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">putchar</span>(<span class="string">'S'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                    type = CSIM_OPERATION_TYPE_MODIFY;</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">putchar</span>(<span class="string">'M'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    type = CSIM_OPERATION_TYPE_NONE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result = CSIM_OPERATION_RESULT_MISS_EVICTION;</span><br><span class="line">            <span class="built_in">sscanf</span>(line_pointer, <span class="string">"%x"</span>, &amp;address);</span><br><span class="line">            <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                <span class="keyword">while</span> ((*line_pointer) != <span class="string">'\n'</span>) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(*line_pointer++);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* separate set and tag according to mask and offset */</span></span><br><span class="line">            <span class="built_in">set</span> = csim_get_value(address, cache-&gt;set_mask, cache-&gt;set_offset);</span><br><span class="line">            tag = csim_get_value(address, cache-&gt;tag_mask, cache-&gt;tag_offset);</span><br><span class="line">            <span class="comment">/* determine the cache result */</span></span><br><span class="line">            CSim_Cache_Entry * pentry = (cache-&gt;sets)[<span class="built_in">set</span>].entries;</span><br><span class="line">            <span class="keyword">int</span> index;</span><br><span class="line">            CSim_Cache_Entry temp;</span><br><span class="line">            <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; line_number ; ++index) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!pentry[index].valid_bit) &#123;</span><br><span class="line">                    result = CSIM_OPERATION_RESULT_MISS;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pentry[index].tag_bit == tag) &#123;</span><br><span class="line">                    result = CSIM_OPERATION_RESULT_HIT;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* simulate according to the result of cache behavior */</span></span><br><span class="line">            <span class="keyword">switch</span>(result) &#123;</span><br><span class="line">                <span class="keyword">case</span> CSIM_OPERATION_RESULT_MISS:</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">" miss"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    pentry[index].valid_bit = <span class="number">1</span>;</span><br><span class="line">                    pentry[index].tag_bit = tag;</span><br><span class="line">                    summary.miss++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CSIM_OPERATION_RESULT_MISS_EVICTION:</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">" miss eviction"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    pentry[<span class="number">0</span>].tag_bit = tag;</span><br><span class="line">                    temp = pentry[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">for</span> (index = <span class="number">0</span> ; index &lt; line_number - <span class="number">1</span> ; ++index) &#123;</span><br><span class="line">                        pentry[index] = pentry[index + <span class="number">1</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                    pentry[index] = temp;</span><br><span class="line">                    summary.miss++;</span><br><span class="line">                    summary.evict++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CSIM_OPERATION_RESULT_HIT:</span><br><span class="line">                    <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">" hit"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    temp = pentry[index];</span><br><span class="line">                    <span class="keyword">for</span> ( ; (index &lt; line_number - <span class="number">1</span>) &amp;&amp; (pentry[index + <span class="number">1</span>].valid_bit) ; ++index) &#123;</span><br><span class="line">                        pentry[index] = pentry[index + <span class="number">1</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                    pentry[index] = temp;</span><br><span class="line">                    summary.hit++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (type == CSIM_OPERATION_TYPE_MODIFY) &#123;</span><br><span class="line">                <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">" hit"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                summary.hit++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (verbose_flag) &#123;</span><br><span class="line">                <span class="built_in">putchar</span>(<span class="string">'\n'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> summary;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* variables for argument parsing */</span></span><br><span class="line">    <span class="keyword">char</span> h = <span class="number">0</span>, v = <span class="number">0</span>, s = <span class="number">0</span>, E = <span class="number">0</span>, b = <span class="number">0</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> opt;</span><br><span class="line">    <span class="comment">/* cache arguments */</span></span><br><span class="line">    <span class="keyword">int</span> set_number = <span class="number">0</span>, line_number = <span class="number">0</span>, block_offset = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* cache */</span></span><br><span class="line">    CSim_Cache * cache = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* file path */</span></span><br><span class="line">    <span class="keyword">char</span> file_path[<span class="number">80</span>];</span><br><span class="line">    <span class="comment">/* verbose flag */</span></span><br><span class="line">    <span class="keyword">char</span> verbose_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* summary */</span></span><br><span class="line">    CSim_Cache_Result summary = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">/* pre-operation */</span></span><br><span class="line">    program_name = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">/* argument parsing */</span></span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">"hvs:E:b:t:"</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">                h = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>:</span><br><span class="line">                v = <span class="number">1</span>;</span><br><span class="line">                verbose_flag = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                set_number = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (set_number == <span class="number">0</span>) &#123;</span><br><span class="line">                    csim_error_missing_argument();</span><br><span class="line">                    <span class="keyword">return</span> CSIM_ERROR_MISSING_ARGUMENT;</span><br><span class="line">                &#125;</span><br><span class="line">                s = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">                line_number = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (line_number == <span class="number">0</span>) &#123;</span><br><span class="line">                    csim_error_missing_argument();</span><br><span class="line">                    <span class="keyword">return</span> CSIM_ERROR_MISSING_ARGUMENT;</span><br><span class="line">                &#125;</span><br><span class="line">                E = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">                block_offset = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (block_offset == <span class="number">0</span>) &#123;</span><br><span class="line">                    csim_error_missing_argument();</span><br><span class="line">                    <span class="keyword">return</span> CSIM_ERROR_MISSING_ARGUMENT;</span><br><span class="line">                &#125;</span><br><span class="line">                b = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                t = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">strcpy</span>(file_path, optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                csim_print_help_info();</span><br><span class="line">                <span class="keyword">return</span> CSIM_ERROR_INVALID_OPTION;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">1</span>) &#123;</span><br><span class="line">        csim_print_help_info();</span><br><span class="line">        <span class="keyword">return</span> CSIM_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="number">1</span>) &#123;</span><br><span class="line">        verbose_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(s == <span class="number">1</span> &amp;&amp; E == <span class="number">1</span> &amp;&amp; b == <span class="number">1</span> &amp;&amp; t == <span class="number">1</span>)) &#123;</span><br><span class="line">        csim_error_missing_argument();</span><br><span class="line">        <span class="keyword">return</span> CSIM_ERROR_MISSING_ARGUMENT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* file processing */</span></span><br><span class="line">    FILE * file_pointer = fopen(file_path, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_pointer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        csim_error_file_cannot_open(file_path);</span><br><span class="line">        <span class="keyword">return</span> CSIM_ERROR_FILE_CANNOT_OPEN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* cache construction */</span></span><br><span class="line">    cache = csim_construct_cache(set_number, line_number, block_offset);</span><br><span class="line">    <span class="comment">/* trace file parsing */</span></span><br><span class="line">    summary = csim_parse_trace_file(cache, file_pointer, verbose_flag);</span><br><span class="line">    <span class="comment">/* summary */</span></span><br><span class="line">    printSummary(summary.hit, summary.miss, summary.evict);</span><br><span class="line">    <span class="comment">/* post operations */</span></span><br><span class="line">    csim_deconstruct_cache(&amp;cache);</span><br><span class="line">    fclose(file_pointer);</span><br><span class="line">    <span class="keyword">return</span> CSIM_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h2><p>自动评分脚本给出的输出如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">user@blackdragon ~/C/C/cachelab-handout&gt; ./<span class="built_in">test</span>-csim</span><br><span class="line">                        Your simulator     Reference simulator</span><br><span class="line">Points (s,E,b)    Hits  Misses  Evicts    Hits  Misses  Evicts</span><br><span class="line">     3 (1,1,1)       9       8       6       9       8       6  traces/yi2.trace</span><br><span class="line">     3 (4,2,4)       4       5       2       4       5       2  traces/yi.trace</span><br><span class="line">     3 (2,1,4)       2       3       1       2       3       1  traces/dave.trace</span><br><span class="line">     3 (2,1,3)     167      71      67     167      71      67  traces/trans.trace</span><br><span class="line">     3 (2,2,3)     201      37      29     201      37      29  traces/trans.trace</span><br><span class="line">     3 (2,4,3)     212      26      10     212      26      10  traces/trans.trace</span><br><span class="line">     3 (5,1,5)     231       7       0     231       7       0  traces/trans.trace</span><br><span class="line">     6 (5,1,5)  265189   21775   21743  265189   21775   21743  traces/long.trace</span><br><span class="line">    27</span><br><span class="line"></span><br><span class="line">TEST_CSIM_RESULTS=27</span><br></pre></td></tr></table></figure></p>
<h2 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h2><p>由于在寒假的课程设计中已经使用过了命令行参数解析以及复杂的数据结构设计与实验，Part A总体上来说不是很难，我主要的精力花费在代码风格上，希望代码能尽量具有良好的架构以及可读性。</p>
<p>本部分中犯的错误有，直接根据s设置缓存的组数，而实际上的组数是2^s个。循环中由于手误导致出现死循环。没有搞清楚inline static关键字而导致的编译错误等等。存在知识的盲区也存在着粗心导致的错误，以后还需要更加注意。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/07/08/深入理解计算机系统CacheLab-PartA实验报告/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/07/06/Arch下Hexo配置的问题总结/">
                            Arch下Hexo配置的问题总结
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-07-06T20:29:45+08:00">
	
		    7月 06, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/杂谈/">杂谈</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>近期将主力环境从macOS切换至Arch Linux，然后将博客从原环境迁移至现环境，本来以为过程会比较简单，结果却还是踩了几个坑，现在将配置过程中遇到的问题记录并且总结如下。</p>
</blockquote>
<h2 id="在Arch-Linux中安装Git和Node-js"><a href="#在Arch-Linux中安装Git和Node-js" class="headerlink" title="在Arch Linux中安装Git和Node.js"></a>在Arch Linux中安装Git和Node.js</h2><p>根据<a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">Hexo官方文档</a>的说明，安装Hexo需要的依赖为Git和Node.js。<br>Git的安装比较简单，使用Arch Linux的默认包管理器pacman即可安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pacman -S git</span><br></pre></td></tr></table></figure><br>Node.js官方文档推荐使用nvm安装，并且官方文档给出了安装脚本。<br>但是我的电脑使用的是伪fish——参考<a href="https://wiki.archlinux.org/index.php/Fish" target="_blank" rel="noopener">Arch Wiki</a>，我通过的是通过给terminal emulator添加参数的方式进入fish的。<br>因此，我的默认shell仍然是bash。而该安装脚本在检测到我的默认shell之后直接将相关的导出环境变量的命令添加至了.bashrc，导致了进入fish之后由于相关的环境变量丢失无法找到nvm命令的问题。</p>
<ol>
<li>第一种解决方法是采用Node.js的fish版安装脚本，该脚本托管在<a href="https://github.com/Alex7Kom/nvm-fish" target="_blank" rel="noopener">Github</a>上，但是该脚本目前已不再被MAINTAINED，需要自行承担风险。</li>
<li>第二种解决方法是采用<a href="https://github.com/edc/bass" target="_blank" rel="noopener">bass</a>包装原始的nvm。</li>
</ol>
<p>对于第二种解决方法，我们首先使用官方文档的安装脚本安装nvm：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https://raw.github.com/creationix/nvm/master/install.sh | sh</span><br></pre></td></tr></table></figure><br>然后我们按照Github上的教程手动安装bass：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/edc/bass.git</span><br><span class="line">$ cd bass</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure><br>最后我们建立如下的文件并重启终端，即可正常地在fish中使用nvm：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.config/fish/functions/nvm.fish</span><br><span class="line">function nvm</span><br><span class="line">    bass source ~/.nvm/nvm.sh --no-use &apos;;&apos; nvm $argv</span><br><span class="line">end</span><br></pre></td></tr></table></figure><br>使用nvm安装Node.js最新版本的命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nvm install v8.1.3</span><br></pre></td></tr></table></figure><br>最后我们安装hexo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure></p>
<h2 id="hexo-server报EMFILE错误"><a href="#hexo-server报EMFILE错误" class="headerlink" title="hexo server报EMFILE错误"></a>hexo server报EMFILE错误</h2><p>报错内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: EMFILE, too many open files</span><br></pre></td></tr></table></figure><br>Hexo官网的<a href="https://hexo.io/zh-cn/docs/troubleshooting.html" target="_blank" rel="noopener">问题解答</a>中给出了如下描述：<br>虽然 Node.js 有非阻塞 I/O，同步 I/O 的数量仍被系统所限制，在生成大量静态文件的时候，您可能会碰到 EMFILE 错误，您可以尝试提高同步 I/O 的限制数量来解决此问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -n 10000</span><br></pre></td></tr></table></figure><br>但是当我尝试使用ulimit的时候，却报了如下的错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Permission denied when changing resource of type &apos;Maximum number of open file descriptors&apos;</span><br></pre></td></tr></table></figure><br>在这之后进行了如下的尝试：</p>
<ol>
<li>使用sudo无法运行ulimit，后su至root运行，虽然没有报错，但是使用<code>ulimit -n</code>查看发现修改失败。</li>
<li>尝试添加参数-S和-H，没有效果。</li>
<li>最后根据<a href="https://bbs.archlinux.org/viewtopic.php?id=202694" target="_blank" rel="noopener">Arch Forum</a>上的回答，修改了<code>/etc/security/limits.conf</code>文件并重启电脑，问题解决。</li>
</ol>
<h2 id="hexo-server报ENOSPC错误"><a href="#hexo-server报ENOSPC错误" class="headerlink" title="hexo server报ENOSPC错误"></a>hexo server报ENOSPC错误</h2><p>Hexo官网的<a href="https://hexo.io/zh-cn/docs/troubleshooting.html" target="_blank" rel="noopener">问题解答</a>中给出了如下描述：<br>它可以用过运行 <code>$ npm dedupe</code> 来解决，如果不起作用的话，可以尝试在 Linux 终端中运行下列命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf &amp;&amp; sudo sysctl -p</span><br></pre></td></tr></table></figure><br>这将会提高你能监视的文件数量。<br><code>$ npm dedupe</code>没有解决问题，最后使用上述的命令解决了问题。（注意在fish中，<code>&#39;&amp;&amp;&#39;</code>要用<code>&#39;COMMAND; and COMMAND&#39;</code>来替代）</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/07/06/Arch下Hexo配置的问题总结/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 码龙黑曜. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">码龙黑曜</h4>
        
            <div id="about-card-bio"><p>iOS开发者/计算机科学/兽人控</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>华中科技大学 本科在读</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Wuhan, China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-feiabjni254mgbxiozwsjblcsiodjqohurk0dcfkq0aooroewq6bvkdnadrg.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
